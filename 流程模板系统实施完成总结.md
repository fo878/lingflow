# 流程模板系统实施完成总结

## 实施概述

LingFlow 流程模板系统重新设计已全部完成。该系统实现了流程模板的完整生命周期管理，包括设计态、发布态和快照管理，并与 Flowable 工作流引擎深度集成。

---

## 一、数据库层

### 已创建文件
**`backend/src/main/resources/db/migration/V7__create_process_template_tables.sql`**

包含内容：
- **三张核心表**：
  - `process_template_draft` - 设计态流程模板表
  - `process_template_published` - 发布态流程模板表
  - `process_template_snapshot` - 流程模板快照表

- **索引和约束**：
  - 唯一约束确保同一租户下模板Key唯一
  - 唯一约束确保同一模板Key只有一个激活版本
  - 外键约束关联流程分类表
  - 部分索引优化查询性能

- **触发器**：
  - 自动更新 `updated_time` 字段

- **辅助函数**：
  - `get_next_template_version()` - 获取下一个模板版本号
  - `has_active_template()` - 检查是否存在激活的模板
  - `get_next_snapshot_version()` - 获取下一个快照版本号
  - `restore_snapshot_to_draft()` - 从快照恢复到设计态

- **统一视图**：
  - `v_process_template_all` - 包含设计态和发布态的所有模板

---

## 二、后端实体层

### 已创建文件

#### 1. 枚举类
**`ProcessTemplateStatus.java`**
- 定义三种状态：`DRAFT`（设计态）、`ACTIVE`（发布激活态）、`INACTIVE`（停用态）
- 包含状态转换验证方法 `canTransitionTo()`

#### 2. 实体类

**`ProcessTemplateDraft.java`** - 设计态流程模板实体
- 支持设计阶段的所有操作（编辑、删除、创建快照）
- JSONB 格式存储标签和表单配置
- 自动 JSON 序列化/反序列化辅助方法

**`ProcessTemplatePublished.java`** - 发布态流程模板实体
- 包含 Flowable 集成字段（流程定义ID、部署ID、版本号）
- 包含统计字段（流程实例总数、运行中的实例数）
- 状态管理方法（标记停用、标记激活）

**`ProcessTemplateSnapshot.java`** - 流程模板快照实体
- 独立的快照版本号序列
- 静态工厂方法支持从设计态或发布态创建快照
- 包含来源信息（来源模板ID、状态、版本号）

#### 3. 工具类

**`JsonUtil.java`**
- 基于 Jackson ObjectMapper 的 JSON 工具类
- 提供 `toJson()` 和 `fromJson()` 方法
- 支持泛型类型反序列化

---

## 三、数据访问层

### Repository 接口

#### 1. ProcessTemplateDraftRepository
设计态模板数据访问接口，包含：
- 基础 CRUD 操作
- 按分类查询
- 关键词搜索（名称、描述）
- 标签搜索
- 分页查询

#### 2. ProcessTemplatePublishedRepository
发布态模板数据访问接口，包含：
- 基础 CRUD 操作
- 按状态查询（ACTIVE/INACTIVE）
- 按 Flowable 流程定义ID查询
- 版本管理相关查询
- 流程实例计数更新

#### 3. ProcessTemplateSnapshotRepository
快照数据访问接口，包含：
- 基础 CRUD 操作
- 按模板Key查询快照列表
- 按来源模板ID查询
- 获取下一个快照版本号

### MyBatis 映射文件

#### XML 映射器文件
1. **`ProcessTemplateDraftMapper.xml`**
   - ResultMap 定义
   - 所有 CRUD 操作的 SQL 语句
   - 支持多租户条件动态拼接
   - JSONB 字段类型转换

2. **`ProcessTemplatePublishedMapper.xml`**
   - ResultMap 定义
   - 发布态专用查询（按状态、按版本）
   - 统计字段更新操作

3. **`ProcessTemplateSnapshotMapper.xml`**
   - ResultMap 定义
   - 快照版本号管理
   - 按来源查询支持

---

## 四、业务逻辑层

### ProcessTemplateService

**文件：** `backend/src/main/java/com/lingflow/service/ProcessTemplateService.java`

#### 核心业务方法

**设计态管理：**
- `createDraft()` - 创建设计态模板
  - 验证模板Key唯一性
  - 验证分类存在性
  - 验证 BPMN XML 格式

- `updateDraft()` - 更新设计态模板
  - 乐观锁版本控制
  - 支持分类变更

- `getDraft()` - 查询设计态模板
- `deleteDraft()` - 删除设计态模板

**发布态管理：**
- `publishTemplate()` - 发布模板（DRAFT → ACTIVE）
  - 自动生成版本号
  - 调用 Flowable 部署 API
  - 复制到发布态表
  - 删除设计态记录

- `suspendTemplate()` - 停用模板（ACTIVE → INACTIVE）
  - 检查是否有运行中的实例
  - 调用 Flowable suspend API
  - 更新状态和停用时间

- `activateTemplate()` - 激活模板（INACTIVE → ACTIVE）
  - 调用 Flowable activate API
  - 清除停用时间

- `getPublished()` - 查询发布态模板
- `listPublished()` - 查询发布态模板列表（支持分页、过滤）

**快照管理：**
- `createSnapshot()` - 创建快照
  - 支持从设计态或发布态创建
  - 自动生成快照版本号

- `listSnapshots()` - 查询快照列表
- `restoreFromSnapshot()` - 从快照恢复到设计态
  - 生成新的模板Key避免冲突
  - 创建新的设计态记录

- `deleteSnapshot()` - 删除快照

#### 私有辅助方法

- `validateBpmnXml()` - 验证 BPMN XML 格式
  - 使用 Flowable BpmnXMLConverter 解析
  - 验证流程ID和名称

- `toDraftVO()` / `toPublishedVO()` / `toSnapshotVO()` - 实体到 VO 转换

---

## 五、控制器层

### ProcessTemplateController

**文件：** `backend/src/main/java/com/lingflow/controller/ProcessTemplateController.java`

#### API 端点列表

**设计态模板管理：**
```
POST   /api/process/template/draft              - 创建设计态
PUT    /api/process/template/draft/{id}         - 更新设计态
GET    /api/process/template/draft/{id}         - 查询设计态
DELETE /api/process/template/draft/{id}         - 删除设计态
```

**发布态模板管理：**
```
POST   /api/process/template/draft/{id}/publish     - 发布模板
POST   /api/process/template/published/{id}/suspend - 停用模板
POST   /api/process/template/published/{id}/activate - 激活模板
GET    /api/process/template/published/{id}         - 查询发布态
GET    /api/process/template/published              - 查询发布态列表
```

**快照管理：**
```
POST   /api/process/template/snapshot           - 创建快照
GET    /api/process/template/snapshot/{key}     - 查询快照列表
POST   /api/process/template/snapshot/restore   - 从快照恢复
DELETE /api/process/template/snapshot/{id}      - 删除快照
```

#### 特性

- 统一使用 `Result<T>` 包装响应
- 支持请求头 `X-User-Id` 获取当前用户
- 全局异常处理
- 详细的日志记录

---

## 六、数据传输对象（DTO）

### 已创建文件

#### 视图对象（VO）

1. **`ProcessTemplateDraftVO.java`** - 设计态模板视图对象
   - 包含分类名称、编码（查询时关联）

2. **`ProcessTemplatePublishedVO.java`** - 发布态模板视图对象
   - 包含 Flowable 相关字段
   - 包含统计字段

3. **`ProcessTemplateSnapshotVO.java`** - 快照视图对象
   - 包含来源信息
   - 包含快照版本号

#### 请求对象（Request）

4. **`CreateDraftTemplateRequest.java`** - 创建设计态请求
   - 包含 `@Valid` 验证注解
   - 必填字段：templateKey、templateName、bpmnXml、categoryId、tenantId

5. **`UpdateDraftTemplateRequest.java`** - 更新设计态请求
   - 所有字段可选，支持部分更新

6. **`CreateTemplateSnapshotRequest.java`** - 创建快照请求
   - 必填：sourceTemplateId、sourceTemplateType、snapshotName

7. **`RestoreSnapshotRequest.java`** - 恢复快照请求
   - 必填：snapshotId
   - 可选：newTemplateName（自定义新模板名称）

---

## 七、前端集成

### 已更新文件

**`frontend/src/api/process.ts`**

#### 新增 API 方法

**设计态管理：**
```typescript
createDraftTemplate(data)     // 创建设计态
updateDraftTemplate(id, data) // 更新设计态
getDraftTemplate(id)          // 查询设计态
deleteDraftTemplate(id)       // 删除设计态
```

**发布态管理：**
```typescript
publishTemplate(draftId)                    // 发布模板
suspendTemplate(publishedId)                // 停用模板
activateTemplate(publishedId)               // 激活模板
getPublishedTemplate(id)                    // 查询发布态
listPublishedTemplates(params)              // 查询发布态列表
```

**快照管理：**
```typescript
createTemplateSnapshot(data)    // 创建模板快照
listTemplateSnapshots(key, params) // 查询快照列表
restoreFromSnapshot(data)       // 从快照恢复
deleteTemplateSnapshot(id)      // 删除快照
```

#### TypeScript 类型定义

所有方法都包含完整的类型定义，参数类型与后端 API 保持一致。

---

## 八、核心功能特性

### 1. 状态分离

- **设计态（DRAFT）**：流程设计阶段，未部署到 Flowable
  - 可编辑、可删除
  - 可创建快照
  - 不能启动流程实例

- **发布激活态（ACTIVE）**：已部署且激活
  - 不可编辑、不可删除
  - 可启动流程实例
  - 可创建快照
  - 可停用

- **停用态（INACTIVE）**：已部署但暂停
  - 不可编辑、不可删除
  - 不能启动新流程实例
  - 可重新激活
  - 可创建快照

### 2. 版本管理

- 版本号作用域：同一租户、应用、上下文、分类下的相同 `template_key`
- 版本号从 1 开始递增
- 历史版本全部保留在 `process_template_published` 表
- 通过唯一索引保证同一模板Key只有一个激活版本
- 停用后激活不产生新版本
- 从快照恢复后重新发布会生成新版本

### 3. 多租户隔离

- 支持三层隔离：租户（tenant_id）、应用（app_id）、上下文（context_id）
- 所有查询都自动带上租户条件
- 跨租户数据完全隔离

### 4. 分类关联

- 所有流程模板必须关联到流程分类
- 创建时验证分类存在性
- 支持按分类查询和筛选
- 外键约束确保数据完整性

### 5. 快照管理

- 快照版本号独立于模板版本号
- 可以从设计态或发布态创建快照
- 快照恢复总是恢复到设计态
- 恢复后的模板需要重新发布
- 快照本身不会被删除，可以多次恢复

### 6. Flowable 集成

- **发布时**：调用 `repositoryService.createDeployment()` 部署流程
- **停用时**：调用 `repositoryService.suspendProcessDefinitionById()` 暂停流程
- **激活时**：调用 `repositoryService.activateProcessDefinitionById()` 激活流程
- 自动同步 Flowable 流程定义ID和部署ID

---

## 九、技术实现亮点

### 1. 数据库设计

- 使用 JSONB 存储标签和表单配置，支持灵活扩展
- 部分索引优化查询性能
- 唯一约束确保业务规则
- 触发器自动维护审计字段

### 2. 代码规范

- 遵循阿里巴巴 Java 编码规范
- 使用 Lombok 简化代码
- 统一的异常处理
- 详细的 Javadoc 注释

### 3. 业务逻辑

- 乐观锁版本控制防止并发冲突
- BPMN XML 格式验证
- 完善的状态转换验证
- 事务管理确保数据一致性

### 4. 前后端对接

- 统一的响应格式
- 完整的 TypeScript 类型定义
- 清晰的 API 命名规范

---

## 十、文件清单

### 数据库层（1个文件）
```
backend/src/main/resources/db/migration/V7__create_process_template_tables.sql
```

### 后端 Java 代码（19个文件）

**实体类（4个）：**
```
backend/src/main/java/com/lingflow/enums/ProcessTemplateStatus.java
backend/src/main/java/com/lingflow/entity/ProcessTemplateDraft.java
backend/src/main/java/com/lingflow/entity/ProcessTemplatePublished.java
backend/src/main/java/com/lingflow/entity/ProcessTemplateSnapshot.java
```

**Repository 接口（3个）：**
```
backend/src/main/java/com/lingflow/repository/ProcessTemplateDraftRepository.java
backend/src/main/java/com/lingflow/repository/ProcessTemplatePublishedRepository.java
backend/src/main/java/com/lingflow/repository/ProcessTemplateSnapshotRepository.java
```

**MyBatis Mapper XML（3个）：**
```
backend/src/main/resources/mapper/ProcessTemplateDraftMapper.xml
backend/src/main/resources/mapper/ProcessTemplatePublishedMapper.xml
backend/src/main/resources/mapper/ProcessTemplateSnapshotMapper.xml
```

**DTO 类（7个）：**
```
backend/src/main/java/com/lingflow/dto/ProcessTemplateDraftVO.java
backend/src/main/java/com/lingflow/dto/ProcessTemplatePublishedVO.java
backend/src/main/java/com/lingflow/dto/ProcessTemplateSnapshotVO.java
backend/src/main/java/com/lingflow/dto/CreateDraftTemplateRequest.java
backend/src/main/java/com/lingflow/dto/UpdateDraftTemplateRequest.java
backend/src/main/java/com/lingflow/dto/CreateTemplateSnapshotRequest.java
backend/src/main/java/com/lingflow/dto/RestoreSnapshotRequest.java
```

**服务类（1个）：**
```
backend/src/main/java/com/lingflow/service/ProcessTemplateService.java
```

**控制器类（1个）：**
```
backend/src/main/java/com/lingflow/controller/ProcessTemplateController.java
```

**工具类（1个）：**
```
backend/src/main/java/com/lingflow/util/JsonUtil.java
```

### 前端代码（1个文件）
```
frontend/src/api/process.ts
```

### 文档（2个文件）
```
流程模板系统重新设计方案.md
流程模板系统实施完成总结.md
```

**总计：23 个文件**

---

## 十一、后续工作建议

### 1. 测试

- 编写单元测试覆盖核心业务逻辑
- 编写集成测试验证 Flowable 集成
- 测试并发场景下的版本号生成

### 2. 前端页面

- 实现流程模板列表页面
- 实现流程模板设计器页面
- 实现快照管理页面
- 实现版本对比功能

### 3. 权限控制

- 添加操作权限验证
- 支持基于角色的访问控制

### 4. 性能优化

- 添加缓存机制
- 优化大量数据查询性能
- 添加数据库索引

### 5. 监控和日志

- 完善操作日志记录
- 添加性能监控指标
- 实现审计日志

---

## 实施完成时间

2026年1月22日
