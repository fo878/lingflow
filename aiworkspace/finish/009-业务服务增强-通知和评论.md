# æ‰§è¡Œè®°å½•ï¼šä¸šåŠ¡æœåŠ¡å¢å¼º - é€šçŸ¥å’Œè¯„è®º

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°æ¥æ”¶ä»»åŠ¡å¤„ç†å™¨ã€æµç¨‹é€šçŸ¥æœåŠ¡å’Œæµç¨‹è¯„è®ºæœåŠ¡ï¼Œå®Œå–„ä¸šåŠ¡åŠŸèƒ½ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. ä»»åŠ¡æäº¤å¤„ç†å™¨

#### ReceiveTaskHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/ReceiveTaskHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°æ¥æ”¶ä»»åŠ¡çš„æµè½¬
- æ”¯æŒä¿¡å·å’Œæ¶ˆæ¯ä¸¤ç§ç­‰å¾…ç±»å‹
- æä¾›ä¿¡å·å’Œæ¶ˆæ¯æ¥æ”¶å¤„ç†æ–¹æ³•

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ RECEIVE_TASK

**æ”¯æŒçš„ç­‰å¾…ç±»å‹**:
| ç±»å‹ | è¯´æ˜ |
|------|------|
| signal | ç­‰å¾…ä¿¡å·ï¼ˆsignalï¼‰ |
| message | ç­‰å¾…æ¶ˆæ¯ï¼ˆmessageï¼‰ |

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯é…ç½®ã€å‡†å¤‡ç­‰å¾…æ¡ä»¶ã€è®¾ç½®è¶…æ—¶
- **handle**: è®¾ç½®ç­‰å¾…ç±»å‹ã€è®°å½•ç­‰å¾…ä¿¡æ¯ã€å‡†å¤‡å›è°ƒ
- **postHandle**: è®¾ç½®å›è°ƒç›‘å¬ã€è®°å½•ç­‰å¾…å¼€å§‹æ—¶é—´
- **rollback**: å–æ¶ˆç­‰å¾…ã€æ¸…ç†ç­‰å¾…çŠ¶æ€ã€é€šçŸ¥å¤–éƒ¨ç³»ç»Ÿ

**ç‰¹æ®Šæ–¹æ³•**:
- `handleSignalReceived()`: å¤„ç†ä¿¡å·åˆ°è¾¾
- `handleMessageReceived()`: å¤„ç†æ¶ˆæ¯åˆ°è¾¾

### 2. æµç¨‹é€šçŸ¥æœåŠ¡

#### ProcessNotificationService.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/service/ProcessNotificationService.java`

**åŠŸèƒ½**:
- ç®¡ç†æµç¨‹ç›¸å…³çš„é€šçŸ¥å‘é€å’Œè®°å½•
- æ”¯æŒå¤šç§é€šçŸ¥ç±»å‹
- æä¾›é€šçŸ¥æŸ¥è¯¢å’Œå·²è¯»æ ‡è®°åŠŸèƒ½

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ |
|------|------|
| sendTaskAssignedNotification | å‘é€ä»»åŠ¡åˆ†é…é€šçŸ¥ |
| sendTaskCompletedNotification | å‘é€ä»»åŠ¡å®Œæˆé€šçŸ¥ |
| sendProcessTimeoutNotification | å‘é€æµç¨‹è¶…æ—¶é€šçŸ¥ |
| sendProcessRejectedNotification | å‘é€æµç¨‹æ‹’ç»é€šçŸ¥ |
| sendProcessApprovedNotification | å‘é€æµç¨‹é€šè¿‡é€šçŸ¥ |
| sendProcessWithdrawnNotification | å‘é€æµç¨‹æ’¤å›é€šçŸ¥ |
| sendTaskDelegatedNotification | å‘é€ä»»åŠ¡è½¬åŠé€šçŸ¥ |
| sendCustomNotification | å‘é€è‡ªå®šä¹‰é€šçŸ¥ |
| getUserNotifications | è·å–ç”¨æˆ·çš„é€šçŸ¥åˆ—è¡¨ |
| getUnreadNotificationCount | è·å–æœªè¯»é€šçŸ¥æ•°é‡ |
| markNotificationAsRead | æ ‡è®°é€šçŸ¥ä¸ºå·²è¯» |
| markAllNotificationsAsRead | æ‰¹é‡æ ‡è®°ä¸ºå·²è¯» |

**æ”¯æŒçš„é€šçŸ¥ç±»å‹**:
| ç±»å‹ | è¯´æ˜ | è§¦å‘æ—¶æœº |
|------|------|---------|
| TASK_ASSIGNED | ä»»åŠ¡åˆ†é… | ä»»åŠ¡åˆ†é…ç»™ç”¨æˆ·æ—¶ |
| TASK_COMPLETED | ä»»åŠ¡å®Œæˆ | å‰ç½®ä»»åŠ¡å®Œæˆå |
| TASK_DELEGATED | ä»»åŠ¡è½¬åŠ | ä»»åŠ¡è½¬åŠç»™å…¶ä»–ç”¨æˆ· |
| PROCESS_TIMEOUT | æµç¨‹è¶…æ—¶ | æµç¨‹æˆ–ä»»åŠ¡è¶…æ—¶æ—¶ |
| PROCESS_APPROVED | æµç¨‹é€šè¿‡ | æµç¨‹å®¡æ‰¹é€šè¿‡æ—¶ |
| PROCESS_REJECTED | æµç¨‹æ‹’ç» | æµç¨‹è¢«æ‹’ç»æ—¶ |
| PROCESS_WITHDRAWN | æµç¨‹æ’¤å› | æµç¨‹è¢«æ’¤å›æ—¶ |
| CUSTOM | è‡ªå®šä¹‰ | ç”¨æˆ·è‡ªå®šä¹‰é€šçŸ¥ |

### 3. æµç¨‹è¯„è®ºæœåŠ¡

#### ProcessCommentService.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/service/ProcessCommentService.java`

**åŠŸèƒ½**:
- ç®¡ç†æµç¨‹å®ä¾‹å’Œä»»åŠ¡çš„è¯„è®º
- æ”¯æŒæµç¨‹çº§å’Œä»»åŠ¡çº§è¯„è®º
- æä¾›è¯„è®ºçš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ |
|------|------|
| addProcessComment | æ·»åŠ æµç¨‹å®ä¾‹è¯„è®º |
| addTaskComment | æ·»åŠ ä»»åŠ¡è¯„è®º |
| addSystemComment | æ·»åŠ ç³»ç»Ÿè¯„è®º |
| getProcessComments | è·å–æµç¨‹å®ä¾‹çš„è¯„è®º |
| getTaskComments | è·å–ä»»åŠ¡çš„è¯„è®º |
| getAllCommentsForProcess | è·å–æµç¨‹çš„æ‰€æœ‰è¯„è®ºï¼ˆåŒ…æ‹¬ä»»åŠ¡è¯„è®ºï¼‰ |
| deleteComment | åˆ é™¤è¯„è®º |
| updateComment | æ›´æ–°è¯„è®º |
| getCommentStatistics | è·å–è¯„è®ºç»Ÿè®¡ |

**è¯„è®ºç±»å‹**:
| ç±»å‹ | è¯´æ˜ | ä½œç”¨åŸŸ |
|------|------|--------|
| PROCESS | æµç¨‹è¯„è®º | æ•´ä¸ªæµç¨‹å®ä¾‹ |
| TASK | ä»»åŠ¡è¯„è®º | ç‰¹å®šä»»åŠ¡ |
| SYSTEM | ç³»ç»Ÿè¯„è®º | ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ |

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. æ¥æ”¶ä»»åŠ¡ä½¿ç”¨

**BPMNé…ç½®**:
```xml
<receiveTask id="waitForSignal" name="ç­‰å¾…ä¿¡å·">
  <extensionElements>
    <flowable:executionListener event="start"
        class="com.lingflow.listener.ReceiveTaskListener"/>
  </extensionElements>
</receiveTask>

<receiveTask id="waitForMessage" name="ç­‰å¾…æ¶ˆæ¯">
  <messageEventDefinition messageRef="messageName"/>
</receiveTask>
```

**è§¦å‘ä¿¡å·**:
```java
// ä½¿ç”¨ RuntimeService è§¦å‘ä¿¡å·
runtimeService.signalEventReceived(signalName, processInstanceId);
```

**å‘é€æ¶ˆæ¯**:
```java
// ä½¿ç”¨ RuntimeService å‘é€æ¶ˆæ¯
runtimeService.messageEventReceived(messageName, processInstanceId);
```

### 2. æµç¨‹é€šçŸ¥ä½¿ç”¨

```java
@Autowired
private ProcessNotificationService notificationService;

// ä»»åŠ¡åˆ†é…é€šçŸ¥
notificationService.sendTaskAssignedNotification(taskId, assignee, taskName);

// æµç¨‹è¶…æ—¶é€šçŸ¥
notificationService.sendProcessTimeoutNotification(
    processInstanceId, assignee, taskName, 24L);

// æµç¨‹é€šè¿‡é€šçŸ¥
notificationService.sendProcessApprovedNotification(
    processInstanceId, initiator, processName);

// è‡ªå®šä¹‰é€šçŸ¥
List<String> recipients = Arrays.asList("user1", "user2");
notificationService.sendCustomNotification(
    recipients, "é‡è¦æé†’", "è¯·æ³¨æ„æŸ¥æ”¶æµç¨‹", processInstanceId);

// è·å–ç”¨æˆ·é€šçŸ¥
List<NotificationRecord> notifications =
    notificationService.getUserNotifications(userId, 20);

// è·å–æœªè¯»æ•°é‡
long unreadCount = notificationService.getUnreadNotificationCount(userId);

// æ ‡è®°ä¸ºå·²è¯»
notificationService.markNotificationAsRead(userId, notificationId);
```

### 3. æµç¨‹è¯„è®ºä½¿ç”¨

```java
@Autowired
private ProcessCommentService commentService;

// æ·»åŠ æµç¨‹è¯„è®º
String commentId = commentService.addProcessComment(
    processInstanceId, userId, "è¯·å°½å¿«å¤„ç†");

// æ·»åŠ ä»»åŠ¡è¯„è®º
commentService.addTaskComment(taskId, userId, "å·²å®¡æ ¸é€šè¿‡");

// æ·»åŠ ç³»ç»Ÿè¯„è®º
commentService.addSystemComment(
    processInstanceId, "æµç¨‹å·²å®Œæˆ");

// è·å–æ‰€æœ‰è¯„è®º
List<Comment> comments = commentService.getAllCommentsForProcess(processInstanceId);

// è·å–è¯„è®ºç»Ÿè®¡
CommentStatistics stats = commentService.getCommentStatistics(processInstanceId);
System.out.println("æ€»è¯„è®ºæ•°: " + stats.getTotalCommentCount());
System.out.println("å‚ä¸ç”¨æˆ·æ•°: " + stats.getParticipantCount());

// æ›´æ–°è¯„è®º
commentService.updateComment(commentId, userId, "ä¿®æ”¹åçš„å†…å®¹");

// åˆ é™¤è¯„è®º
commentService.deleteComment(commentId, userId);
```

---

## å®Œæ•´çš„æµè½¬æ”¯æŒçŸ©é˜µï¼ˆæœ€ç»ˆç‰ˆï¼‰

| å½“å‰èŠ‚ç‚¹ | ä¸‹ä¸€èŠ‚ç‚¹ | å¤„ç†å™¨ | çŠ¶æ€ |
|---------|---------|--------|------|
| USER_TASK | USER_TASK | UserTaskToUserTaskHandler | âœ… |
| USER_TASK | EXCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | PARALLEL_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | INCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | MULTI_INSTANCE | MultiInstanceHandler | âœ… |
| USER_TASK | CALL_ACTIVITY | SubProcessHandler | âœ… |
| USER_TASK | SERVICE_TASK | ServiceTaskHandler | âœ… |
| USER_TASK | SCRIPT_TASK | ScriptTaskHandler | âœ… |
| USER_TASK | RECEIVE_TASK | ReceiveTaskHandler | âœ… |

---

## åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
backend/src/main/java/com/lingflow/
â”œâ”€â”€ extension/
â”‚   â””â”€â”€ handler/
â”‚       â””â”€â”€ impl/
â”‚           â””â”€â”€ ReceiveTaskHandler.java        # æ¥æ”¶ä»»åŠ¡å¤„ç†å™¨
â””â”€â”€ service/
    â”œâ”€â”€ ProcessNotificationService.java        # æµç¨‹é€šçŸ¥æœåŠ¡
    â””â”€â”€ ProcessCommentService.java             # æµç¨‹è¯„è®ºæœåŠ¡
```

---

## æ‰©å±•æ¡†æ¶å®Œæ•´ç»Ÿè®¡ï¼ˆæœ€ç»ˆç‰ˆï¼‰

**æ€»è®¡åˆ›å»ºJavaæ–‡ä»¶**: 33 ä¸ª

### åˆ†ç±»ç»Ÿè®¡
- APIåŒ…è£…å™¨: 5 ä¸ª
- æµç¨‹äº‹ä»¶: 9 ä¸ª
- ä»»åŠ¡æäº¤å¤„ç†å™¨: 11 ä¸ª
- æ‰©å±•æœåŠ¡: 5 ä¸ª
- ä¸šåŠ¡æœåŠ¡: 6 ä¸ª

### åŠŸèƒ½è¦†ç›–
- æµç¨‹äº‹ä»¶ç›‘å¬: 5 ç§
- èŠ‚ç‚¹æµè½¬å¤„ç†: 9 ç§ï¼ˆæ‰€æœ‰ä¸»è¦æµè½¬ç±»å‹ï¼‰
- APIæƒé™æ§åˆ¶: ç»†ç²’åº¦
- æµç¨‹å˜é‡ç®¡ç†: å®Œæ•´API
- æµç¨‹ç›‘æ§: å®æ—¶ç›‘æ§
- æµç¨‹ç»Ÿè®¡: å¤šç»´ç»Ÿè®¡
- æµç¨‹é€šçŸ¥: 8ç§ç±»å‹
- æµç¨‹è¯„è®º: 3ç§ç±»å‹

---

## æ€»ç»“

âœ… æ¥æ”¶ä»»åŠ¡å¤„ç†å™¨å·²å®ç°ï¼ˆæ”¯æŒä¿¡å·å’Œæ¶ˆæ¯ç­‰å¾…ï¼‰
âœ… æµç¨‹é€šçŸ¥æœåŠ¡å·²å®ç°ï¼ˆæ”¯æŒ8ç§é€šçŸ¥ç±»å‹ï¼‰
âœ… æµç¨‹è¯„è®ºæœåŠ¡å·²å®ç°ï¼ˆæ”¯æŒæµç¨‹çº§å’Œä»»åŠ¡çº§è¯„è®ºï¼‰
âœ… æ‰©å±•æ¡†æ¶åŠŸèƒ½å®Œæ•´ï¼Œè¦†ç›–ä¸»è¦ä¸šåŠ¡åœºæ™¯

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯æ‰€æœ‰åŠŸèƒ½
2. é›†æˆå®é™…æ¶ˆæ¯æœåŠ¡ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
3. ä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–é€šçŸ¥å’Œè¯„è®ºæ•°æ®
4. æ·»åŠ WebSocketå®æ—¶æ¨é€é€šçŸ¥
5. æ·»åŠ è¯„è®º@ç”¨æˆ·åŠŸèƒ½
6. ç»§ç»­æ‰§è¡Œå…¶ä»–æ¨¡å—å¼€å‘

ğŸ‰ **æ‰©å±•æ¡†æ¶æ ¸å¿ƒå¼€å‘å·²å®Œæˆï¼**
- æ‰€æœ‰ä¸»è¦èŠ‚ç‚¹ç±»å‹çš„å¤„ç†å™¨å·²å®ç°
- å®Œæ•´çš„æµç¨‹ç®¡ç†æœåŠ¡å·²æ„å»º
- ç›‘æ§ã€ç»Ÿè®¡ã€é€šçŸ¥ã€è¯„è®ºç­‰ä¸šåŠ¡åŠŸèƒ½å·²å®Œå–„
