# æ‰§è¡Œè®°å½•ï¼šä¸šåŠ¡æœåŠ¡æ‰©å±• - ç›‘æ§å’Œç»Ÿè®¡

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°è„šæœ¬ä»»åŠ¡å¤„ç†å™¨ã€æµç¨‹ç›‘æ§æœåŠ¡å’Œæµç¨‹ç»Ÿè®¡æœåŠ¡ï¼Œå®Œå–„ä¸šåŠ¡åŠŸèƒ½ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. ä»»åŠ¡æäº¤å¤„ç†å™¨

#### ScriptTaskHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/ScriptTaskHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°è„šæœ¬ä»»åŠ¡çš„æµè½¬
- æ”¯æŒå¤šç§è„šæœ¬è¯­è¨€

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ SCRIPT_TASK

**æ”¯æŒçš„è„šæœ¬è¯­è¨€**:
| è¯­è¨€ | è¯´æ˜ |
|------|------|
| javascript / js | JavaScriptè„šæœ¬ï¼ˆNashorn/GraalVMï¼‰ |
| groovy | Groovyè„šæœ¬ |
| python / jython | Pythonè„šæœ¬ï¼ˆéœ€è¦Jythonï¼‰ |
| ruby / jruby | Rubyè„šæœ¬ï¼ˆéœ€è¦JRubyï¼‰ |

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯è„šæœ¬é…ç½®ã€å‡†å¤‡æ‰§è¡Œç¯å¢ƒã€æ£€æŸ¥å®‰å…¨
- **handle**: æ ¹æ®è„šæœ¬è¯­è¨€æ‰§è¡Œä¸åŒå¤„ç†
- **postHandle**: æ£€æŸ¥æ‰§è¡Œç»“æœã€å¤„ç†è¿”å›å€¼ã€è®°å½•æ—¥å¿—
- **rollback**: æ¢å¤å˜é‡ã€æ¸…ç†æ‰§è¡ŒçŠ¶æ€

### 2. æµç¨‹ç›‘æ§æœåŠ¡

#### ProcessMonitorService.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/service/ProcessMonitorService.java`

**åŠŸèƒ½**:
- æä¾›æµç¨‹å®ä¾‹å®æ—¶ç›‘æ§ä¿¡æ¯
- ç›‘æ§æµç¨‹å®šä¹‰è¿è¡ŒçŠ¶æ€
- æ£€æµ‹è¶…æ—¶æµç¨‹å®ä¾‹

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ | è¿”å›ç±»å‹ |
|------|------|---------|
| getProcessInstanceMonitor | è·å–æµç¨‹å®ä¾‹ç›‘æ§ä¿¡æ¯ | ProcessInstanceMonitor |
| getProcessDefinitionMonitor | è·å–æµç¨‹å®šä¹‰ç›‘æ§ä¿¡æ¯ | ProcessDefinitionMonitor |
| getAllRunningInstancesMonitor | è·å–æ‰€æœ‰è¿è¡Œä¸­å®ä¾‹ç›‘æ§ | List<ProcessInstanceMonitor> |
| isProcessInstanceTimeout | æ£€æŸ¥æµç¨‹å®ä¾‹æ˜¯å¦è¶…æ—¶ | boolean |
| getTimeoutProcessInstances | è·å–è¶…æ—¶æµç¨‹å®ä¾‹åˆ—è¡¨ | List<String> |

**ProcessInstanceMonitor åŒ…å«ä¿¡æ¯**:
- åŸºæœ¬ä¿¡æ¯ï¼šæµç¨‹å®ä¾‹IDã€æµç¨‹å®šä¹‰IDã€ä¸šåŠ¡Key
- æ—¶é—´ä¿¡æ¯ï¼šå¯åŠ¨æ—¶é—´ã€è¿è¡Œæ—¶é•¿
- æ´»åŠ¨èŠ‚ç‚¹ï¼šæ´»åŠ¨èŠ‚ç‚¹IDåˆ—è¡¨ã€æ´»åŠ¨èŠ‚ç‚¹æ•°é‡
- ä»»åŠ¡ä¿¡æ¯ï¼šå½“å‰å¾…åŠä»»åŠ¡åˆ—è¡¨ã€ä»»åŠ¡æ•°é‡ã€åŠç†äººåˆ—è¡¨
- è¶…æ—¶ä¿¡æ¯ï¼šè¶…æ—¶ä»»åŠ¡æ•°é‡
- è¿›åº¦ä¿¡æ¯ï¼šæµç¨‹å®Œæˆè¿›åº¦ç™¾åˆ†æ¯”
- çŠ¶æ€ä¿¡æ¯ï¼šè¿è¡ŒçŠ¶æ€ï¼ˆRUNNINGã€SUSPENDEDã€ERRORï¼‰

**ProcessDefinitionMonitor åŒ…å«ä¿¡æ¯**:
- åŸºæœ¬ä¿¡æ¯ï¼šæµç¨‹å®šä¹‰Key
- å®ä¾‹ç»Ÿè®¡ï¼šè¿è¡Œä¸­å®ä¾‹æ•°ã€å·²å®Œæˆå®ä¾‹æ•°ã€æ€»å®ä¾‹æ•°
- ä»»åŠ¡ç»Ÿè®¡ï¼šå½“å‰å¾…åŠä»»åŠ¡æ•°
- æ€§èƒ½ç»Ÿè®¡ï¼šå¹³å‡å®Œæˆæ—¶é—´
- å®Œæˆç‡ï¼šæµç¨‹å®Œæˆç‡ç™¾åˆ†æ¯”

### 3. æµç¨‹ç»Ÿè®¡æœåŠ¡

#### ProcessStatisticsService.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/service/ProcessStatisticsService.java`

**åŠŸèƒ½**:
- æä¾›æµç¨‹å®ä¾‹ã€ä»»åŠ¡ã€æµç¨‹å®šä¹‰çš„ç»Ÿè®¡æ•°æ®
- æ”¯æŒæ¯æ—¥ç»Ÿè®¡åˆ†æ

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ | è¿”å›ç±»å‹ |
|------|------|---------|
| getProcessInstanceStatistics | è·å–æµç¨‹å®ä¾‹ç»Ÿè®¡ | ProcessInstanceStatistics |
| getTaskStatistics | è·å–ä»»åŠ¡ç»Ÿè®¡ | TaskStatistics |
| getProcessDefinitionStatistics | è·å–æµç¨‹å®šä¹‰ç»Ÿè®¡åˆ—è¡¨ | List<ProcessDefinitionStatistics> |
| getDailyStatistics | è·å–æ¯æ—¥ç»Ÿè®¡ | Map<String, DailyStatistics> |

**ProcessInstanceStatistics åŒ…å«ä¿¡æ¯**:
- æ€»æ•°ç»Ÿè®¡ï¼šæ€»å®ä¾‹æ•°ã€è¿è¡Œä¸­æ•°ã€å·²å®Œæˆæ•°
- æ—¶é—´ç»Ÿè®¡ï¼šå¹³å‡å®Œæˆæ—¶é—´ã€æœ€çŸ­å®Œæˆæ—¶é—´ã€æœ€é•¿å®Œæˆæ—¶é—´
- å®Œæˆç‡ï¼šæµç¨‹å®Œæˆç‡ç™¾åˆ†æ¯”

**TaskStatistics åŒ…å«ä¿¡æ¯**:
- æ€»æ•°ç»Ÿè®¡ï¼šæ€»ä»»åŠ¡æ•°ã€å¾…åŠä»»åŠ¡æ•°ã€å·²å®Œæˆä»»åŠ¡æ•°
- æ—¶é—´ç»Ÿè®¡ï¼šå¹³å‡å¤„ç†æ—¶é—´
- å®Œæˆç‡ï¼šä»»åŠ¡å®Œæˆç‡ç™¾åˆ†æ¯”
- çŠ¶æ€åˆ†å¸ƒï¼šå„çŠ¶æ€ä»»åŠ¡æ•°é‡

**ProcessDefinitionStatistics åŒ…å«ä¿¡æ¯**:
- åŸºæœ¬ä¿¡æ¯ï¼šæµç¨‹å®šä¹‰Keyã€åç§°ã€ç‰ˆæœ¬
- å®ä¾‹ç»Ÿè®¡ï¼šè¿è¡Œä¸­å®ä¾‹æ•°ã€å·²å®Œæˆå®ä¾‹æ•°ã€æ€»å®ä¾‹æ•°
- æ€§èƒ½ç»Ÿè®¡ï¼šå¹³å‡å®Œæˆæ—¶é—´
- å®Œæˆç‡ï¼šæµç¨‹å®Œæˆç‡ç™¾åˆ†æ¯”

**DailyStatistics åŒ…å«ä¿¡æ¯**:
- æ—¥æœŸï¼šç»Ÿè®¡æ—¥æœŸ
- å¯åŠ¨æ•°ï¼šå½“æ—¥å¯åŠ¨çš„æµç¨‹æ•°
- å®Œæˆæ•°ï¼šå½“æ—¥å®Œæˆçš„æµç¨‹æ•°

---

## å®Œæ•´çš„æµè½¬æ”¯æŒçŸ©é˜µï¼ˆæ›´æ–°ï¼‰

| å½“å‰èŠ‚ç‚¹ | ä¸‹ä¸€èŠ‚ç‚¹ | å¤„ç†å™¨ | çŠ¶æ€ |
|---------|---------|--------|------|
| USER_TASK | USER_TASK | UserTaskToUserTaskHandler | âœ… |
| USER_TASK | EXCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | PARALLEL_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | INCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | MULTI_INSTANCE | MultiInstanceHandler | âœ… |
| USER_TASK | CALL_ACTIVITY | SubProcessHandler | âœ… |
| USER_TASK | SERVICE_TASK | ServiceTaskHandler | âœ… |
| USER_TASK | SCRIPT_TASK | ScriptTaskHandler | âœ… |
| USER_TASK | RECEIVE_TASK | å¾…å®ç° | â³ |

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. æµç¨‹ç›‘æ§

```java
@Autowired
private ProcessMonitorService monitorService;

// è·å–æµç¨‹å®ä¾‹ç›‘æ§ä¿¡æ¯
ProcessInstanceMonitor monitor = monitorService.getProcessInstanceMonitor(processInstanceId);
System.out.println("è¿è¡Œæ—¶é•¿: " + monitor.getRunningDuration() + " æ¯«ç§’");
System.out.println("å½“å‰æ´»åŠ¨èŠ‚ç‚¹: " + monitor.getActiveActivityIds());
System.out.println("å½“å‰ä»»åŠ¡æ•°: " + monitor.getCurrentTaskCount());
System.out.println("æµç¨‹è¿›åº¦: " + monitor.getProgress() + "%");

// è·å–æµç¨‹å®šä¹‰ç›‘æ§ä¿¡æ¯
ProcessDefinitionMonitor defMonitor = monitorService.getProcessDefinitionMonitor("leaveProcess");
System.out.println("è¿è¡Œä¸­å®ä¾‹æ•°: " + defMonitor.getRunningInstanceCount());
System.out.println("å·²å®Œæˆå®ä¾‹æ•°: " + defMonitor.getCompletedInstanceCount());
System.out.println("å¹³å‡å®Œæˆæ—¶é—´: " + defMonitor.getAvgCompletionTime() + " æ¯«ç§’");

// æ£€æŸ¥è¶…æ—¶å®ä¾‹
boolean timeout = monitorService.isProcessInstanceTimeout(processInstanceId, 60);
if (timeout) {
    System.out.println("æµç¨‹å®ä¾‹å·²è¶…æ—¶");
}

List<String> timeoutInstances = monitorService.getTimeoutProcessInstances(60);
System.out.println("è¶…æ—¶å®ä¾‹æ•°: " + timeoutInstances.size());
```

### 2. æµç¨‹ç»Ÿè®¡

```java
@Autowired
private ProcessStatisticsService statisticsService;

// è·å–æµç¨‹å®ä¾‹ç»Ÿè®¡
ProcessInstanceStatistics instanceStats = statisticsService.getProcessInstanceStatistics();
System.out.println("æ€»å®ä¾‹æ•°: " + instanceStats.getTotalCount());
System.out.println("è¿è¡Œä¸­: " + instanceStats.getRunningCount());
System.out.println("å·²å®Œæˆ: " + instanceStats.getCompletedCount());
System.out.println("å¹³å‡å®Œæˆæ—¶é—´: " + instanceStats.getAvgCompletionTime() + " æ¯«ç§’");
System.out.println("å®Œæˆç‡: " + instanceStats.getCompletionRate() + "%");

// è·å–ä»»åŠ¡ç»Ÿè®¡
TaskStatistics taskStats = statisticsService.getTaskStatistics();
System.out.println("å¾…åŠä»»åŠ¡: " + taskStats.getPendingCount());
System.out.println("å·²å®Œæˆä»»åŠ¡: " + taskStats.getCompletedCount());
System.out.println("ä»»åŠ¡å®Œæˆç‡: " + taskStats.getCompletionRate() + "%");

// è·å–æµç¨‹å®šä¹‰ç»Ÿè®¡
List<ProcessDefinitionStatistics> defStats = statisticsService.getProcessDefinitionStatistics();
for (ProcessDefinitionStatistics stats : defStats) {
    System.out.println("æµç¨‹: " + stats.getProcessDefinitionName());
    System.out.println("  è¿è¡Œä¸­: " + stats.getRunningInstanceCount());
    System.out.println("  å·²å®Œæˆ: " + stats.getCompletedInstanceCount());
    System.out.println("  å®Œæˆç‡: " + stats.getCompletionRate() + "%");
}

// è·å–æ¯æ—¥ç»Ÿè®¡
Map<String, DailyStatistics> dailyStats = statisticsService.getDailyStatistics(7);
for (Map.Entry<String, DailyStatistics> entry : dailyStats.entrySet()) {
    System.out.println(entry.getKey() + ": å¯åŠ¨=" + entry.getValue().getStartedCount() +
                      ", å®Œæˆ=" + entry.getValue().getCompletedCount());
}
```

### 3. è„šæœ¬ä»»åŠ¡ä½¿ç”¨

åœ¨BPMNä¸­é…ç½®è„šæœ¬ä»»åŠ¡ï¼š

```xml
<scriptTask id="scriptTask" name="JavaScriptè„šæœ¬" scriptFormat="javascript">
    <script>
        // è®¿é—®æµç¨‹å˜é‡
        var input = execution.getVariable("input");

        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        var result = input * 2;

        // è®¾ç½®æµç¨‹å˜é‡
        execution.setVariable("output", result);
    </script>
</scriptTask>

<scriptTask id="groovyTask" name="Groovyè„šæœ¬" scriptFormat="groovy">
    <script>
        // Groovyè„šæœ¬
        def input = execution.getVariable("input")
        def result = input * 3
        execution.setVariable("output", result)
    </script>
</scriptTask>
```

---

## åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
backend/src/main/java/com/lingflow/
â”œâ”€â”€ extension/
â”‚   â””â”€â”€ handler/
â”‚       â””â”€â”€ impl/
â”‚           â””â”€â”€ ScriptTaskHandler.java         # è„šæœ¬ä»»åŠ¡å¤„ç†å™¨
â””â”€â”€ service/
    â”œâ”€â”€ ProcessMonitorService.java             # æµç¨‹ç›‘æ§æœåŠ¡
    â””â”€â”€ ProcessStatisticsService.java          # æµç¨‹ç»Ÿè®¡æœåŠ¡
```

---

## æ‰©å±•æ¡†æ¶å®Œæ•´ç»Ÿè®¡

**æ€»è®¡åˆ›å»ºJavaæ–‡ä»¶**: 30 ä¸ª

### åˆ†ç±»ç»Ÿè®¡
- APIåŒ…è£…å™¨: 5 ä¸ª
- æµç¨‹äº‹ä»¶: 9 ä¸ª
- ä»»åŠ¡æäº¤å¤„ç†å™¨: 10 ä¸ª
- æ‰©å±•æœåŠ¡: 5 ä¸ª
- ä¸šåŠ¡æœåŠ¡: 3 ä¸ª

### åŠŸèƒ½è¦†ç›–
- æµç¨‹äº‹ä»¶ç›‘å¬: 5 ç§
- èŠ‚ç‚¹æµè½¬å¤„ç†: 8 ç§
- APIæƒé™æ§åˆ¶: ç»†ç²’åº¦
- æµç¨‹å˜é‡ç®¡ç†: å®Œæ•´API
- æµç¨‹ç›‘æ§: å®æ—¶ç›‘æ§
- æµç¨‹ç»Ÿè®¡: å¤šç»´ç»Ÿè®¡

---

## æ€»ç»“

âœ… è„šæœ¬ä»»åŠ¡å¤„ç†å™¨å·²å®ç°ï¼ˆæ”¯æŒ4ç§è„šæœ¬è¯­è¨€ï¼‰
âœ… æµç¨‹ç›‘æ§æœåŠ¡å·²å®ç°ï¼ˆæ”¯æŒå®æ—¶ç›‘æ§å’Œè¶…æ—¶æ£€æµ‹ï¼‰
âœ… æµç¨‹ç»Ÿè®¡æœåŠ¡å·²å®ç°ï¼ˆæ”¯æŒå¤šç»´åº¦ç»Ÿè®¡å’Œæ¯æ—¥ç»Ÿè®¡ï¼‰
âœ… æ‰©å±•æ¡†æ¶åŠŸèƒ½å®Œå–„ï¼Œæ”¯æŒä¸»è¦ä¸šåŠ¡åœºæ™¯

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯æ‰€æœ‰åŠŸèƒ½
2. å®ç°å‰©ä½™èŠ‚ç‚¹ç±»å‹çš„å¤„ç†å™¨ï¼ˆReceiveTaskç­‰ï¼‰
3. æ·»åŠ æ›´å¤šç›‘æ§æŒ‡æ ‡ï¼ˆå¦‚é”™è¯¯ç‡ã€ç“¶é¢ˆåˆ†æï¼‰
4. é›†æˆå›¾è¡¨å±•ç¤ºç»Ÿè®¡æ•°æ®
5. ç»§ç»­æ‰§è¡Œå…¶ä»–æ¨¡å—å¼€å‘
