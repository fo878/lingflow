# æ‰§è¡Œè®°å½•ï¼šå·¥å…·ç±»å’Œå¼‚å¸¸å¤„ç†å®Œå–„

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°æµç¨‹å·¥å…·ç±»ã€æµç¨‹éªŒè¯å™¨å’Œå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œä¸ºæ‰©å±•æ¡†æ¶æä¾›å®Œæ•´çš„æ”¯æ’‘åŸºç¡€è®¾æ–½ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. æµç¨‹å·¥å…·ç±»

#### ProcessUtils.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/util/ProcessUtils.java`

**åŠŸèƒ½**:
- æä¾›æµç¨‹ç›¸å…³çš„å®ç”¨å·¥å…·æ–¹æ³•
- å°è£…å¸¸ç”¨çš„æµç¨‹æ“ä½œé€»è¾‘
- ç®€åŒ–æµç¨‹å®ä¾‹ç®¡ç†

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ | è¿”å›å€¼ |
|------|------|--------|
| calculateProcessDuration | è®¡ç®—æµç¨‹å®ä¾‹è¿è¡Œæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰ | Long |
| formatDuration | æ ¼å¼åŒ–æ—¶é•¿ä¸ºå¯è¯»å­—ç¬¦ä¸² | String |
| getUserTaskNodes | è·å–æµç¨‹å®šä¹‰çš„æ‰€æœ‰ç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹ | List\<UserTaskInfo\> |
| getNextUserTask | è·å–æµç¨‹å®ä¾‹çš„ä¸‹ä¸€ä¸ªç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹ | UserTaskInfo |
| isProcessCompleted | æ£€æŸ¥æµç¨‹å®ä¾‹æ˜¯å¦å·²å®Œæˆ | boolean |
| getProcessVariables | è·å–æµç¨‹å®ä¾‹çš„æ‰€æœ‰å˜é‡ | Map\<String, Object\> |
| getProcessVariable | è·å–æµç¨‹å®ä¾‹çš„å•ä¸ªå˜é‡ | Object |
| setProcessVariables | è®¾ç½®æµç¨‹å˜é‡ | void |
| deleteProcessInstance | åˆ é™¤æµç¨‹å®ä¾‹ | void |
| suspendProcessInstance | æŒ‚èµ·æµç¨‹å®ä¾‹ | void |
| activateProcessInstance | æ¿€æ´»æµç¨‹å®ä¾‹ | void |
| getLatestProcessDefinition | è·å–æµç¨‹å®šä¹‰çš„æœ€æ–°ç‰ˆæœ¬ | ProcessDefinitionVO |

**å†…éƒ¨ç±»**:
```java
@Data
public static class UserTaskInfo {
    private String id;                  // ä»»åŠ¡ID
    private String name;                // ä»»åŠ¡åç§°
    private String assignee;            // åŠç†äºº
    private Set<String> candidateGroups;   // å€™é€‰ç»„
    private Set<String> candidateUsers;    // å€™é€‰ç”¨æˆ·
    private Date createTime;            // åˆ›å»ºæ—¶é—´
}
```

**æŠ€æœ¯è¦ç‚¹**:
- åŒæ—¶æ”¯æŒè¿è¡Œæ—¶å’Œå†å²æ•°æ®æŸ¥è¯¢
- ä½¿ç”¨ Duration è®¡ç®—æ—¶é•¿å·®å€¼
- æ”¯æŒæ—¶é•¿æ ¼å¼åŒ–ä¸ºå¯è¯»å­—ç¬¦ä¸²ï¼ˆå¤©ã€å°æ—¶ã€åˆ†é’Ÿã€ç§’ï¼‰
- ä» BpmnModel è§£æç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹
- é›†æˆ RuntimeServiceã€TaskServiceã€HistoryService

### 2. æµç¨‹éªŒè¯å™¨

#### ProcessValidator.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/util/ProcessValidator.java`

**åŠŸèƒ½**:
- éªŒè¯ BPMN XML æ ¼å¼å’Œå†…å®¹
- éªŒè¯æµç¨‹å®šä¹‰æ˜¯å¦å­˜åœ¨
- éªŒè¯æµç¨‹å˜é‡å®Œæ•´æ€§
- éªŒè¯ç”¨æˆ·ä»»åŠ¡é…ç½®
- éªŒè¯æµç¨‹å®ä¾‹çŠ¶æ€
- éªŒè¯ä»»åŠ¡æ“ä½œæƒé™
- éªŒè¯æµç¨‹éƒ¨ç½²å‡†å¤‡

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ | éªŒè¯å†…å®¹ |
|------|------|----------|
| validateBpmnXml | éªŒè¯BPMN XMLæ ¼å¼ | XMLæ ¼å¼ã€æµç¨‹å®šä¹‰ã€æµç¨‹IDã€å¼€å§‹èŠ‚ç‚¹ã€ç”¨æˆ·ä»»åŠ¡é…ç½® |
| validateProcessDefinition | éªŒè¯æµç¨‹å®šä¹‰æ˜¯å¦å­˜åœ¨ | æµç¨‹å®šä¹‰Keyæ˜¯å¦å­˜åœ¨ |
| validateProcessVariables | éªŒè¯æµç¨‹å˜é‡ | å¿…éœ€å˜é‡æ˜¯å¦å­˜åœ¨ |
| validateUserTaskConfiguration | éªŒè¯ç”¨æˆ·ä»»åŠ¡é…ç½® | assigneeæˆ–candidateUsers/Groups |
| validateProcessInstanceState | éªŒè¯æµç¨‹å®ä¾‹çŠ¶æ€ | æµç¨‹å®ä¾‹çŠ¶æ€æ˜¯å¦åŒ¹é… |
| validateTaskPermission | éªŒè¯ä»»åŠ¡æ“ä½œæƒé™ | ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ“ä½œä»»åŠ¡ |
| validateDeployment | éªŒè¯æµç¨‹å®šä¹‰æ˜¯å¦å¯éƒ¨ç½² | XMLæ ¼å¼ã€æµç¨‹ID |

**å†…éƒ¨ç±»**:
```java
@Data
public static class ValidationResult {
    private boolean valid;              // æ˜¯å¦æœ‰æ•ˆ
    private List<String> errors;        // é”™è¯¯åˆ—è¡¨
    private List<String> warnings;      // è­¦å‘Šåˆ—è¡¨

    public void addError(String error);
    public void addWarning(String warning);
    public boolean hasErrors();
    public boolean hasWarnings();
}
```

**éªŒè¯è§„åˆ™**:

1. **BPMN XMLéªŒè¯**:
   - XMLæ ¼å¼æ­£ç¡®æ€§
   - æµç¨‹å®šä¹‰å­˜åœ¨æ€§
   - æµç¨‹IDå¿…å¡«
   - æµç¨‹åç§°å»ºè®®å¡«å†™
   - è‡³å°‘ä¸€ä¸ªå¼€å§‹èŠ‚ç‚¹
   - ç”¨æˆ·ä»»åŠ¡é…ç½®æ£€æŸ¥

2. **æµç¨‹å˜é‡éªŒè¯**:
   - å¿…éœ€å˜é‡å­˜åœ¨æ€§æ£€æŸ¥
   - æ”¯æŒæ‰¹é‡å˜é‡éªŒè¯

3. **ç”¨æˆ·ä»»åŠ¡é…ç½®éªŒè¯**:
   - assignee æˆ– candidateUsers/Groups è‡³å°‘é…ç½®ä¸€ä¸ª
   - åŒºåˆ†é”™è¯¯å’Œè­¦å‘Šçº§åˆ«

4. **éƒ¨ç½²éªŒè¯**:
   - å…ˆéªŒè¯XMLæ ¼å¼
   - å†éªŒè¯æµç¨‹ID
   - ç¡®ä¿å¯éƒ¨ç½²

### 3. å¼‚å¸¸å¤„ç†ç±»

åˆ›å»º10ä¸ªä¸“ä¸šå¼‚å¸¸ç±»ï¼Œç»§æ‰¿ BusinessException åŸºç±»ï¼š

| å¼‚å¸¸ç±» | HTTPçŠ¶æ€ç  | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|-----------|------|----------|
| ProcessInstanceNotFoundException | 404 | æµç¨‹å®ä¾‹ä¸å­˜åœ¨ | æŸ¥è¯¢æµç¨‹å®ä¾‹æ—¶æœªæ‰¾åˆ° |
| TaskNotFoundException | 404 | ä»»åŠ¡ä¸å­˜åœ¨ | æŸ¥è¯¢ä»»åŠ¡æ—¶æœªæ‰¾åˆ° |
| ProcessVariableException | 400 | æµç¨‹å˜é‡å¼‚å¸¸ | å˜é‡ä¸å­˜åœ¨ã€ç±»å‹é”™è¯¯ã€éªŒè¯å¤±è´¥ |
| ProcessValidationException | 400 | æµç¨‹éªŒè¯å¼‚å¸¸ | BPMNéªŒè¯å¤±è´¥ã€é…ç½®éªŒè¯å¤±è´¥ |
| ProcessExecutionException | 500 | æµç¨‹æ‰§è¡Œå¼‚å¸¸ | æµç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ |
| PermissionDeniedException | 403 | æƒé™ä¸è¶³ | ç”¨æˆ·æ— æƒæ‰§è¡ŒæŸæ“ä½œ |
| ProcessDeploymentException | 500 | æµç¨‹éƒ¨ç½²å¼‚å¸¸ | æµç¨‹éƒ¨ç½²å¤±è´¥ |
| TaskOperationException | 400 | ä»»åŠ¡æ“ä½œå¼‚å¸¸ | ä»»åŠ¡å®Œæˆã€è½¬åŠã€æ’¤å›ç­‰æ“ä½œå¤±è´¥ |
| ProcessStateException | 400 | æµç¨‹çŠ¶æ€å¼‚å¸¸ | æµç¨‹çŠ¶æ€ä¸ç¬¦åˆæ“ä½œè¦æ±‚ |
| ProcessTimeoutException | 408 | æµç¨‹è¶…æ—¶å¼‚å¸¸ | æµç¨‹æˆ–ä»»åŠ¡è¶…æ—¶ |

#### å¼‚å¸¸ç±»ç‰¹ç‚¹

1. **ProcessInstanceNotFoundException**
```java
new ProcessInstanceNotFoundException(processInstanceId)
new ProcessInstanceNotFoundException(message, cause)
```

2. **TaskNotFoundException**
```java
new TaskNotFoundException(taskId)
new TaskNotFoundException(message, cause)
```

3. **ProcessVariableException**
```java
new ProcessVariableException(variableName)
new ProcessVariableException(variableName, reason)
new ProcessVariableException(message, cause)
```

4. **ProcessValidationException**
```java
new ProcessValidationException(message)
new ProcessValidationException(errors)  // æ”¯æŒå¤šä¸ªé”™è¯¯
new ProcessValidationException(message, errors)
```

5. **ProcessExecutionException**
```java
new ProcessExecutionException(message)
new ProcessExecutionException(message, cause)
new ProcessExecutionException(processInstanceId, reason)
```

6. **PermissionDeniedException**
```java
new PermissionDeniedException(operation)
new PermissionDeniedException(operation, userId)
new PermissionDeniedException(message, cause)
```

7. **ProcessDeploymentException**
```java
new ProcessDeploymentException(message)
new ProcessDeploymentException(message, cause)
new ProcessDeploymentException(processDefinitionKey, reason)
```

8. **TaskOperationException**
```java
new TaskOperationException(message)
new TaskOperationException(message, cause)
new TaskOperationException(taskId, operation, reason)
```

9. **ProcessStateException**
```java
new ProcessStateException(message)
new ProcessStateException(message, cause)
new ProcessStateException(processInstanceId, expectedState, actualState)
new ProcessStateException(processInstanceId, reason)
```

10. **ProcessTimeoutException**
```java
new ProcessTimeoutException(processInstanceId, timeoutHours)
new ProcessTimeoutException(message)
// æ”¯æŒè·å–æµç¨‹å®ä¾‹IDå’Œè¶…æ—¶æ—¶é•¿
```

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. ProcessUtils ä½¿ç”¨ç¤ºä¾‹

```java
@Autowired
private ProcessUtils processUtils;

// è®¡ç®—æµç¨‹è¿è¡Œæ—¶é•¿
Long duration = processUtils.calculateProcessDuration(processInstanceId);
String formatted = processUtils.formatDuration(duration);
System.out.println("è¿è¡Œæ—¶é•¿: " + formatted);  // è¾“å‡º: 1å¤©2å°æ—¶30åˆ†é’Ÿ15ç§’

// è·å–ç”¨æˆ·ä»»åŠ¡èŠ‚ç‚¹
List<UserTaskInfo> userTasks = processUtils.getUserTaskNodes(processDefinitionId);
for (UserTaskInfo task : userTasks) {
    System.out.println("ä»»åŠ¡: " + task.getName() + ", åŠç†äºº: " + task.getAssignee());
}

// è·å–ä¸‹ä¸€ä¸ªç”¨æˆ·ä»»åŠ¡
UserTaskInfo nextTask = processUtils.getNextUserTask(processInstanceId);
if (nextTask != null) {
    System.out.println("ä¸‹ä¸€ä¸ªä»»åŠ¡: " + nextTask.getName());
}

// æ£€æŸ¥æµç¨‹æ˜¯å¦å®Œæˆ
boolean completed = processUtils.isProcessCompleted(processInstanceId);
if (completed) {
    System.out.println("æµç¨‹å·²å®Œæˆ");
}

// è·å–æµç¨‹å˜é‡
Map<String, Object> variables = processUtils.getProcessVariables(processInstanceId);
Object approvalResult = processUtils.getProcessVariable(processInstanceId, "approvalResult");

// è®¾ç½®æµç¨‹å˜é‡
Map<String, Object> newVars = new HashMap<>();
newVars.put("approvalResult", "approved");
processUtils.setProcessVariables(processInstanceId, newVars);

// æµç¨‹å®ä¾‹æ§åˆ¶
processUtils.suspendProcessInstance(processInstanceId);  // æŒ‚èµ·
processUtils.activateProcessInstance(processInstanceId); // æ¿€æ´»
processUtils.deleteProcessInstance(processInstanceId, "æµ‹è¯•åˆ é™¤"); // åˆ é™¤

// è·å–æœ€æ–°æµç¨‹å®šä¹‰
ProcessDefinitionVO definition = processUtils.getLatestProcessDefinition("leaveProcess");
```

### 2. ProcessValidator ä½¿ç”¨ç¤ºä¾‹

```java
@Autowired
private ProcessValidator processValidator;

// éªŒè¯BPMN XML
ValidationResult result = processValidator.validateBpmnXml(bpmnXml);
if (!result.isValid()) {
    System.out.println("éªŒè¯å¤±è´¥:");
    for (String error : result.getErrors()) {
        System.out.println("  - " + error);
    }
}
if (result.hasWarnings()) {
    System.out.println("è­¦å‘Š:");
    for (String warning : result.getWarnings()) {
        System.out.println("  - " + warning);
    }
}

// éªŒè¯æµç¨‹å®šä¹‰æ˜¯å¦å­˜åœ¨
ValidationResult result = processValidator.validateProcessDefinition("leaveProcess");
if (!result.isValid()) {
    throw new ProcessDefinitionNotFoundException("leaveProcess");
}

// éªŒè¯æµç¨‹å˜é‡
Set<String> requiredVars = new HashSet<>();
requiredVars.add("applicant");
requiredVars.add("days");
requiredVars.add("reason");

ValidationResult result = processValidator.validateProcessVariables(variables, requiredVars);
if (!result.isValid()) {
    throw new ProcessVariableException("ç¼ºå°‘å¿…éœ€çš„æµç¨‹å˜é‡");
}

// éªŒè¯ç”¨æˆ·ä»»åŠ¡é…ç½®
ValidationResult result = processValidator.validateUserTaskConfiguration(processDefinitionId);
if (!result.isValid()) {
    throw new ProcessValidationException("ç”¨æˆ·ä»»åŠ¡é…ç½®ä¸å®Œæ•´", result.getErrors());
}

// éªŒè¯æµç¨‹éƒ¨ç½²
ValidationResult result = processValidator.validateDeployment(bpmnXml);
if (!result.isValid()) {
    throw new ProcessDeploymentException("BPMNéªŒè¯å¤±è´¥", result.getErrors());
}
```

### 3. å¼‚å¸¸ç±»ä½¿ç”¨ç¤ºä¾‹

```java
// æµç¨‹å®ä¾‹ä¸å­˜åœ¨
if (instance == null) {
    throw new ProcessInstanceNotFoundException(processInstanceId);
}

// ä»»åŠ¡ä¸å­˜åœ¨
if (task == null) {
    throw new TaskNotFoundException(taskId);
}

// æµç¨‹å˜é‡å¼‚å¸¸
if (variables == null || !variables.containsKey("approvalResult")) {
    throw new ProcessVariableException("approvalResult", "ç¼ºå°‘å¿…éœ€çš„å®¡æ‰¹ç»“æœå˜é‡");
}

// æµç¨‹éªŒè¯å¼‚å¸¸
ValidationResult result = validator.validateBpmnXml(bpmnXml);
if (!result.isValid()) {
    throw new ProcessValidationException(result.getErrors());
}

// æµç¨‹æ‰§è¡Œå¼‚å¸¸
try {
    runtimeService.startProcessInstanceByKey(...)
} catch (Exception e) {
    throw new ProcessExecutionException(processDefinitionKey, "å¯åŠ¨æµç¨‹å¤±è´¥", e);
}

// æƒé™ä¸è¶³
if (!hasPermission(userId, "complete", taskId)) {
    throw new PermissionDeniedException("å®Œæˆä»»åŠ¡", userId);
}

// æµç¨‹éƒ¨ç½²å¼‚å¸¸
try {
    repositoryService.createDeployment()
        .addBytes("process.bpmn20.xml", bpmnXmlBytes)
        .deploy();
} catch (Exception e) {
    throw new ProcessDeploymentException(processDefinitionKey, "éƒ¨ç½²å¤±è´¥", e);
}

// ä»»åŠ¡æ“ä½œå¼‚å¸¸
if (task.isSuspended()) {
    throw new TaskOperationException(taskId, "complete", "ä»»åŠ¡å·²æŒ‚èµ·");
}

// æµç¨‹çŠ¶æ€å¼‚å¸¸
if (!instance.isSuspended()) {
    throw new ProcessStateException(processInstanceId, "SUSPENDED", "ACTIVE");
}

// æµç¨‹è¶…æ—¶å¼‚å¸¸
Long duration = processUtils.calculateProcessDuration(processInstanceId);
if (duration != null && duration > timeoutMillis) {
    throw new ProcessTimeoutException(processInstanceId, timeoutHours);
}
```

---

## æ–‡ä»¶æ¸…å•

### åˆ›å»ºçš„æ–‡ä»¶

```
backend/src/main/java/com/lingflow/
â”œâ”€â”€ util/
â”‚   â”œâ”€â”€ ProcessUtils.java              # æµç¨‹å·¥å…·ç±»
â”‚   â””â”€â”€ ProcessValidator.java          # æµç¨‹éªŒè¯å™¨
â””â”€â”€ exception/
    â”œâ”€â”€ ProcessInstanceNotFoundException.java   # æµç¨‹å®ä¾‹ä¸å­˜åœ¨å¼‚å¸¸
    â”œâ”€â”€ TaskNotFoundException.java              # ä»»åŠ¡ä¸å­˜åœ¨å¼‚å¸¸
    â”œâ”€â”€ ProcessVariableException.java           # æµç¨‹å˜é‡å¼‚å¸¸
    â”œâ”€â”€ ProcessValidationException.java         # æµç¨‹éªŒè¯å¼‚å¸¸
    â”œâ”€â”€ ProcessExecutionException.java          # æµç¨‹æ‰§è¡Œå¼‚å¸¸
    â”œâ”€â”€ PermissionDeniedException.java          # æƒé™ä¸è¶³å¼‚å¸¸
    â”œâ”€â”€ ProcessDeploymentException.java         # æµç¨‹éƒ¨ç½²å¼‚å¸¸
    â”œâ”€â”€ TaskOperationException.java             # ä»»åŠ¡æ“ä½œå¼‚å¸¸
    â”œâ”€â”€ ProcessStateException.java              # æµç¨‹çŠ¶æ€å¼‚å¸¸
    â””â”€â”€ ProcessTimeoutException.java            # æµç¨‹è¶…æ—¶å¼‚å¸¸
```

### å·²æœ‰çš„æ–‡ä»¶

```
backend/src/main/java/com/lingflow/exception/
â”œâ”€â”€ BusinessException.java              # ä¸šåŠ¡å¼‚å¸¸åŸºç±»
â””â”€â”€ ProcessDefinitionNotFoundException.java  # æµç¨‹å®šä¹‰ä¸å­˜åœ¨å¼‚å¸¸
```

---

## æŠ€æœ¯äº®ç‚¹

### 1. å·¥å…·ç±»è®¾è®¡

**ç‰¹ç‚¹**:
- é™æ€æ–¹æ³• + Spring Component æ¨¡å¼
- ä¾èµ–æ³¨å…¥ Flowable æœåŠ¡
- å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ”¯æŒè¿è¡Œæ—¶å’Œå†å²æ•°æ®æŸ¥è¯¢

**ä¼˜åŠ¿**:
- å°è£…å¸¸ç”¨æ“ä½œï¼Œç®€åŒ–ä¸šåŠ¡ä»£ç 
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- æ”¯æŒæ—¶é•¿è®¡ç®—å’Œæ ¼å¼åŒ–
- æä¾›æµç¨‹çŠ¶æ€æ£€æŸ¥æ–¹æ³•

### 2. éªŒè¯å™¨è®¾è®¡

**ç‰¹ç‚¹**:
- å¤šç»´åº¦éªŒè¯ï¼ˆXMLã€å®šä¹‰ã€å˜é‡ã€é…ç½®ã€æƒé™ï¼‰
- ç»Ÿä¸€çš„éªŒè¯ç»“æœæ ¼å¼
- åŒºåˆ†é”™è¯¯å’Œè­¦å‘Šçº§åˆ«
- æ”¯æŒæ‰¹é‡éªŒè¯

**ä¼˜åŠ¿**:
- æå‰å‘ç°é—®é¢˜ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
- çµæ´»çš„éªŒè¯ç­–ç•¥
- å¯æ‰©å±•çš„éªŒè¯è§„åˆ™

### 3. å¼‚å¸¸ä½“ç³»è®¾è®¡

**ç‰¹ç‚¹**:
- ç»§æ‰¿ BusinessException åŸºç±»
- HTTP çŠ¶æ€ç æ ‡å‡†åŒ–
- æ”¯æŒå¼‚å¸¸é“¾ï¼ˆcauseï¼‰
- ä¸°å¯Œçš„æ„é€ å‡½æ•°

**ä¼˜åŠ¿**:
- è¯­ä¹‰åŒ–çš„å¼‚å¸¸ç±»å‹
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- ä¾¿äºå…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·
- æ”¯æŒè¯¦ç»†é”™è¯¯ä¿¡æ¯

---

## ä¸æ‰©å±•æ¡†æ¶çš„é›†æˆ

### 1. åœ¨ ExtendedService ä¸­ä½¿ç”¨å¼‚å¸¸ç±»

```java
@Service
public class ExtendedRuntimeService {

    public ProcessInstance startProcessInstanceByKey(...) {
        return template.execute("startProcessInstanceByKey", () -> {
            // éªŒè¯æµç¨‹å®šä¹‰
            ValidationResult result = validator.validateProcessDefinition(processDefinitionKey);
            if (!result.isValid()) {
                throw new ProcessDefinitionNotFoundException(processDefinitionKey);
            }

            // éªŒè¯æµç¨‹å˜é‡
            result = validator.validateProcessVariables(variables, requiredVars);
            if (!result.isValid()) {
                throw new ProcessVariableException("ç¼ºå°‘å¿…éœ€çš„æµç¨‹å˜é‡");
            }

            // å¯åŠ¨æµç¨‹
            try {
                return runtimeService.startProcessInstanceByKey(...);
            } catch (Exception e) {
                throw new ProcessExecutionException(processDefinitionKey, "å¯åŠ¨æµç¨‹å¤±è´¥", e);
            }
        });
    }
}
```

### 2. åœ¨ TaskCompletionHandler ä¸­ä½¿ç”¨å¼‚å¸¸ç±»

```java
@Component
@Order(1)
public class ValidationTaskCompletionHandler implements TaskCompletionHandler {

    @Override
    public void preHandle(TaskCompletionContext context) {
        // éªŒè¯ä»»åŠ¡çŠ¶æ€
        if (context.getTask().isSuspended()) {
            throw new TaskOperationException(
                context.getTaskId(),
                "complete",
                "ä»»åŠ¡å·²æŒ‚èµ·"
            );
        }

        // éªŒè¯æƒé™
        if (!hasPermission(context)) {
            throw new PermissionDeniedException(
                "å®Œæˆä»»åŠ¡",
                context.getUserId()
            );
        }

        // éªŒè¯å˜é‡
        ValidationResult result = validator.validateProcessVariables(
            context.getVariables(),
            getRequiredVariables()
        );
        if (!result.isValid()) {
            throw new ProcessVariableException("å˜é‡éªŒè¯å¤±è´¥");
        }
    }
}
```

### 3. åœ¨ FlowableServiceWrapper ä¸­ä½¿ç”¨å¼‚å¸¸ç±»

```java
@Component
@Order(0)
public class AuthorizationWrapper implements FlowableServiceWrapper {

    @Override
    public <T> T wrap(String methodName, Supplier<T> supplier) {
        // æ£€æŸ¥æƒé™
        if (!hasPermission(methodName)) {
            throw new PermissionDeniedException(
                methodName,
                getCurrentUserId()
            );
        }

        return supplier.get();
    }
}
```

---

## å®Œæ•´çš„é¡¹ç›®æ–‡ä»¶ç»Ÿè®¡ï¼ˆæˆªè‡³å½“å‰ï¼‰

### æ€»è®¡åˆ›å»º Java æ–‡ä»¶ï¼š46 ä¸ª

**åˆ†ç±»ç»Ÿè®¡**:
- APIåŒ…è£…å™¨: 5 ä¸ª
- æµç¨‹äº‹ä»¶: 5 ä¸ª
- ä»»åŠ¡æäº¤å¤„ç†å™¨: 9 ä¸ª
- æ‰©å±•æœåŠ¡: 6 ä¸ª
- ä¸šåŠ¡æœåŠ¡: 4 ä¸ª
- å·¥å…·ç±»: 2 ä¸ª
- å¼‚å¸¸ç±»: 12 ä¸ª
- DTOç±»: 3 ä¸ª

### åŠŸèƒ½è¦†ç›–

**æ‰©å±•æœºåˆ¶**:
- âœ… APIåŒ…è£…å™¨é“¾
- âœ… æµç¨‹äº‹ä»¶ç›‘å¬
- âœ… ä»»åŠ¡æäº¤å¤„ç†å™¨é“¾

**æµç¨‹èŠ‚ç‚¹ç±»å‹**:
- âœ… USER_TASKï¼ˆç”¨æˆ·ä»»åŠ¡ï¼‰
- âœ… GATEWAYï¼ˆç½‘å…³ï¼šæ’ä»–ã€å¹¶è¡Œã€åŒ…å®¹ï¼‰
- âœ… MULTI_INSTANCEï¼ˆå¤šå®ä¾‹ï¼‰
- âœ… CALL_ACTIVITYï¼ˆè°ƒç”¨æ´»åŠ¨ï¼‰
- âœ… SERVICE_TASKï¼ˆæœåŠ¡ä»»åŠ¡ï¼‰
- âœ… SCRIPT_TASKï¼ˆè„šæœ¬ä»»åŠ¡ï¼‰
- âœ… RECEIVE_TASKï¼ˆæ¥æ”¶ä»»åŠ¡ï¼‰

**ä¸šåŠ¡åŠŸèƒ½**:
- âœ… æµç¨‹å˜é‡ç®¡ç†
- âœ… æµç¨‹ç›‘æ§
- âœ… æµç¨‹ç»Ÿè®¡
- âœ… æµç¨‹é€šçŸ¥
- âœ… æµç¨‹è¯„è®º
- âœ… æƒé™æ§åˆ¶
- âœ… æµç¨‹å·¥å…·ç±»
- âœ… æµç¨‹éªŒè¯å™¨

**å¼‚å¸¸å¤„ç†**:
- âœ… æµç¨‹å®šä¹‰å¼‚å¸¸
- âœ… æµç¨‹å®ä¾‹å¼‚å¸¸
- âœ… ä»»åŠ¡å¼‚å¸¸
- âœ… å˜é‡å¼‚å¸¸
- âœ… éªŒè¯å¼‚å¸¸
- âœ… æ‰§è¡Œå¼‚å¸¸
- âœ… æƒé™å¼‚å¸¸
- âœ… éƒ¨ç½²å¼‚å¸¸
- âœ… çŠ¶æ€å¼‚å¸¸
- âœ… è¶…æ—¶å¼‚å¸¸

---

## æ€»ç»“

âœ… **ProcessUtils å·²å®ç°**
- 13ä¸ªå®ç”¨å·¥å…·æ–¹æ³•
- æ”¯æŒæµç¨‹å®ä¾‹å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- é›†æˆè¿è¡Œæ—¶å’Œå†å²æœåŠ¡
- æä¾›æ—¶é•¿è®¡ç®—å’Œæ ¼å¼åŒ–

âœ… **ProcessValidator å·²å®ç°**
- 7ä¸ªéªŒè¯æ–¹æ³•
- æ”¯æŒå¤šç»´åº¦éªŒè¯
- ç»Ÿä¸€çš„éªŒè¯ç»“æœæ ¼å¼
- åŒºåˆ†é”™è¯¯å’Œè­¦å‘Šçº§åˆ«

âœ… **å¼‚å¸¸å¤„ç†æœºåˆ¶å·²å®Œå–„**
- 10ä¸ªä¸“ä¸šå¼‚å¸¸ç±»
- HTTPçŠ¶æ€ç æ ‡å‡†åŒ–
- æ”¯æŒå¼‚å¸¸é“¾å’Œè¯¦ç»†é”™è¯¯ä¿¡æ¯
- ä¸å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ— ç¼é›†æˆ

ğŸ¯ **æ‰©å±•æ¡†æ¶æ”¯æ’‘è®¾æ–½å·²å®Œæˆ**
- å·¥å…·ç±»æä¾›å¸¸ç”¨æ“ä½œå°è£…
- éªŒè¯å™¨æä¾›å‰ç½®éªŒè¯èƒ½åŠ›
- å¼‚å¸¸ç±»æä¾›æ ‡å‡†åŒ–é”™è¯¯å¤„ç†

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯å·¥å…·ç±»å’ŒéªŒè¯å™¨åŠŸèƒ½
2. åœ¨ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨æ–°çš„å¼‚å¸¸ç±»æ›¿ä»£é€šç”¨å¼‚å¸¸
3. å®Œå–„éªŒè¯è§„åˆ™ï¼Œæ·»åŠ æ›´å¤šéªŒè¯åœºæ™¯
4. é›†æˆå®é™…ä¸šåŠ¡ï¼ŒéªŒè¯å¼‚å¸¸å¤„ç†çš„å‡†ç¡®æ€§
5. ç»§ç»­æ‰§è¡Œå…¶ä»–æ¨¡å—å¼€å‘

ğŸ‰ **å·¥å…·ç±»å’Œå¼‚å¸¸å¤„ç†å®Œå–„å·²å®Œæˆï¼**
- æµç¨‹å·¥å…·ç±»æä¾›å®Œæ•´çš„å®ç”¨æ–¹æ³•
- æµç¨‹éªŒè¯å™¨æä¾›å¤šç»´åº¦éªŒè¯èƒ½åŠ›
- å¼‚å¸¸ä½“ç³»æä¾›æ ‡å‡†åŒ–é”™è¯¯å¤„ç†
- æ‰©å±•æ¡†æ¶æ”¯æ’‘è®¾æ–½å®Œæ•´
