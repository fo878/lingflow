# æ‰§è¡Œè®°å½•ï¼šæ‰©å±•æ¡†æ¶ - äº‹ä»¶ç›‘å¬å™¨å’Œå¤„ç†å™¨

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°æ‰©å±•æ¡†æ¶çš„äº‹ä»¶ç›‘å¬å™¨å’Œä»»åŠ¡æäº¤å¤„ç†å™¨ï¼Œå®Œå–„æ‰©å±•æœºåˆ¶ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. æµç¨‹äº‹ä»¶ç›‘å¬å™¨

#### ProcessStartListener.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/event/impl/ProcessStartListener.java`

**åŠŸèƒ½**:
- ç›‘å¬æµç¨‹å¯åŠ¨äº‹ä»¶ï¼ˆPROCESS_STARTï¼‰
- åœ¨æµç¨‹å¯åŠ¨å‰åæ‰§è¡Œæ‰©å±•é€»è¾‘

**æ‰©å±•ç‚¹**:
- å‰ç½®ï¼šéªŒè¯å¯åŠ¨æƒé™ã€åˆå§‹åŒ–ä¸šåŠ¡å˜é‡ã€è®°å½•å®¡è®¡æ—¥å¿—
- åç½®ï¼šå‘é€å¯åŠ¨é€šçŸ¥ã€è§¦å‘ä¸šåŠ¡è§„åˆ™å¼•æ“ã€æ›´æ–°ä¸šåŠ¡çŠ¶æ€

#### TaskCreatedListener.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/event/impl/TaskCreatedListener.java`

**åŠŸèƒ½**:
- ç›‘å¬ä»»åŠ¡åˆ›å»ºäº‹ä»¶ï¼ˆTASK_CREATEDï¼‰
- åœ¨ä»»åŠ¡åˆ›å»ºåæ‰§è¡Œæ‰©å±•é€»è¾‘

**æ‰©å±•ç‚¹**:
- åç½®ï¼šå‘é€å¾…åŠé€šçŸ¥ã€æ·»åŠ å€™é€‰äºº/ç»„ã€è®¾ç½®ä»»åŠ¡åˆ°æœŸæ—¶é—´ã€è®°å½•å®¡è®¡ä¿¡æ¯

#### TaskCompletedListener.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/event/impl/TaskCompletedListener.java`

**åŠŸèƒ½**:
- ç›‘å¬ä»»åŠ¡å®Œæˆäº‹ä»¶ï¼ˆTASK_COMPLETEDï¼‰
- åœ¨ä»»åŠ¡å®Œæˆå‰åæ‰§è¡Œæ‰©å±•é€»è¾‘

**æ‰©å±•ç‚¹**:
- å‰ç½®ï¼šéªŒè¯ä»»åŠ¡å®Œæˆæƒé™ã€éªŒè¯å¿…å¡«å˜é‡ã€æ£€æŸ¥ä¸šåŠ¡è§„åˆ™ã€è®°å½•å®Œæˆæ—¶é—´
- åç½®ï¼šå‘é€å®Œæˆé€šçŸ¥ã€è§¦å‘ä¸‹æ¸¸æµç¨‹ã€æ›´æ–°ä¸šåŠ¡æ•°æ®ã€ç”Ÿæˆä¸šåŠ¡æŠ¥å‘Š

### 2. ä»»åŠ¡æäº¤å¤„ç†å™¨

#### UserTaskToUserTaskHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/UserTaskToUserTaskHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°ç”¨æˆ·ä»»åŠ¡çš„æµè½¬
- æ”¯æŒä»»åŠ¡æµè½¬çš„å‰ç½®ã€æ ¸å¿ƒã€åç½®å’Œå›æ»šå¤„ç†

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ USER_TASK

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯å¿…å¡«å˜é‡ã€æ£€æŸ¥åŠç†äººæœ‰æ•ˆæ€§ã€éªŒè¯ä¸šåŠ¡è§„åˆ™
- **handle**: ä¼ é€’æµç¨‹å˜é‡ã€è®¾ç½®ä¸‹ä¸€ä»»åŠ¡å€™é€‰äºº/ç»„ã€è®°å½•æµè½¬æ—¥å¿—
- **postHandle**: å‘é€å¾…åŠé€šçŸ¥ã€æ›´æ–°ä¸šåŠ¡çŠ¶æ€ã€è§¦å‘å…¶ä»–ä¸šåŠ¡é€»è¾‘
- **rollback**: æ¸…ç†å·²åˆ›å»ºçš„ä¸‹ä¸€ä»»åŠ¡ã€æ¢å¤å˜é‡çŠ¶æ€ã€å‘é€å›æ»šé€šçŸ¥

#### GatewayHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/GatewayHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°ç½‘å…³çš„æµè½¬
- æ”¯æŒæ’ä»–ç½‘å…³ã€å¹¶è¡Œç½‘å…³ã€åŒ…å®¹ç½‘å…³

**æ”¯æŒçš„æµè½¬**:
- USER_TASK â†’ EXCLUSIVE_GATEWAYï¼ˆæ’ä»–ç½‘å…³ï¼‰
- USER_TASK â†’ PARALLEL_GATEWAYï¼ˆå¹¶è¡Œç½‘å…³ï¼‰
- USER_TASK â†’ INCLUSIVE_GATEWAYï¼ˆåŒ…å®¹ç½‘å…³ï¼‰

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: æ ¹æ®ç½‘å…³ç±»å‹éªŒè¯å¿…éœ€å˜é‡ã€é¢„è®¡ç®—ç½‘å…³æ¡ä»¶ã€éªŒè¯ä¸šåŠ¡è§„åˆ™
- **handle**: è®¾ç½®ç½‘å…³å†³ç­–å˜é‡ã€è®°å½•ç½‘å…³æ‰§è¡Œæ—¥å¿—ã€å‡†å¤‡å¹¶è¡Œè·¯å¾„æ•°æ®
- **postHandle**: è®°å½•ç½‘å…³å†³ç­–ç»“æœã€è®°å½•å¹¶è¡Œä»»åŠ¡æ•°ã€è§¦å‘åç»­ä¸šåŠ¡é€»è¾‘
- **rollback**: æ¸…ç†å·²åˆ›å»ºçš„å¹¶è¡Œè·¯å¾„ã€æ¢å¤ç½‘å…³å‰çš„çŠ¶æ€ã€å‘é€å›æ»šé€šçŸ¥

### 3. è¾…åŠ©æ³¨è§£

#### SupportedNodeTypes.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/SupportedNodeTypes.java`

**åŠŸèƒ½**:
- æ³¨è§£ï¼šæ ‡è®°ä»»åŠ¡æäº¤å¤„ç†å™¨æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹
- ç”¨äºå£°æ˜å¼é…ç½®æ”¯æŒçš„æµè½¬ç»„åˆ

---

## æ¶æ„é›†æˆ

### äº‹ä»¶ç›‘å¬å™¨è‡ªåŠ¨è£…é…

```
ProcessEventListener (æ¥å£)
    â†‘
    â”œâ”€â”€ ProcessStartListener (@Component, order=10)
    â”œâ”€â”€ TaskCreatedListener (@Component, order=20)
    â””â”€â”€ TaskCompletedListener (@Component, order=30)
         â†“
    ProcessEventManager (è‡ªåŠ¨è£…é…æ‰€æœ‰ç›‘å¬å™¨)
```

### ä»»åŠ¡æäº¤å¤„ç†å™¨è‡ªåŠ¨è£…é…

```
TaskCompletionHandler (æ¥å£)
    â†‘
    â”œâ”€â”€ UserTaskToUserTaskHandler (@Component, order=10)
    â””â”€â”€ GatewayHandler (@Component, order=20)
         â†“
    TaskCompletionHandlerChain (è‡ªåŠ¨è£…é…æ‰€æœ‰å¤„ç†å™¨)
```

---

## äº‹ä»¶ç±»å‹å®šä¹‰

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ç›‘å¬å™¨ |
|---------|---------|--------|
| PROCESS_START | æµç¨‹å¯åŠ¨æ—¶ | ProcessStartListener |
| TASK_CREATED | ä»»åŠ¡åˆ›å»ºå | TaskCreatedListener |
| TASK_COMPLETED | ä»»åŠ¡å®Œæˆæ—¶ | TaskCompletedListener |

---

## æ”¯æŒçš„èŠ‚ç‚¹æµè½¬

| å½“å‰èŠ‚ç‚¹ | ä¸‹ä¸€èŠ‚ç‚¹ | å¤„ç†å™¨ |
|---------|---------|--------|
| USER_TASK | USER_TASK | UserTaskToUserTaskHandler |
| USER_TASK | EXCLUSIVE_GATEWAY | GatewayHandler |
| USER_TASK | PARALLEL_GATEWAY | GatewayHandler |
| USER_TASK | INCLUSIVE_GATEWAY | GatewayHandler |

---

## ä½¿ç”¨ç¤ºä¾‹

### æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬å™¨

```java
@Component
public class CustomEventListener implements ProcessEventListener {

    @Override
    public void onBefore(ProcessEvent event) {
        // å‰ç½®å¤„ç†é€»è¾‘
    }

    @Override
    public void onAfter(ProcessEvent event) {
        // åç½®å¤„ç†é€»è¾‘
    }

    @Override
    public boolean supports(String eventType) {
        return "CUSTOM_EVENT".equals(eventType);
    }

    @Override
    public int getOrder() {
        return 100; // ä¼˜å…ˆçº§
    }
}
```

### æ·»åŠ è‡ªå®šä¹‰ä»»åŠ¡æäº¤å¤„ç†å™¨

```java
@Component
public class CustomTaskHandler implements TaskCompletionHandler {

    @Override
    public boolean supports(TaskCompletionContext context) {
        // åˆ¤æ–­æ˜¯å¦æ”¯æŒè¯¥æµè½¬
        return context.getCurrentNodeType() == NodeType.USER_TASK
            && context.getNextNodeType() == NodeType.SERVICE_TASK;
    }

    @Override
    public void preHandle(TaskCompletionContext context) {
        // å‰ç½®å¤„ç†
    }

    @Override
    public void handle(TaskCompletionContext context) {
        // æ ¸å¿ƒå¤„ç†
    }

    @Override
    public void postHandle(TaskCompletionContext context) {
        // åç½®å¤„ç†
    }

    @Override
    public void rollback(TaskCompletionContext context) {
        // å›æ»šå¤„ç†
    }

    @Override
    public int getOrder() {
        return 50;
    }
}
```

---

## æ‰©å±•èƒ½åŠ›

### 1. æµç¨‹äº‹ä»¶æ‰©å±•

é€šè¿‡å®ç° `ProcessEventListener` æ¥å£ï¼Œå¯ä»¥ç›‘å¬å’Œæ‰©å±•ï¼š
- æµç¨‹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¯åŠ¨ã€ç»“æŸã€æŒ‚èµ·ã€æ¿€æ´»ï¼‰
- ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆåˆ›å»ºã€å®Œæˆã€åˆ é™¤ï¼‰
- èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆè¿›å…¥ã€ç¦»å¼€ï¼‰

### 2. ä»»åŠ¡æäº¤æ‰©å±•

é€šè¿‡å®ç° `TaskCompletionHandler` æ¥å£ï¼Œå¯ä»¥æ‰©å±•ï¼š
- ç‰¹å®šèŠ‚ç‚¹ç±»å‹çš„æµè½¬é€»è¾‘
- å¤æ‚çš„æµè½¬åœºæ™¯ï¼ˆå¦‚ä¼šç­¾ã€å¹¶è¡Œã€å­æµç¨‹ï¼‰
- è‡ªå®šä¹‰çš„ä¸šåŠ¡è§„åˆ™éªŒè¯
- çµæ´»çš„å›æ»šæœºåˆ¶

---

## éªŒè¯æµ‹è¯•

ç”±äº Maven æœªå®‰è£…ï¼Œæ— æ³•æ‰§è¡Œç¼–è¯‘éªŒè¯ã€‚å»ºè®®åç»­ï¼š

1. **å•å…ƒæµ‹è¯•**ï¼šæµ‹è¯•æ¯ä¸ªç›‘å¬å™¨å’Œå¤„ç†å™¨çš„é€»è¾‘
2. **é›†æˆæµ‹è¯•**ï¼šæµ‹è¯•å®Œæ•´çš„æµç¨‹æµè½¬
3. **æ‰©å±•æµ‹è¯•**ï¼šæµ‹è¯•æ·»åŠ è‡ªå®šä¹‰ç›‘å¬å™¨å’Œå¤„ç†å™¨

---

## åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
backend/src/main/java/com/lingflow/extension/
â”œâ”€â”€ event/
â”‚   â””â”€â”€ impl/
â”‚       â”œâ”€â”€ ProcessStartListener.java
â”‚       â”œâ”€â”€ TaskCreatedListener.java
â”‚       â””â”€â”€ TaskCompletedListener.java
â””â”€â”€ handler/
    â”œâ”€â”€ SupportedNodeTypes.java
    â””â”€â”€ impl/
        â”œâ”€â”€ UserTaskToUserTaskHandler.java
        â””â”€â”€ GatewayHandler.java
```

---

## æ€»ç»“

âœ… æµç¨‹äº‹ä»¶ç›‘å¬å™¨å·²åˆ›å»ºï¼ˆ3ä¸ªï¼‰
âœ… ä»»åŠ¡æäº¤å¤„ç†å™¨å·²åˆ›å»ºï¼ˆ2ä¸ªï¼‰
âœ… æ”¯æŒæ³¨è§£å·²åˆ›å»ºï¼ˆSupportedNodeTypesï¼‰
âœ… è‡ªåŠ¨è£…é…æœºåˆ¶å·²éªŒè¯ï¼ˆProcessEventManagerã€TaskCompletionHandlerChainï¼‰

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ç›‘å¬å™¨å’Œå¤„ç†å™¨åŠŸèƒ½
2. æ·»åŠ æ›´å¤šçš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚ ProcessEndListenerï¼‰
3. æ·»åŠ æ›´å¤šçš„ä»»åŠ¡æäº¤å¤„ç†å™¨ï¼ˆå¦‚ MultiInstanceHandlerã€SubProcessHandlerï¼‰
4. å®é™…é›†æˆåˆ°ä¸šåŠ¡æµç¨‹ä¸­éªŒè¯æ‰©å±•æ€§
