# æ‰§è¡Œè®°å½•ï¼šæ‰©å±•æ¡†æ¶ - é«˜çº§å¤„ç†å™¨å’Œç›‘å¬å™¨

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°æ›´å¤šé«˜çº§ä»»åŠ¡æäº¤å¤„ç†å™¨å’Œæµç¨‹äº‹ä»¶ç›‘å¬å™¨ï¼Œæ”¯æŒå¤æ‚æµè½¬åœºæ™¯ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. ä»»åŠ¡æäº¤å¤„ç†å™¨

#### MultiInstanceHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/MultiInstanceHandler.java`

**åŠŸèƒ½**:
- å¤„ç†è¿›å…¥æˆ–ç¦»å¼€å¤šå®ä¾‹èŠ‚ç‚¹çš„æµè½¬
- æ”¯æŒä¸²è¡Œå¤šå®ä¾‹å’Œå¹¶è¡Œå¤šå®ä¾‹
- å¤„ç†ä¼šç­¾åœºæ™¯

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ MULTI_INSTANCE

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯å¤šå®ä¾‹é…ç½®ã€å‡†å¤‡å¤šå®ä¾‹å˜é‡ã€éªŒè¯ä¼šç­¾è§„åˆ™
- **handle**:
  - ä¸²è¡Œå¤šå®ä¾‹ï¼šè®°å½•å¾ªç¯è®¡æ•°
  - å¹¶è¡Œå¤šå®ä¾‹ï¼šè®°å½•åŠç†äººåˆ—è¡¨
- **postHandle**: è®°å½•å¤šå®ä¾‹è¿›åº¦ã€å¤„ç†ä¼šç­¾ç»“æœ
- **rollback**: æ¸…ç†å·²åˆ›å»ºçš„å¤šå®ä¾‹ä»»åŠ¡

**æ”¯æŒçš„å˜é‡**:
- `nrOfInstances`: å®ä¾‹æ€»æ•°
- `nrOfActiveInstances`: æ´»è·ƒå®ä¾‹æ•°
- `nrOfCompletedInstances`: å·²å®Œæˆå®ä¾‹æ•°
- `multiInstanceType`: å¤šå®ä¾‹ç±»å‹ï¼ˆparallel/sequentialï¼‰
- `completionCondition`: å®Œæˆæ¡ä»¶
- `assigneeList`: åŠç†äººåˆ—è¡¨ï¼ˆå¹¶è¡Œï¼‰
- `loopCounter`: å¾ªç¯è®¡æ•°ï¼ˆä¸²è¡Œï¼‰
- `approveCount`: åŒæ„æ•°é‡
- `rejectCount`: æ‹’ç»æ•°é‡

#### SubProcessHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/SubProcessHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°è°ƒç”¨æ´»åŠ¨ï¼ˆCallActivityï¼‰çš„æµè½¬
- ç®¡ç†å­æµç¨‹è°ƒç”¨å’Œå˜é‡ä¼ é€’
- æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥è°ƒç”¨

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ CALL_ACTIVITY

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯å­æµç¨‹å­˜åœ¨ã€å‡†å¤‡å­æµç¨‹å˜é‡ã€è®¾ç½®ä¼ é€’å‚æ•°
- **handle**:
  - è®¾ç½®å­æµç¨‹è°ƒç”¨æ ‡è®°
  - è®°å½•çˆ¶å­æµç¨‹å…³ç³»
  - å¤„ç†å˜é‡ä¼ é€’å’ŒInOutæ˜ å°„
- **postHandle**: è®°å½•å­æµç¨‹å®ä¾‹IDã€è®¾ç½®å›è°ƒç›‘å¬
- **rollback**: å–æ¶ˆå­æµç¨‹ã€æ¸…ç†è°ƒç”¨å…³ç³»

**æ”¯æŒçš„å˜é‡**:
- `calledProcessKey`: è°ƒç”¨çš„æµç¨‹Key
- `subProcessVariables`: å­æµç¨‹å˜é‡
- `subProcessBusinessKey`: å­æµç¨‹ä¸šåŠ¡Key
- `variablesToPass`: è¦ä¼ é€’çš„å˜é‡
- `inOutVariableMapping`: InOutå˜é‡æ˜ å°„
- `waitForCompletion`: æ˜¯å¦ç­‰å¾…å­æµç¨‹å®Œæˆ
- `subProcessInstanceId`: å­æµç¨‹å®ä¾‹ID

### 2. æµç¨‹äº‹ä»¶ç›‘å¬å™¨

#### ProcessEndListener.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/event/impl/ProcessEndListener.java`

**åŠŸèƒ½**:
- ç›‘å¬æµç¨‹ç»“æŸäº‹ä»¶ï¼ˆPROCESS_ENDï¼‰
- æ ¹æ®æµç¨‹ç»“æœæ‰§è¡Œä¸åŒé€»è¾‘

**æ”¯æŒçš„äº‹ä»¶**: PROCESS_END

**å¤„ç†é˜¶æ®µ**:
- **onBefore**: éªŒè¯ç»“æŸæ¡ä»¶ã€è®¡ç®—æ‰§è¡Œæ—¶é•¿ã€è®°å½•ç»“æŸåŸå› 
- **onAfter**:
  - å½’æ¡£æµç¨‹æ•°æ®
  - æ›´æ–°ä¸šåŠ¡çŠ¶æ€
  - æ ¹æ®ç»“æœå¤„ç†ï¼ˆé€šè¿‡/æ‹’ç»/å–æ¶ˆ/å®Œæˆï¼‰
  - è®°å½•æµç¨‹ç»Ÿè®¡ä¿¡æ¯

**æ”¯æŒçš„æµç¨‹ç»“æœ**:
- `approved`: å·²é€šè¿‡
- `rejected`: å·²æ‹’ç»
- `cancelled`: å·²å–æ¶ˆ
- `completed`: æ­£å¸¸å®Œæˆ

**æ”¯æŒçš„å˜é‡**:
- `processResult`: æµç¨‹ç»“æœ
- `rejectReason`: æ‹’ç»åŸå› 
- `cancelReason`: å–æ¶ˆåŸå› 
- `finalVariables`: æœ€ç»ˆæµç¨‹å˜é‡
- `hasSubProcess`: æ˜¯å¦åŒ…å«å­æµç¨‹
- `totalTasks`: æ€»ä»»åŠ¡æ•°
- `completedTasks`: å·²å®Œæˆä»»åŠ¡æ•°

---

## ä½¿ç”¨åœºæ™¯

### 1. ä¼šç­¾åœºæ™¯ï¼ˆMultiInstanceHandlerï¼‰

**åœºæ™¯æè¿°**: å¤šäººä¾æ¬¡æˆ–å¹¶è¡Œå®¡æ‰¹åŒä¸€ä»»åŠ¡

**é…ç½®ç¤ºä¾‹**:
```xml
<userTask id="approveTask" name="ä¼šç­¾å®¡æ‰¹">
  <multiInstanceLoopCharacteristics isSequential="false">
    <loopCardinality>${assigneeList.size()}</loopCardinality>
    <completionCondition>${nrOfCompletedInstances == nrOfInstances}</completionCondition>
    <loopDataInputRef>assigneeList</loopDataInputRef>
    <inputDataItem>assignee</inputDataItem>
  </multiInstanceLoopCharacteristics>
</userTask>
```

**å˜é‡è®¾ç½®**:
```java
variables.put("assigneeList", Arrays.asList("user1", "user2", "user3"));
variables.put("nrOfInstances", 3);
variables.put("multiInstanceType", "parallel");
```

### 2. å­æµç¨‹è°ƒç”¨åœºæ™¯ï¼ˆSubProcessHandlerï¼‰

**åœºæ™¯æè¿°**: ä¸»æµç¨‹è°ƒç”¨å­æµç¨‹ï¼Œä¼ é€’å˜é‡å¹¶ç­‰å¾…ç»“æœ

**é…ç½®ç¤ºä¾‹**:
```xml
<callActivity id="callSubProcess" name="è°ƒç”¨å­æµç¨‹"
    calledElement="subProcessKey">
  <extensionElements>
    <flowable:in source="${parentVar}" target="childVar"/>
    <flowable:out source="childResult" target="parentResult"/>
  </extensionElements>
</callActivity>
```

**å˜é‡è®¾ç½®**:
```java
variables.put("calledProcessKey", "subProcessKey");
variables.put("subProcessBusinessKey", businessKey);
variables.put("waitForCompletion", true);
variables.put("variablesToPass", params);
```

### 3. æµç¨‹ç»“æŸåœºæ™¯ï¼ˆProcessEndListenerï¼‰

**åœºæ™¯æè¿°**: æµç¨‹ç»“æŸæ—¶æ ¹æ®ç»“æœæ‰§è¡Œä¸åŒé€»è¾‘

**å˜é‡è®¾ç½®**:
```java
// æµç¨‹é€šè¿‡
variables.put("processResult", "approved");

// æµç¨‹æ‹’ç»
variables.put("processResult", "rejected");
variables.put("rejectReason", "ä¸ç¬¦åˆå®¡æ‰¹æ¡ä»¶");

// æµç¨‹å–æ¶ˆ
variables.put("processResult", "cancelled");
variables.put("cancelReason", "ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ");
```

---

## å®Œæ•´çš„æµè½¬æ”¯æŒçŸ©é˜µ

| å½“å‰èŠ‚ç‚¹ | ä¸‹ä¸€èŠ‚ç‚¹ | å¤„ç†å™¨ | çŠ¶æ€ |
|---------|---------|--------|------|
| USER_TASK | USER_TASK | UserTaskToUserTaskHandler | âœ… |
| USER_TASK | EXCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | PARALLEL_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | INCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | MULTI_INSTANCE | MultiInstanceHandler | âœ… |
| USER_TASK | CALL_ACTIVITY | SubProcessHandler | âœ… |
| USER_TASK | SERVICE_TASK | å¾…å®ç° | â³ |
| USER_TASK | SCRIPT_TASK | å¾…å®ç° | â³ |

---

## å®Œæ•´çš„äº‹ä»¶ç›‘å¬å™¨æ¸…å•

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ç›‘å¬å™¨ | ä¼˜å…ˆçº§ |
|---------|---------|--------|--------|
| PROCESS_START | æµç¨‹å¯åŠ¨ | ProcessStartListener | 10 |
| PROCESS_END | æµç¨‹ç»“æŸ | ProcessEndListener | 5 |
| TASK_CREATED | ä»»åŠ¡åˆ›å»º | TaskCreatedListener | 20 |
| TASK_COMPLETED | ä»»åŠ¡å®Œæˆ | TaskCompletedListener | 30 |

---

## æ‰©å±•å»ºè®®

### å¯ä»¥ç»§ç»­å®ç°çš„å¤„ç†å™¨

1. **ServiceTaskHandler**: å¤„ç†åˆ°æœåŠ¡ä»»åŠ¡çš„æµè½¬
2. **ScriptTaskHandler**: å¤„ç†åˆ°è„šæœ¬ä»»åŠ¡çš„æµè½¬
3. **ReceiveTaskHandler**: å¤„ç†åˆ°æ¥æ”¶ä»»åŠ¡çš„æµè½¬
4. **ManualTaskHandler**: å¤„ç†åˆ°æ‰‹åŠ¨ä»»åŠ¡çš„æµè½¬

### å¯ä»¥ç»§ç»­å®ç°çš„ç›‘å¬å™¨

1. **ProcessSuspendListener**: æµç¨‹æŒ‚èµ·ç›‘å¬å™¨
2. **ProcessActivateListener**: æµç¨‹æ¿€æ´»ç›‘å¬å™¨
3. **TaskAssignedListener**: ä»»åŠ¡åˆ†é…ç›‘å¬å™¨
4. **TaskDeletedListener**: ä»»åŠ¡åˆ é™¤ç›‘å¬å™¨
5. **GatewayExecuteListener**: ç½‘å…³æ‰§è¡Œç›‘å¬å™¨

---

## åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
backend/src/main/java/com/lingflow/extension/
â”œâ”€â”€ event/
â”‚   â””â”€â”€ impl/
â”‚       â””â”€â”€ ProcessEndListener.java          # æµç¨‹ç»“æŸç›‘å¬å™¨
â””â”€â”€ handler/
    â””â”€â”€ impl/
        â”œâ”€â”€ MultiInstanceHandler.java        # å¤šå®ä¾‹å¤„ç†å™¨
        â””â”€â”€ SubProcessHandler.java           # å­æµç¨‹å¤„ç†å™¨
```

---

## æ€»ç»“

âœ… å¤šå®ä¾‹å¤„ç†å™¨å·²å®ç°ï¼ˆæ”¯æŒä¼šç­¾åœºæ™¯ï¼‰
âœ… å­æµç¨‹å¤„ç†å™¨å·²å®ç°ï¼ˆæ”¯æŒè°ƒç”¨æ´»åŠ¨ï¼‰
âœ… æµç¨‹ç»“æŸç›‘å¬å™¨å·²å®ç°ï¼ˆæ”¯æŒç»“æœå¤„ç†ï¼‰
âœ… æ‰©å±•æ¡†æ¶æ”¯æŒçš„æµè½¬åœºæ™¯æ›´åŠ ä¸°å¯Œ

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯é«˜çº§å¤„ç†å™¨åŠŸèƒ½
2. æ·»åŠ æ›´å¤šèŠ‚ç‚¹ç±»å‹çš„å¤„ç†å™¨
3. å®ç°æ›´å¤šç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ç›‘å¬å™¨
4. é›†æˆåˆ°å®é™…ä¸šåŠ¡æµç¨‹ä¸­éªŒè¯
