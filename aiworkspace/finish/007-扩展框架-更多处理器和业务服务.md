# æ‰§è¡Œè®°å½•ï¼šæ‰©å±•æ¡†æ¶ - æ›´å¤šå¤„ç†å™¨å’Œä¸šåŠ¡æœåŠ¡

> æ‰§è¡Œæ—¶é—´ï¼š2025-01-15
> çŠ¶æ€ï¼šå·²å®Œæˆ

## ä»»åŠ¡æ¦‚è¿°

å®ç°æ›´å¤šèŠ‚ç‚¹ç±»å‹çš„å¤„ç†å™¨ã€é¢å¤–çš„æµç¨‹äº‹ä»¶ç›‘å¬å™¨ã€æƒé™æ£€æŸ¥åŒ…è£…å™¨å’Œæµç¨‹å˜é‡ç®¡ç†æœåŠ¡ã€‚

---

## å·²åˆ›å»ºçš„æ–‡ä»¶

### 1. ä»»åŠ¡æäº¤å¤„ç†å™¨

#### ServiceTaskHandler.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/handler/impl/ServiceTaskHandler.java`

**åŠŸèƒ½**:
- å¤„ç†ç”¨æˆ·ä»»åŠ¡åˆ°æœåŠ¡ä»»åŠ¡çš„æµè½¬
- æ”¯æŒå¤šç§æœåŠ¡ç±»å‹ï¼ˆJavaç±»ã€è¡¨è¾¾å¼ã€å§”æ‰˜è¡¨è¾¾å¼ã€WebæœåŠ¡ã€å¤–éƒ¨æœåŠ¡ï¼‰

**æ”¯æŒçš„æµè½¬**: USER_TASK â†’ SERVICE_TASK

**æ”¯æŒçš„æœåŠ¡ç±»å‹**:
| ç±»å‹ | è¯´æ˜ |
|------|------|
| java | Javaç±»æœåŠ¡ |
| expression | è¡¨è¾¾å¼æœåŠ¡ |
| delegate | å§”æ‰˜è¡¨è¾¾å¼æœåŠ¡ |
| webservice | WebæœåŠ¡ï¼ˆSOAPï¼‰ |
| external | å¤–éƒ¨ä»»åŠ¡ï¼ˆRESTï¼‰ |

**å¤„ç†é˜¶æ®µ**:
- **preHandle**: éªŒè¯æœåŠ¡é…ç½®ã€å‡†å¤‡å‚æ•°ã€æ£€æŸ¥æƒé™
- **handle**: æ ¹æ®æœåŠ¡ç±»å‹æ‰§è¡Œä¸åŒå¤„ç†
- **postHandle**: æ£€æŸ¥æ‰§è¡Œç»“æœã€è®°å½•æ—¥å¿—
- **rollback**: è¡¥å¿æ“ä½œã€æ¸…ç†çŠ¶æ€

### 2. æµç¨‹äº‹ä»¶ç›‘å¬å™¨

#### TaskAssignedListener.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/event/impl/TaskAssignedListener.java`

**åŠŸèƒ½**:
- ç›‘å¬ä»»åŠ¡åˆ†é…äº‹ä»¶ï¼ˆTASK_ASSIGNEDï¼‰
- å‘é€åˆ†é…é€šçŸ¥ã€æ›´æ–°åŠç†äººç»Ÿè®¡

**æ”¯æŒçš„äº‹ä»¶**: TASK_ASSIGNED

**å¤„ç†é˜¶æ®µ**:
- **onBefore**: éªŒè¯åŠç†äººæœ‰æ•ˆæ€§ã€æ£€æŸ¥æƒé™ã€éªŒè¯å·¥ä½œè´Ÿè½½
- **onAfter**:
  - å‘é€ä»»åŠ¡åˆ†é…é€šçŸ¥
  - æ›´æ–°åŠç†äººä»»åŠ¡åˆ—è¡¨
  - è®°å½•åˆ†é…å®¡è®¡æ—¥å¿—
  - å¤„ç†ä»»åŠ¡é‡æ–°åˆ†é…

### 3. æƒé™æ£€æŸ¥åŒ…è£…å™¨

#### AuthorizationWrapper.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/extension/wrapper/impl/AuthorizationWrapper.java`

**åŠŸèƒ½**:
- åœ¨æ‰§è¡Œ Flowable API è°ƒç”¨å‰æ£€æŸ¥ç”¨æˆ·æƒé™
- æ”¯æŒç»†ç²’åº¦çš„æ“ä½œæƒé™æ§åˆ¶

**æƒé™æ£€æŸ¥**:
| æ“ä½œç±»å‹ | æ£€æŸ¥å†…å®¹ |
|---------|---------|
| deploy | æ£€æŸ¥éƒ¨ç½²æƒé™ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ |
| startProcessInstance | æ£€æŸ¥å¯åŠ¨æµç¨‹æƒé™ |
| completeTask | æ£€æŸ¥å®Œæˆä»»åŠ¡æƒé™ |
| deleteDeployment | æ£€æŸ¥åˆ é™¤æƒé™ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ |
| suspend/activate | æ£€æŸ¥æŒ‚èµ·/æ¿€æ´»æƒé™ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ |

**å…¬å¼€æ“ä½œ**ï¼ˆä¸éœ€è¦æƒé™æ£€æŸ¥ï¼‰:
- createProcessDefinitionQuery
- createProcessInstanceQuery
- createTaskQuery
- createHistoricProcessInstanceQuery
- createHistoricTaskInstanceQuery

**æ‰§è¡Œé¡ºåº**: 0ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰

### 4. æµç¨‹å˜é‡ç®¡ç†æœåŠ¡

#### ProcessVariableService.java
**è·¯å¾„**: `/data/lingflow/backend/src/main/java/com/lingflow/service/ProcessVariableService.java`

**åŠŸèƒ½**:
- å°è£…æµç¨‹å˜é‡çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
- æ”¯æŒæµç¨‹å®ä¾‹å˜é‡ã€ä»»åŠ¡æœ¬åœ°å˜é‡ã€å†å²å˜é‡
- æ‰€æœ‰æ“ä½œé€šè¿‡ FlowableServiceTemplate æ‰§è¡Œ

**ä¸»è¦æ–¹æ³•**:
| æ–¹æ³• | è¯´æ˜ |
|------|------|
| setProcessInstanceVariables | è®¾ç½®æµç¨‹å®ä¾‹å˜é‡ |
| getProcessInstanceVariables | è·å–æµç¨‹å®ä¾‹å˜é‡ |
| setProcessInstanceVariable | è®¾ç½®å•ä¸ªæµç¨‹å®ä¾‹å˜é‡ |
| removeProcessInstanceVariables | åˆ é™¤æµç¨‹å®ä¾‹å˜é‡ |
| setTaskLocalVariables | è®¾ç½®ä»»åŠ¡æœ¬åœ°å˜é‡ |
| getTaskLocalVariables | è·å–ä»»åŠ¡æœ¬åœ°å˜é‡ |
| setTaskVariables | è®¾ç½®ä»»åŠ¡å˜é‡ï¼ˆå½±å“æµç¨‹èŒƒå›´ï¼‰ |
| getTaskVariables | è·å–ä»»åŠ¡å˜é‡ |
| getHistoricProcessInstanceVariables | è·å–å†å²æµç¨‹å®ä¾‹å˜é‡ |
| getHistoricTaskVariables | è·å–å†å²ä»»åŠ¡å˜é‡ |
| upsertProcessInstanceVariables | æ›´æ–°æˆ–æ’å…¥æµç¨‹å˜é‡ |
| copyProcessInstanceVariables | å¤åˆ¶æµç¨‹å˜é‡ |

---

## å®Œæ•´çš„æµè½¬æ”¯æŒçŸ©é˜µï¼ˆæ›´æ–°ï¼‰

| å½“å‰èŠ‚ç‚¹ | ä¸‹ä¸€èŠ‚ç‚¹ | å¤„ç†å™¨ | çŠ¶æ€ |
|---------|---------|--------|------|
| USER_TASK | USER_TASK | UserTaskToUserTaskHandler | âœ… |
| USER_TASK | EXCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | PARALLEL_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | INCLUSIVE_GATEWAY | GatewayHandler | âœ… |
| USER_TASK | MULTI_INSTANCE | MultiInstanceHandler | âœ… |
| USER_TASK | CALL_ACTIVITY | SubProcessHandler | âœ… |
| USER_TASK | SERVICE_TASK | ServiceTaskHandler | âœ… |
| USER_TASK | SCRIPT_TASK | å¾…å®ç° | â³ |
| USER_TASK | RECEIVE_TASK | å¾…å®ç° | â³ |

---

## å®Œæ•´çš„äº‹ä»¶ç›‘å¬å™¨æ¸…å•ï¼ˆæ›´æ–°ï¼‰

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ç›‘å¬å™¨ | ä¼˜å…ˆçº§ |
|---------|---------|--------|--------|
| PROCESS_START | æµç¨‹å¯åŠ¨ | ProcessStartListener | 10 |
| PROCESS_END | æµç¨‹ç»“æŸ | ProcessEndListener | 5 |
| TASK_CREATED | ä»»åŠ¡åˆ›å»º | TaskCreatedListener | 20 |
| TASK_ASSIGNED | ä»»åŠ¡åˆ†é… | TaskAssignedListener | 25 |
| TASK_COMPLETED | ä»»åŠ¡å®Œæˆ | TaskCompletedListener | 30 |

---

## å®Œæ•´çš„åŒ…è£…å™¨æ¸…å•ï¼ˆæ›´æ–°ï¼‰

| åŒ…è£…å™¨ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|--------|------|--------|------|
| AuthorizationWrapper | æƒé™æ£€æŸ¥ | 0 | âœ… æ–°å¢ |
| LoggingWrapper | æ—¥å¿—è®°å½• | 1 | âœ… |
| PerformanceMonitoringWrapper | æ€§èƒ½ç›‘æ§ | 2 | âœ… |

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨æµç¨‹å˜é‡æœåŠ¡

```java
@Autowired
private ProcessVariableService variableService;

// è®¾ç½®æµç¨‹å˜é‡
Map<String, Object> variables = new HashMap<>();
variables.put("approveResult", "approved");
variables.put("approveComment", "åŒæ„");
variableService.setProcessInstanceVariables(processInstanceId, variables);

// è·å–æµç¨‹å˜é‡
Map<String, Object> vars = variableService.getProcessInstanceVariables(processInstanceId);

// æ›´æ–°æˆ–æ’å…¥å˜é‡
variableService.upsertProcessInstanceVariables(processInstanceId, variables);

// å¤åˆ¶å˜é‡åˆ°å¦ä¸€ä¸ªæµç¨‹
variableService.copyProcessInstanceVariables(sourceId, targetId);
```

### 2. æƒé™æ£€æŸ¥é…ç½®

```java
// åœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯
Headers: {
  "X-User-Id": "admin"
}

// æˆ–é€šè¿‡è¯·æ±‚å‚æ•°
?userId=admin

// æˆ–é€šè¿‡session
session.setAttribute("userId", "admin");
```

### 3. æœåŠ¡ä»»åŠ¡å¤„ç†å™¨ä½¿ç”¨

```java
// Javaç±»æœåŠ¡
variables.put("serviceType", "java");
variables.put("serviceClassName", "com.example.MyService");

// è¡¨è¾¾å¼æœåŠ¡
variables.put("serviceType", "expression");
variables.put("serviceExpression", "${myService.doSomething()}");

// å§”æ‰˜è¡¨è¾¾å¼
variables.put("serviceType", "delegate");
variables.put("delegateExpression", "${myServiceDelegate}");

// WebæœåŠ¡
variables.put("serviceType", "webservice");
variables.put("wsdlUrl", "http://example.com/service?wsdl");
variables.put("wsOperation", "processData");

// å¤–éƒ¨æœåŠ¡
variables.put("serviceType", "external");
variables.put("externalTopic", "testTopic");
variables.put("externalType", "rest");
```

---

## åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

```
backend/src/main/java/com/lingflow/
â”œâ”€â”€ extension/
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â””â”€â”€ ServiceTaskHandler.java        # æœåŠ¡ä»»åŠ¡å¤„ç†å™¨
â”‚   â”œâ”€â”€ event/
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â””â”€â”€ TaskAssignedListener.java      # ä»»åŠ¡åˆ†é…ç›‘å¬å™¨
â”‚   â””â”€â”€ wrapper/
â”‚       â””â”€â”€ impl/
â”‚           â””â”€â”€ AuthorizationWrapper.java      # æƒé™æ£€æŸ¥åŒ…è£…å™¨
â””â”€â”€ service/
    â””â”€â”€ ProcessVariableService.java            # æµç¨‹å˜é‡ç®¡ç†æœåŠ¡
```

---

## æ€»ç»“

âœ… æœåŠ¡ä»»åŠ¡å¤„ç†å™¨å·²å®ç°ï¼ˆæ”¯æŒ5ç§æœåŠ¡ç±»å‹ï¼‰
âœ… ä»»åŠ¡åˆ†é…ç›‘å¬å™¨å·²å®ç°ï¼ˆæ”¯æŒåˆ†é…é€šçŸ¥å’Œç»Ÿè®¡ï¼‰
âœ… æƒé™æ£€æŸ¥åŒ…è£…å™¨å·²å®ç°ï¼ˆæ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶ï¼‰
âœ… æµç¨‹å˜é‡ç®¡ç†æœåŠ¡å·²å®ç°ï¼ˆæ”¯æŒå®Œæ•´çš„å˜é‡æ“ä½œï¼‰

ğŸ“ **åç»­å»ºè®®**:
1. ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯æ–°åŠŸèƒ½
2. å®ç°æ›´å¤šèŠ‚ç‚¹ç±»å‹çš„å¤„ç†å™¨ï¼ˆScriptTaskã€ReceiveTaskç­‰ï¼‰
3. é›†æˆå®é™…æƒé™ç³»ç»Ÿï¼ˆå¦‚Spring Securityï¼‰
4. å®ç°æ›´å¤šä¸šåŠ¡æœåŠ¡ï¼ˆå¦‚æµç¨‹ç›‘æ§ã€æµç¨‹ç»Ÿè®¡ï¼‰
5. ç»§ç»­æ‰§è¡Œå…¶ä»–æ¨¡å—å¼€å‘
