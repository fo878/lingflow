# 核心级模块 - 流程模板管理

> 优先级：P0（核心级）
> 预计工期：2 周
> 依赖：无

## 1. 功能概述

流程模板管理是流程管理系统的核心功能，提供流程设计、版本管理和发布能力。用户可以通过可视化设计器创建 BPMN 2.0 流程，并对其进行版本控制和发布管理。

---

## 2. 功能需求

### 2.1 BPMN 2.0 流程设计器

#### 功能描述
提供基于 BPMN.js 的可视化流程设计器，支持拖拽方式创建流程。

#### 用户故事
作为一个流程设计师，我希望能够通过拖拽方式设计流程，以便快速创建业务流程。

#### 功能点
1. **基础元素支持**
   - 开始事件（Start Event）
   - 结束事件（End Event）
   - 用户任务（User Task）
   - 服务任务（Service Task）
   - 排他网关（Exclusive Gateway）
   - 并行网关（Parallel Gateway）
   - 包容网关（Inclusive Gateway）
   - 泳道（Pool/Lane）

2. **设计器功能**
   - 拖拽添加节点
   - 连线创建流程流转
   - 节点属性编辑
   - 画布缩放（放大/缩小/重置）
   - 撤销/重做
   - 复制/粘贴节点
   - 删除节点

3. **元素属性配置**
   - 元素 ID（自动生成或手动设置）
   - 元素名称
   - 元素类型
   - 执行人（用户任务）
   - 候选用户/候选组（用户任务）
   - 表单 Key（用户任务）
   - 截止日期（用户任务）
   - 优先级（用户任务）
   - 实现类/表达式（服务任务）

#### 验收标准
- ✅ 可以通过拖拽添加所有基础元素
- ✅ 可以通过连线创建节点间流转
- ✅ 可以编辑节点属性
- ✅ 支持画布缩放操作
- ✅ 设计器响应流畅，无明显卡顿

#### 技术实现
```typescript
// 前端：使用 BPMN.js Modeler
import BpmnModeler from 'bpmn-js/lib/Modeler'

const modeler = new BpmnModeler({
  container: '#canvas',
  keyboard: { bindTo: window }
})
```

---

### 2.2 流程导入/导出

#### 功能描述
支持 BPMN 格式的流程文件导入和导出，便于流程的备份和迁移。

#### 功能点
1. **导出功能**
   - 导出为 BPMN XML 文件
   - 支持自定义文件名
   - 保留完整的流程定义

2. **导入功能**
   - 支持 BPMN XML 文件导入
   - 验证文件格式
   - 错误提示

#### 验收标准
- ✅ 导出的 BPMN 文件符合 BPMN 2.0 规范
- ✅ 导入的流程可正常解析和编辑
- ✅ 文件格式错误时有明确提示

#### API 接口
```java
// 后端：导入接口
POST /api/process/import
Content-Type: multipart/form-data
Request: file (BPMN XML file)
Response: ProcessDefinitionVO

// 前端：导出（本地实现，无需后端）
exportXML() {
  const { xml } = await modeler.saveXML({ format: true })
  // 触发下载
}
```

---

### 2.3 流程版本管理

#### 功能描述
支持流程的多版本管理，可以保存历史版本并在需要时回滚。

#### 功能点
1. **版本快照**
   - 创建流程快照
   - 快照名称
   - 快照描述
   - 创建人
   - 创建时间
   - 快照版本号

2. **版本查询**
   - 查看流程的所有快照
   - 按版本号排序
   - 显示快照详情

3. **版本回滚**
   - 回滚到指定快照
   - 回滚确认提示
   - 回滚后创建新版本

#### 验收标准
- ✅ 每次流程发布自动创建快照
- ✅ 可以手动创建命名快照
- ✅ 可以查看所有快照列表
- ✅ 回滚后流程可正常使用
- ✅ 回滚操作有二次确认

#### 数据库表
```sql
-- 流程快照表
CREATE TABLE process_snapshot (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_key VARCHAR(255) NOT NULL,
  snapshot_name VARCHAR(255) NOT NULL,
  snapshot_version VARCHAR(50) NOT NULL,
  description TEXT,
  creator VARCHAR(100),
  bpmn_xml TEXT NOT NULL,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_process_key (process_definition_key),
  INDEX idx_created_time (created_time)
);
```

#### API 接口
```java
// 创建快照
POST /api/process/snapshots
Request: {
  processDefinitionKey: string,
  snapshotName: string,
  description: string,
  creator: string
}
Response: ProcessSnapshotVO

// 查询快照列表
GET /api/process/snapshots/{processDefinitionKey}
Response: List<ProcessSnapshotVO>

// 回滚到快照
POST /api/process/snapshots/{snapshotId}/rollback
Response: ProcessDefinitionVO

// 删除快照
DELETE /api/process/snapshots/{snapshotId}
```

---

### 2.4 流程发布

#### 功能描述
将设计好的流程发布到流程引擎，使其可以被实例化执行。

#### 功能点
1. **发布流程**
   - 输入流程名称
   - 输入流程描述
   - 自动生成流程 Key
   - 版本号自动递增
   - 验证流程完整性

2. **流程验证**
   - 检查流程是否有开始节点
   - 检查流程是否有结束节点
   - 检查节点是否正确连接
   - 检查必要属性是否配置

3. **发布历史**
   - 查看所有已发布版本
   - 显示每个版本的状态
   - 显示发布时间

#### 验收标准
- ✅ 发布后流程可正常启动
- ✅ 版本号自动递增
- ✅ 不完整的流程无法发布
- ✅ 发布成功有明确提示

#### API 接口
```java
// 发布流程
POST /api/process/deploy
Request: {
  name: string,
  description?: string,
  xml: string
}
Response: {
  processDefinitionId: string,
  key: string,
  name: string,
  version: number,
  deploymentId: string
}

// 查询流程定义列表
GET /api/process/definitions
Response: Page<ProcessDefinitionVO>

// 获取流程定义 XML
GET /api/process/definitions/{processDefinitionId}/xml
Response: {
  processDefinitionId: string,
  bpmnXml: string,
  error?: string
}
```

---

## 3. 前端设计

### 3.1 页面结构

```
流程模板管理
├── 流程列表页面 (Index.vue)
│   ├── 新建流程按钮
│   ├── 流程列表表格
│   └── 操作按钮（编辑、查看、删除）
└── 流程设计器页面 (Designer.vue)
    ├── 头部工具栏
    │   ├── 流程名称输入
    │   ├── 缩放控制
    │   ├── 快照管理
    │   ├── 导出按钮
    │   └── 发布按钮
    ├── 画布区域
    └── 属性面板
        ├── 流程属性
        └── 元素属性
```

### 3.2 组件设计

#### ProcessList.vue - 流程列表组件
```typescript
<template>
  <el-table :data="processDefinitions" stripe>
    <el-table-column prop="name" label="流程名称" />
    <el-table-column prop="key" label="流程Key" />
    <el-table-column prop="version" label="版本" />
    <el-table-column prop="description" label="描述" />
    <el-table-column label="操作">
      <template #default="{ row }">
        <el-button @click="edit(row)">编辑</el-button>
        <el-button @click="view(row)">查看</el-button>
        <el-button @click="remove(row)">删除</el-button>
      </template>
    </el-table-column>
  </el-table>
</template>
```

#### ProcessDesigner.vue - 流程设计器组件
```typescript
<template>
  <div class="designer-container">
    <!-- 头部工具栏 -->
    <div class="designer-header">
      <el-input v-model="processName" placeholder="流程名称" />
      <div class="zoom-controls">
        <el-button @click="zoomIn">放大</el-button>
        <el-button @click="zoomOut">缩小</el-button>
        <el-button @click="resetZoom">重置</el-button>
      </div>
      <el-dropdown @command="handleSnapshot">
        <el-button>快照</el-button>
        <template #dropdown>
          <el-dropdown-menu>
            <el-dropdown-item command="create">创建快照</el-dropdown-item>
            <el-dropdown-item command="list">查看快照</el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
      <el-button @click="exportXML">导出</el-button>
      <el-button type="primary" @click="deploy">发布</el-button>
    </div>

    <!-- 画布和属性面板 -->
    <div class="main-content">
      <div class="canvas-wrapper">
        <div ref="canvasRef" class="canvas-container"></div>
      </div>
      <div class="right-panel">
        <h3>属性面板</h3>
        <!-- 根据选中的元素显示不同属性 -->
      </div>
    </div>
  </div>
</template>
```

---

## 4. 后端设计

### 4.1 核心类设计

#### ProcessController.java
```java
@RestController
@RequestMapping("/api/process")
public class ProcessController {

    @Autowired
    private ProcessService processService;

    /**
     * 发布流程
     */
    @PostMapping("/deploy")
    public ResponseEntity<ProcessDefinitionVO> deploy(
        @RequestBody DeployProcessRequest request
    ) {
        ProcessDefinitionVO result = processService.deploy(request);
        return ResponseEntity.ok(result);
    }

    /**
     * 查询流程定义列表
     */
    @GetMapping("/definitions")
    public ResponseEntity<PageResult<ProcessDefinitionVO>> getDefinitions(
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
    ) {
        PageResult<ProcessDefinitionVO> result = processService.getDefinitions(page, size);
        return ResponseEntity.ok(result);
    }

    /**
     * 获取流程定义 XML
     */
    @GetMapping("/definitions/{processDefinitionId}/xml")
    public ResponseEntity<ProcessDefinitionXmlVO> getProcessXml(
        @PathVariable String processDefinitionId
    ) {
        ProcessDefinitionXmlVO result = processService.getProcessXml(processDefinitionId);
        return ResponseEntity.ok(result);
    }
}
```

#### ProcessService.java
```java
@Service
public class ProcessService {

    @Autowired
    private RepositoryService repositoryService;

    @Autowired
    private ProcessSnapshotRepository snapshotRepository;

    /**
     * 发布流程
     */
    public ProcessDefinitionVO deploy(DeployProcessRequest request) {
        // 1. 验证 XML
        // 2. 部署到 Flowable
        // 3. 创建快照
        // 4. 返回流程定义信息
    }

    /**
     * 查询流程定义列表
     */
    public PageResult<ProcessDefinitionVO> getDefinitions(int page, int size) {
        List<ProcessDefinition> definitions = repositoryService
            .createProcessDefinitionQuery()
            .orderByProcessDefinitionVersion()
            .desc()
            .listPage((page - 1) * size, size);

        long total = repositoryService
            .createProcessDefinitionQuery()
            .count();

        // 转换为 VO
        return new PageResult<>(convertToVO(definitions), total);
    }
}
```

### 4.2 DTO 设计

#### DeployProcessRequest.java
```java
public class DeployProcessRequest {
    @NotBlank(message = "流程名称不能为空")
    private String name;

    private String description;

    @NotBlank(message = "流程XML不能为空")
    private String xml;
}
```

#### ProcessDefinitionVO.java
```java
public class ProcessDefinitionVO {
    private String id;
    private String key;
    private String name;
    private Integer version;
    private String description;
    private String deploymentId;
    private Boolean suspended;
}
```

#### ProcessSnapshotVO.java
```java
public class ProcessSnapshotVO {
    private String id;
    private String processDefinitionKey;
    private String snapshotName;
    private String snapshotVersion;
    private String description;
    private String creator;
    private LocalDateTime createdTime;
}
```

---

## 5. 开发任务清单

### Sprint 1（Week 1）
- [ ] 搭建流程设计器基础框架
- [ ] 实现 BPMN.js 初始化和配置
- [ ] 实现画布缩放功能
- [ ] 实现节点拖拽和连线功能
- [ ] 实现元素属性面板基础功能

### Sprint 2（Week 2）
- [ ] 实现流程发布功能
- [ ] 实现流程版本快照功能
- [ ] 实现流程导出功能
- [ ] 实现流程导入功能
- [ ] 完善错误处理和提示
- [ ] 编写单元测试
- [ ] 编写接口文档

---

## 6. 测试用例

### 6.1 功能测试

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-001 | 创建新流程 | 用户已登录 | 1. 点击新建流程<br>2. 拖拽添加开始节点<br>3. 拖拽添加用户任务<br>4. 连接节点 | 成功创建流程 |
| TC-002 | 发布流程 | 流程已设计完成 | 1. 输入流程名称<br>2. 点击发布按钮 | 流程发布成功，生成版本号 |
| TC-003 | 导出流程 | 流程已设计完成 | 1. 点击导出按钮<br>2. 保存文件 | 成功下载 BPMN XML 文件 |
| TC-004 | 创建快照 | 流程已发布 | 1. 点击快照菜单<br>2. 选择创建快照<br>3. 输入快照信息 | 快照创建成功 |
| TC-005 | 回滚到快照 | 存在历史快照 | 1. 查看快照列表<br>2. 点击回滚<br>3. 确认回滚 | 流程回滚到指定版本 |

### 6.2 异常测试

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-101 | 发布不完整流程 | 流程缺少结束节点 | 1. 设计不完整流程<br>2. 点击发布 | 提示流程不完整，无法发布 |
| TC-102 | 导入错误格式文件 | 无 | 1. 上传非 BPMN 文件 | 提示文件格式错误 |
| TC-103 | 流程名称重复 | 存在同名流程 | 1. 创建同名流程 | 提示名称冲突或自动生成新版本 |

---

## 7. 性能要求

- 流程设计器初始化时间 < 2 秒
- 拖拽节点响应时间 < 100ms
- 流程发布响应时间 < 3 秒
- 流程列表加载时间 < 1 秒
- 支持 1000+ 个流程定义

---

## 8. 依赖项

### 前端依赖
- bpmn-js: ^17.6.0
- bpmn-js-properties-panel: ^5.20.0
- element-plus: ^2.5.0

### 后端依赖
- flowable-spring-boot-starter: 7.0.1
- spring-boot-starter-web: 3.2.0

---

## 9. 风险与注意事项

1. **BPMN.js 定制化复杂**
   - 风险：属性面板定制可能需要大量自定义代码
   - 缓解：参考官方示例和社区案例

2. **流程验证复杂**
   - 风险：完整的流程验证规则较复杂
   - 缓解：先实现基础验证，逐步完善

3. **大流程性能**
   - 风险：复杂流程可能影响渲染性能
   - 缓解：考虑使用虚拟滚动或分模块设计

---

## 10. 后续优化

- [ ] 支持流程模板复制
- [ ] 支持流程搜索功能
- [ ] 支持流程预览模式
- [ ] 支持协作编辑（多人同时编辑）
- [ ] 支持流程推荐（基于历史数据）
