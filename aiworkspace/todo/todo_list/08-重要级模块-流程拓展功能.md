# 重要级模块 - 流程拓展功能

> 优先级：P1（重要级）
> 预计工期：1.5 周
> 依赖：流程实例管理、任务管理

## 1. 功能概述

流程拓展功能模块增强流程系统的扩展能力，包括邮件提醒、附件管理、密级过滤和审计日志等功能。

---

## 2. 功能需求

### 2.1 邮件提醒

#### 功能描述
配置邮件模板，在特定事件触发时发送邮件通知。

#### 功能点
1. **邮件模板管理**
   - 创建邮件模板
   - 编辑邮件模板
   - 删除邮件模板
   - 模板变量支持

2. **邮件类型**
   - 任务分配通知
   - 任务超时提醒
   - 流程完成通知
   - 流程异常通知

3. **发送配置**
   - SMTP 服务器配置
   - 发件人信息
   - 收件人规则
   - 发送时机

#### 邮件模板示例

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>任务分配通知</title>
</head>
<body>
    <h2>任务分配通知</h2>
    <p>尊敬的 ${userName}：</p>
    <p>您有一个新任务需要处理：</p>
    <ul>
        <li>任务名称：${taskName}</li>
        <li>流程名称：${processName}</li>
        <li>发起人：${startUser}</li>
        <li>截止时间：${dueDate}</li>
    </ul>
    <p>
        <a href="${taskUrl}">点击此处处理任务</a>
    </p>
</body>
</html>
```

#### 数据库设计

```sql
-- 邮件模板表
CREATE TABLE email_template (
  id VARCHAR(36) PRIMARY KEY,
  template_code VARCHAR(50) NOT NULL UNIQUE,
  template_name VARCHAR(100) NOT NULL,
  subject VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  variables TEXT,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 邮件发送记录表
CREATE TABLE email_send_log (
  id VARCHAR(36) PRIMARY KEY,
  template_code VARCHAR(50),
  recipients TEXT NOT NULL,
  subject VARCHAR(200),
  send_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  status VARCHAR(20) NOT NULL,
  error_message TEXT,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64)
);
```

#### API 接口

```java
// 保存邮件模板
POST /api/email/templates
Request: {
  templateCode: string,
  templateName: string,
  subject: string,
  content: string,
  variables: string[]
}
Response: void

// 发送测试邮件
POST /api/email/test
Request: {
  templateCode: string,
  recipient: string,
  variables: Map<string, object>
}
Response: void
```

---

### 2.2 附件管理

#### 功能描述
支持在流程中上传、查看和删除附件。

#### 功能点
1. **附件操作**
   - 上传附件
   - 下载附件
   - 删除附件
   - 预览附件

2. **附件关联**
   - 关联到流程实例
   - 关联到任务
   - 关联到评论

3. **权限控制**
   - 上传权限
   - 下载权限
   - 删除权限

#### 数据库设计

```sql
-- 附件表
CREATE TABLE process_attachment (
  id VARCHAR(36) PRIMARY KEY,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64),
  comment_id VARCHAR(64),
  file_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(50),
  storage_path VARCHAR(500) NOT NULL,
  uploader VARCHAR(100) NOT NULL,
  upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_process_instance (process_instance_id),
  INDEX idx_task (task_id)
);
```

#### API 接口

```java
// 上传附件
POST /api/attachments
Content-Type: multipart/form-data
Request: file
Response: {
  attachmentId: string,
  fileName: string,
  fileSize: number,
  uploadTime: LocalDateTime
}

// 获取流程附件列表
GET /api/attachments/process/{processInstanceId}
Response: List<AttachmentVO>

// 下载附件
GET /api/attachments/{attachmentId}/download
Response: File

// 删除附件
DELETE /api/attachments/{attachmentId}
Response: void
```

---

### 2.3 密级过滤

#### 功能描述
根据送审对象密级和人员密级进行过滤，控制流程访问权限。

#### 功能点
1. **密级定义**
   - 绝密
   - 机密
   - 秘密
   - 内部
   - 公开

2. **过滤规则**
   - 流程实例密级
   - 任务密级
   - 附件密级
   - 数据字段密级

3. **权限控制**
   - 用户密级设置
   - 角色密级设置
   - 组织密级设置

#### 数据库设计

```sql
-- 密级配置表
CREATE TABLE security_level (
  id INT PRIMARY KEY AUTO_INCREMENT,
  level_code VARCHAR(20) NOT NULL UNIQUE,
  level_name VARCHAR(50) NOT NULL,
  level_value INT NOT NULL,
  description TEXT
);

-- 用户密级表
CREATE TABLE user_security_level (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  security_level INT NOT NULL,
  grant_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  grantor VARCHAR(100),
  UNIQUE KEY uk_user (user_id)
);

-- 流程实例密级表
CREATE TABLE process_security_level (
  id VARCHAR(36) PRIMARY KEY,
  process_instance_id VARCHAR(64) NOT NULL UNIQUE,
  security_level INT NOT NULL,
  set_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  setter VARCHAR(100)
);
```

#### API 接口

```java
// 设置流程密级
POST /api/process-instances/{processInstanceId}/security-level
Request: {
  securityLevel: number
}
Response: void

// 检查访问权限
GET /api/process-instances/{processInstanceId}/check-access
Response: {
  hasAccess: boolean,
  reason?: string
}
```

---

### 2.4 审计日志

#### 功能描述
记录流程操作的详细日志，用于审计和追溯。

#### 功能点
1. **日志记录**
   - 所有流程操作
   - 所有任务操作
   - 数据变更记录
   - 系统操作记录

2. **日志内容**
   - 操作时间
   - 操作人
   - 操作类型
   - 操作对象
   - 操作结果
   - IP地址
   - 详细信息

3. **日志查询**
   - 按时间范围查询
   - 按操作人查询
   - 按操作类型查询
   - 按流程实例查询

#### 数据库设计

```sql
-- 审计日志表
CREATE TABLE audit_log (
  id VARCHAR(36) PRIMARY KEY,
  operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  operator VARCHAR(100) NOT NULL,
  operation_type VARCHAR(50) NOT NULL,
  operation_target VARCHAR(100),
  target_id VARCHAR(64),
  operation_result VARCHAR(20),
  ip_address VARCHAR(50),
  user_agent VARCHAR(500),
  request_url VARCHAR(500),
  request_params TEXT,
  response_data TEXT,
  error_message TEXT,
  INDEX idx_operation_time (operation_time),
  INDEX idx_operator (operator),
  INDEX idx_operation_type (operation_type),
  INDEX idx_target (operation_target, target_id)
);
```

#### API 接口

```java
// 查询审计日志
GET /api/audit-logs
Query Params:
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - operator: string
  - operationType: string
  - target: string
  - targetId: string
  - page: number
  - size: number
Response: PageResult<AuditLogVO>

// 导出审计日志
GET /api/audit-logs/export
Query Params: (同查询接口)
Response: File
```

---

## 3. 前端设计

### 3.1 邮件模板管理页面

```vue
<template>
  <div class="email-template-manager">
    <el-card>
      <template #header>
        <div class="header">
          <span>邮件模板管理</span>
          <el-button type="primary" @click="showCreateDialog">
            新建模板
          </el-button>
        </div>
      </template>

      <el-table :data="templates" stripe>
        <el-table-column prop="templateCode" label="模板代码" />
        <el-table-column prop="templateName" label="模板名称" />
        <el-table-column prop="subject" label="主题" />
        <el-table-column prop="variables" label="变量">
          <template #default="{ row }">
            <el-tag
              v-for="variable in row.variables"
              :key="variable"
              size="small"
            >
              {{ variable }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="status" label="状态">
          <template #default="{ row }">
            <el-tag :type="row.status === 'ACTIVE' ? 'success' : 'info'">
              {{ row.status === 'ACTIVE' ? '启用' : '禁用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200">
          <template #default="{ row }">
            <el-button size="small" @click="edit(row)">编辑</el-button>
            <el-button size="small" @click="test(row)">测试</el-button>
            <el-button size="small" type="danger" @click="remove(row)">
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- 编辑对话框 -->
    <el-dialog
      v-model="showEditDialog"
      :title="isEdit ? '编辑模板' : '新建模板'"
      width="800px"
    >
      <el-form :model="templateForm" label-width="100px">
        <el-form-item label="模板代码">
          <el-input v-model="templateForm.templateCode" />
        </el-form-item>
        <el-form-item label="模板名称">
          <el-input v-model="templateForm.templateName" />
        </el-form-item>
        <el-form-item label="邮件主题">
          <el-input v-model="templateForm.subject" />
        </el-form-item>
        <el-form-item label="模板内容">
          <rich-text-editor v-model="templateForm.content" />
        </el-form-item>
        <el-form-item label="可用变量">
          <el-input
            v-model="templateForm.variables"
            placeholder="多个变量用逗号分隔"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showEditDialog = false">取消</el-button>
        <el-button type="primary" @click="save">保存</el-button>
      </template>
    </el-dialog>
  </div>
</template>
```

### 3.2 附件管理组件

```vue
<template>
  <div class="attachment-manager">
    <el-upload
      :action="uploadUrl"
      :headers="uploadHeaders"
      :on-success="handleUploadSuccess"
      :on-remove="handleRemove"
      :file-list="fileList"
      multiple
    >
      <el-button type="primary">点击上传</el-button>
      <template #tip>
        <div class="el-upload__tip">
          支持多文件上传，单个文件不超过10MB
        </div>
      </template>
    </el-upload>

    <el-divider />

    <el-table :data="attachments" stripe>
      <el-table-column prop="fileName" label="文件名" />
      <el-table-column prop="fileSize" label="大小">
        <template #default="{ row }">
          {{ formatFileSize(row.fileSize) }}
        </template>
      </el-table-column>
      <el-table-column prop="uploader" label="上传人" />
      <el-table-column prop="uploadTime" label="上传时间" />
      <el-table-column label="操作" width="200">
        <template #default="{ row }">
          <el-button size="small" @click="download(row)">下载</el-button>
          <el-button size="small" @click="preview(row)">预览</el-button>
          <el-button size="small" type="danger" @click="remove(row)">
            删除
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

---

## 4. 后端设计

### 4.1 EmailService

```java
@Service
public class EmailService {

    @Autowired
    private JavaMailSender mailSender;

    @Autowired
    private EmailTemplateRepository templateRepository;

    @Autowired
    private EmailSendLogRepository sendLogRepository;

    /**
     * 发送邮件
     */
    @Async
    public void sendEmail(
        String templateCode,
        String[] recipients,
        Map<String, Object> variables,
        String processInstanceId,
        String taskId
    ) {
        try {
            // 1. 获取邮件模板
            EmailTemplate template = templateRepository
                .findByTemplateCode(templateCode)
                .orElseThrow(() -> new TemplateNotFoundException());

            // 2. 渲染邮件内容
            String subject = renderTemplate(template.getSubject(), variables);
            String content = renderTemplate(template.getContent(), variables);

            // 3. 发送邮件
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(
                message,
                true,
                "UTF-8"
            );

            helper.setTo(recipients);
            helper.setSubject(subject);
            helper.setText(content, true);

            mailSender.send(message);

            // 4. 记录发送日志
            emailSendLogRepository.save(EmailSendLog.builder()
                .templateCode(templateCode)
                .recipients(String.join(",", recipients))
                .subject(subject)
                .sendTime(LocalDateTime.now())
                .status("SUCCESS")
                .processInstanceId(processInstanceId)
                .taskId(taskId)
                .build());

        } catch (Exception e) {
            // 记录失败日志
            emailSendLogRepository.save(EmailSendLog.builder()
                .templateCode(templateCode)
                .recipients(String.join(",", recipients))
                .sendTime(LocalDateTime.now())
                .status("FAILED")
                .errorMessage(e.getMessage())
                .build());
        }
    }

    /**
     * 渲染模板
     */
    private String renderTemplate(String template, Map<String, Object> variables) {
        // 使用模板引擎渲染（如 Thymeleaf、FreeMarker）
        return templateEngine.process(template, variables);
    }
}
```

### 4.2 AttachmentService

```java
@Service
public class AttachmentService {

    @Value("${file.upload.path}")
    private String uploadPath;

    @Autowired
    private AttachmentRepository attachmentRepository;

    /**
     * 上传附件
     */
    public AttachmentVO upload(
        MultipartFile file,
        String processInstanceId,
        String taskId,
        String uploader
    ) {
        try {
            // 1. 生成文件路径
            String fileName = file.getOriginalFilename();
            String fileExtension = FilenameUtils.getExtension(fileName);
            String savedFileName = UUID.randomUUID() + "." + fileExtension;
            String relativePath = LocalDate.now().format(
                DateTimeFormatter.ofPattern("yyyy/MM/dd")
            ) + "/" + savedFileName;
            String fullPath = uploadPath + "/" + relativePath;

            // 2. 保存文件
            Files.createDirectories(Paths.get(fullPath).getParent());
            file.transferTo(new File(fullPath));

            // 3. 保存附件记录
            Attachment attachment = Attachment.builder()
                .id(UUID.randomUUID().toString())
                .processInstanceId(processInstanceId)
                .taskId(taskId)
                .fileName(fileName)
                .fileSize(file.getSize())
                .fileType(fileExtension)
                .storagePath(fullPath)
                .uploader(uploader)
                .uploadTime(LocalDateTime.now())
                .build();

            attachmentRepository.save(attachment);

            return convertToVO(attachment);

        } catch (IOException e) {
            throw new FileUploadException();
        }
    }

    /**
     * 下载附件
     */
    public ResponseEntity<Resource> download(String attachmentId) {
        Attachment attachment = attachmentRepository.findById(attachmentId)
            .orElseThrow(() -> new AttachmentNotFoundException());

        Resource resource = new FileSystemResource(attachment.getStoragePath());

        return ResponseEntity.ok()
            .header(
                "Content-Disposition",
                "attachment; filename=\"" + attachment.getFileName() + "\""
            )
            .body(resource);
    }
}
```

---

## 5. 开发任务清单

### Sprint 7（Week 7）
- [ ] 实现邮件模板管理
- [ ] 实现邮件发送功能
- [ ] 实现附件上传下载
- [ ] 实现密级过滤

### Sprint 8（Week 8）
- [ ] 实现审计日志记录
- [ ] 实现审计日志查询
- [ ] 实现审计日志导出
- [ ] 编写单元测试

---

## 6. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-801 | 发送邮件通知 | 配置了邮件模板 | 1. 触发任务分配事件 | 收到邮件通知 |
| TC-802 | 上传附件 | 流程运行中 | 1. 选择文件<br>2. 点击上传 | 附件上传成功 |
| TC-803 | 密级过滤 | 设置了流程密级 | 1. 低密级用户访问高密级流程 | 拒绝访问 |
| TC-804 | 查询审计日志 | 有操作记录 | 1. 设置查询条件<br>2. 查询 | 显示符合条件的日志 |

---

## 7. 性能要求

- 邮件发送不影响主流程（异步）
- 附件上传支持断点续传
- 附件下载支持限速
- 审计日志写入性能 < 100ms
- 审计日志查询支持分页
