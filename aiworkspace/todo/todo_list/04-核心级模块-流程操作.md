# 核心级模块 - 流程操作

> 优先级：P0（核心级）
> 预计工期：1.5 周
> 依赖：任务管理、流程实例管理

## 1. 功能概述

流程操作模块提供流程执行过程中的各种操作功能，包括任务提交、转办、委托、会签、加签/减签等核心操作。

---

## 2. 功能需求

### 2.1 任务提交

#### 功能描述
用户完成当前任务后，将流程推进到下一个节点。

#### 功能点
1. **提交操作**
   - 填写审批意见
   - 选择流程路径（多网关时）
   - 设置下一步处理人（可选）
   - 上传附件（可选）

2. **提交验证**
   - 验证必填项
   - 验证表单数据
   - 验证流程流转规则

3. **提交后处理**
   - 更新任务状态
   - 创建下一节点任务
   - 发送通知
   - 记录操作日志

#### API 接口
```java
// 提交任务
POST /api/tasks/{taskId}/complete
Request: {
  comment: string,
  variables?: Map<string, object>,
  attachments?: Attachment[]
}
Response: void
```

---

### 2.2 转办

#### 功能描述
将当前任务转交给其他用户处理。

#### 功能点
1. **转办操作**
   - 选择转办人
   - 填写转办原因
   - 转办确认

2. **转办限制**
   - 仅可转办给有权限的用户
   - 转办后原处理人无法操作

#### API 接口
```java
// 转办任务
POST /api/tasks/{taskId}/transfer
Request: {
  targetUser: string,
  reason: string
}
Response: void
```

---

### 2.3 委托

#### 功能描述
临时将任务委托给其他用户，委托人完成任务后自动返回。

#### 功能点
1. **委托操作**
   - 选择受托人
   - 设置委托期限
   - 填写委托原因

2. **委托管理**
   - 查看我的委托
   - 查看委托给我的任务
   - 撤销委托

#### API 接口
```java
// 委托任务
POST /api/tasks/{taskId}/delegate
Request: {
  targetUser: string,
  dueDate?: LocalDateTime,
  reason: string
}
Response: void

// 撤销委托
POST /api/tasks/{taskId}/delegate/revoke
Response: void
```

---

### 2.4 会签

#### 功能描述
多个用户并行审批同一任务，所有人都审批通过后流程才继续。

#### 功能点
1. **会签设置**
   - 在流程设计时配置会签节点
   - 设置会签人员
   - 设置会签规则（全部通过/任意通过/比例通过）

2. **会签处理**
   - 每个会签人独立处理
   - 实时显示会签进度
   - 会签结果自动汇总

#### 数据库设计
```sql
-- 会签记录表
CREATE TABLE countersign_record (
  id VARCHAR(36) PRIMARY KEY,
  task_id VARCHAR(64) NOT NULL,
  assignee VARCHAR(100) NOT NULL,
  status VARCHAR(20) NOT NULL,
  comment TEXT,
  approve_time TIMESTAMP,
  INDEX idx_task (task_id),
  INDEX idx_assignee (assignee)
);
```

#### API 接口
```java
// 查询会签任务
GET /api/tasks/{taskId}/countersign
Response: List<CountersignRecordVO>

// 提交会签
POST /api/tasks/{taskId}/countersign
Request: {
  approved: boolean,
  comment: string
}
Response: void
```

---

### 2.5 加签/减签

#### 功能描述
动态增加或减少当前任务的审批人。

#### 功能点
1. **加签操作**
   - 选择新增审批人
   - 设置加签类型（前置/后置/并行）
   - 填写加签原因

2. **减签操作**
   - 选择要移除的审批人
   - 填写减签原因
   - 减签确认

3. **加签类型说明**
   - 前置加签：新增人员先审批，然后原处理人审批
   - 后置加签：原处理人先审批，然后新增人员审批
   - 并行加签：新增人员和原处理人并行审批

#### API 接口
```java
// 加签
POST /api/tasks/{taskId}/add-assignee
Request: {
  users: string[],
  type: 'before' | 'after' | 'parallel',
  reason: string
}
Response: void

// 减签
POST /api/tasks/{taskId}/remove-assignee
Request: {
  users: string[],
  reason: string
}
Response: void
```

---

## 3. 前端设计

### 3.1 任务办理页面

```vue
<template>
  <div class="task-detail">
    <!-- 任务基本信息 -->
    <el-card class="task-info">
      <el-descriptions title="任务信息" :column="2">
        <el-descriptions-item label="任务名称">
          {{ task.taskName }}
        </el-descriptions-item>
        <el-descriptions-item label="优先级">
          <el-tag :type="getPriorityType(task.priority)">
            {{ getPriorityText(task.priority) }}
          </el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="发起人">
          {{ task.startUser }}
        </el-descriptions-item>
        <el-descriptions-item label="到达时间">
          {{ task.createTime }}
        </el-descriptions-item>
        <el-descriptions-item label="截止时间">
          {{ task.dueDate }}
        </el-descriptions-item>
      </el-descriptions>
    </el-card>

    <!-- 表单数据 -->
    <el-card class="form-data">
      <template #header>
        <span>表单数据</span>
      </template>
      <component
        :is="formComponent"
        v-model="formData"
        :readonly="true"
      />
    </el-card>

    <!-- 流程图 -->
    <el-card class="process-diagram">
      <template #header>
        <span>流程图</span>
      </template>
      <ProcessDiagramViewer
        :process-instance-id="task.processInstanceId"
        :current-task-id="task.id"
      />
    </el-card>

    <!-- 操作区域 -->
    <el-card class="actions">
      <template #header>
        <span>处理任务</span>
      </template>

      <!-- 审批意见 -->
      <el-form :model="actionForm" label-width="100px">
        <el-form-item label="审批意见" required>
          <el-input
            v-model="actionForm.comment"
            type="textarea"
            :rows="4"
            placeholder="请输入审批意见"
          />
        </el-form-item>

        <!-- 附件上传 -->
        <el-form-item label="附件">
          <el-upload
            :action="uploadUrl"
            :headers="uploadHeaders"
            :on-success="handleUploadSuccess"
            :file-list="actionForm.attachments"
          >
            <el-button type="primary">点击上传</el-button>
          </el-upload>
        </el-form-item>

        <!-- 流程路径选择（多网关时） -->
        <el-form-item v-if="hasMultipleOutgoing" label="下一步">
          <el-radio-group v-model="actionForm.outgoing">
            <el-radio
              v-for="outgoing in outgoingFlows"
              :key="outgoing.id"
              :label="outgoing.id"
            >
              {{ outgoing.name }}
            </el-radio>
          </el-radio-group>
        </el-form-item>

        <!-- 操作按钮 -->
        <el-form-item>
          <el-button type="primary" @click="complete">
            提交
          </el-button>
          <el-button @click="showTransferDialog = true">
            转办
          </el-button>
          <el-button @click="showDelegateDialog = true">
            委托
          </el-button>
          <el-button type="danger" @click="reject">
            驳回
          </el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 转办对话框 -->
    <el-dialog v-model="showTransferDialog" title="转办">
      <el-form :model="transferForm">
        <el-form-item label="转办给" required>
          <user-selector v-model="transferForm.targetUser" />
        </el-form-item>
        <el-form-item label="转办原因">
          <el-input
            v-model="transferForm.reason"
            type="textarea"
            :rows="3"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showTransferDialog = false">取消</el-button>
        <el-button type="primary" @click="transfer">确定</el-button>
      </template>
    </el-dialog>

    <!-- 委托对话框 -->
    <el-dialog v-model="showDelegateDialog" title="委托">
      <el-form :model="delegateForm">
        <el-form-item label="委托给" required>
          <user-selector v-model="delegateForm.targetUser" />
        </el-form-item>
        <el-form-item label="委托期限">
          <el-date-picker
            v-model="delegateForm.dueDate"
            type="datetime"
            placeholder="选择到期时间"
          />
        </el-form-item>
        <el-form-item label="委托原因">
          <el-input
            v-model="delegateForm.reason"
            type="textarea"
            :rows="3"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="showDelegateDialog = false">取消</el-button>
        <el-button type="primary" @click="delegate">确定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import {
  getTaskDetail,
  completeTask,
  transferTask,
  delegateTask
} from '@/api/task'

const route = useRoute()
const taskId = route.params.taskId as string

const task = ref({})
const formData = ref({})
const actionForm = ref({
  comment: '',
  attachments: [],
  outgoing: ''
})

// 提交任务
const complete = async () => {
  if (!actionForm.value.comment) {
    ElMessage.warning('请填写审批意见')
    return
  }

  await completeTask(taskId, {
    comment: actionForm.value.comment,
    variables: formData.value,
    attachments: actionForm.value.attachments
  })

  ElMessage.success('提交成功')
  // 跳转回待办列表
}

// 转办
const transfer = async () => {
  await transferTask(taskId, transferForm.value)
  ElMessage.success('转办成功')
  showTransferDialog.value = false
}

// 委托
const delegate = async () => {
  await delegateTask(taskId, delegateForm.value)
  ElMessage.success('委托成功')
  showDelegateDialog.value = false
}

onMounted(() => {
  loadTaskDetail()
})
</script>
```

---

## 4. 后端设计

### 4.1 ProcessOperationService

```java
@Service
public class ProcessOperationService {

    @Autowired
    private TaskService taskService;

    @Autowired
    private RuntimeService runtimeService;

    @Autowired
    private HistoryService historyService;

    /**
     * 提交任务
     */
    @Transactional
    public void complete(String taskId, CompleteTaskRequest request) {
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();

        if (task == null) {
            throw new TaskNotFoundException();
        }

        // 1. 设置流程变量
        Map<String, Object> variables = request.getVariables();
        if (variables != null) {
            runtimeService.setVariables(
                task.getProcessInstanceId(),
                variables
            );
        }

        // 2. 添加审批意见
        taskService.addComment(
            taskId,
            task.getProcessInstanceId(),
            request.getComment()
        );

        // 3. 处理附件
        if (request.getAttachments() != null) {
            saveAttachments(taskId, request.getAttachments());
        }

        // 4. 完成任务
        taskService.complete(taskId, variables);

        // 5. 记录操作日志
        recordOperationLog(task, "COMPLETE", request.getComment());
    }

    /**
     * 转办任务
     */
    @Transactional
    public void transfer(String taskId, TransferRequest request) {
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();

        if (task == null) {
            throw new TaskNotFoundException();
        }

        // 1. 验证目标用户
        if (!isValidUser(request.getTargetUser())) {
            throw new InvalidUserException();
        }

        // 2. 执行转办
        taskService.setAssignee(taskId, request.getTargetUser());

        // 3. 添加转办记录
        taskService.addComment(
            taskId,
            task.getProcessInstanceId(),
            "转办给 " + request.getTargetUser() + "，原因：" + request.getReason()
        );

        // 4. 记录操作日志
        recordOperationLog(task, "TRANSFER", request.getReason());
    }

    /**
     * 委托任务
     */
    @Transactional
    public void delegate(String taskId, DelegateRequest request) {
        Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .singleResult();

        if (task == null) {
            throw new TaskNotFoundException();
        }

        // 1. 保存原处理人
        String originalAssignee = task.getAssignee();

        // 2. 设置受托人
        taskService.setOwner(taskId, originalAssignee);
        taskService.setAssignee(taskId, request.getTargetUser());

        // 3. 保存委托记录
        saveDelegateRecord(taskId, originalAssignee, request);

        // 4. 添加评论
        taskService.addComment(
            taskId,
            task.getProcessInstanceId(),
            "委托给 " + request.getTargetUser() + "，原因：" + request.getReason()
        );
    }
}
```

---

## 5. 开发任务清单

### Sprint 4（Week 4）
- [ ] 实现任务提交功能
- [ ] 实现转办功能
- [ ] 实现委托功能

### Sprint 5（Week 5）
- [ ] 实现会签功能
- [ ] 实现加签/减签功能
- [ ] 完善操作日志
- [ ] 编写单元测试

---

## 6. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-401 | 提交任务 | 用户有待办任务 | 1. 填写审批意见<br>2. 点击提交 | 任务完成，流程流转到下一节点 |
| TC-402 | 转办任务 | 用户有待办任务 | 1. 选择转办人<br>2. 填写原因<br>3. 确认 | 任务转办成功，新处理人可操作 |
| TC-403 | 委托任务 | 用户有待办任务 | 1. 选择受托人<br>2. 设置期限<br>3. 确认 | 任务委托成功 |
| TC-404 | 会签处理 | 多人会签任务 | 1. 各会签人分别审批 | 所有人审批通过后流程继续 |

---

## 7. 性能要求

- 任务提交响应时间 < 2 秒
- 转办/委托响应时间 < 1 秒
- 会签进度实时更新
