# 核心级模块 - 任务管理

> 优先级：P0（核心级）
> 预计工期：1.5 周
> 依赖：流程实例管理

## 1. 功能概述

任务管理模块是流程系统与用户交互最频繁的模块，负责展示和处理用户的待办任务、已办任务和发起的流程。

---

## 2. 功能需求

### 2.1 我的待办

#### 功能描述
展示当前用户需要处理的任务列表。

#### 用户故事
作为一个业务用户，我希望能够看到我的所有待办任务，以便及时处理工作。

#### 功能点
1. **任务列表**
   - 显示任务基本信息
   - 任务优先级标识
   - 任务截止时间
   - 任务来源流程
   - 任务到达时间

2. **任务筛选**
   - 按流程类型筛选
   - 按优先级筛选
   - 按截止时间筛选
   - 按任务名称搜索

3. **任务排序**
   - 按优先级排序
   - 按到达时间排序
   - 按截止时间排序

4. **任务统计**
   - 待办总数
   - 高优先级任务数
   - 即将超时任务数
   - 已超时任务数

#### 验收标准
- ✅ 显示当前用户的所有待办任务
- ✅ 不显示其他用户的任务
- ✅ 任务信息完整准确
- ✅ 支持多条件筛选
- ✅ 列表响应流畅

#### API 接口
```java
// 查询我的待办
GET /api/tasks/todo
Query Params:
  - processDefinitionKey: string
  - priority: number
  - taskName: string
  - overdue: boolean
  - page: number
  - size: number
Response: PageResult<TaskVO>

// 待办统计
GET /api/tasks/todo/statistics
Response: {
  total: number,
  highPriority: number,
  nearingDeadline: number,
  overdue: number
}
```

---

### 2.2 我的已办

#### 功能描述
展示当前用户已经处理完的任务列表。

#### 用户故事
作为一个业务用户，我希望能够查看我处理过的任务，以便追溯工作历史。

#### 功能点
1. **已办列表**
   - 任务基本信息
   - 处理时间
   - 处理结果（通过/驳回/转办等）
   - 处理意见
   - 流程当前状态

2. **查询筛选**
   - 按流程类型筛选
   - 按处理时间范围筛选
   - 按处理结果筛选
   - 按任务名称搜索

3. **流程跟踪**
   - 查看任务所属流程
   - 查看流程当前进度
   - 查看后续节点

#### 验收标准
- ✅ 显示当前用户的所有已办任务
- ✅ 处理信息完整准确
- ✅ 可以查看任务所属流程
- ✅ 支持多条件查询

#### API 接口
```java
// 查询我的已办
GET /api/tasks/done
Query Params:
  - processDefinitionKey: string
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - taskName: string
  - page: number
  - size: number
Response: PageResult<TaskVO>
```

---

### 2.3 我发起的

#### 功能描述
展示当前用户发起的所有流程实例。

#### 用户故事
作为一个业务用户，我希望能够查看我发起的流程，以便跟踪流程进展。

#### 功能点
1. **发起流程列表**
   - 流程基本信息
   - 流程状态
   - 当前节点
   - 发起时间
   - 流程进度

2. **流程操作**
   - 查看流程详情
   - 撤回流程（仅特定条件）
   - 催办（提醒当前处理人）

3. **状态筛选**
   - 按流程类型筛选
   - 按状态筛选
   - 按发起时间筛选

#### 验收标准
- ✅ 显示当前用户发起的所有流程
- ✅ 流程状态实时更新
- ✅ 可以查看流程详情
- ✅ 支持催办功能

#### API 接口
```java
// 查询我发起的流程
GET /api/process-instances/my
Query Params:
  - processDefinitionKey: string
  - status: string
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - page: number
  - size: number
Response: PageResult<ProcessInstanceVO>

// 催办
POST /api/process-instances/{processInstanceId}/urge
Request: {
  message: string
}
Response: void
```

---

### 2.4 高级搜索

#### 功能描述
提供多条件组合查询功能，满足复杂的查询需求。

#### 功能点
1. **待办搜索**
   - 任务名称（模糊搜索）
   - 流程类型
   - 优先级范围
   - 到达时间范围
   - 截止时间范围
   - 发起人
   - 包含已完成

2. **已办搜索**
   - 任务名称
   - 流程类型
   - 处理时间范围
   - 处理结果
   - 处理人（管理员可搜所有人）

3. **发起流程搜索**
   - 流程名称
   - 流程类型
   - 发起时间范围
   - 流程状态
   - 业务Key

4. **搜索保存**
   - 保存常用搜索条件
   - 快速应用保存的搜索
   - 删除保存的搜索

#### 验收标准
- ✅ 支持多条件组合查询
- ✅ 查询结果准确
- ✅ 可以保存和复用搜索条件
- ✅ 复杂查询响应时间 < 3 秒

---

## 3. 前端设计

### 3.1 页面结构

```
任务管理
├── 我的待办页面 (Todo.vue)
│   ├── 统计卡片
│   │   ├── 待办总数
│   │   ├── 高优先级
│   │   ├── 即将超时
│   │   └── 已超时
│   ├── 搜索栏
│   ├── 快速筛选标签
│   └── 任务列表
│       ├── 任务信息
│       ├── 优先级标识
│       ├── 截止时间倒计时
│       └── 操作按钮
├── 我的已办页面 (Done.vue)
│   ├── 搜索栏
│   ├── 时间范围选择
│   └── 已办列表
└── 我发起的页面 (MyProcess.vue)
    ├── 搜索栏
    ├── 状态筛选
    └── 流程列表
```

### 3.2 核心组件

#### TodoList.vue - 待办任务列表
```typescript
<template>
  <div class="todo-list">
    <!-- 统计卡片 -->
    <el-row :gutter="16" class="statistics">
      <el-col :span="6">
        <el-card class="stat-card">
          <div class="stat-number">{{ statistics.total }}</div>
          <div class="stat-label">待办总数</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card high-priority">
          <div class="stat-number">{{ statistics.highPriority }}</div>
          <div class="stat-label">高优先级</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card warning">
          <div class="stat-number">{{ statistics.nearingDeadline }}</div>
          <div class="stat-label">即将超时</div>
        </el-card>
      </el-col>
      <el-col :span="6">
        <el-card class="stat-card danger">
          <div class="stat-number">{{ statistics.overdue }}</div>
          <div class="stat-label">已超时</div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 搜索和筛选 -->
    <el-form :model="searchForm" inline class="search-form">
      <el-form-item>
        <el-input
          v-model="searchForm.taskName"
          placeholder="任务名称"
          clearable
        />
      </el-form-item>
      <el-form-item>
        <el-select v-model="searchForm.processDefinitionKey" placeholder="流程类型">
          <el-option label="全部" value="" />
          <el-option
            v-for="def in processDefinitions"
            :key="def.key"
            :label="def.name"
            :value="def.key"
          />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-select v-model="searchForm.priority" placeholder="优先级">
          <el-option label="全部" value="" />
          <el-option label="高" :value="80" />
          <el-option label="中" :value="50" />
          <el-option label="低" :value="20" />
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="search">查询</el-button>
        <el-button @click="reset">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 快速筛选 -->
    <div class="quick-filters">
      <el-radio-group v-model="quickFilter" @change="handleQuickFilter">
        <el-radio-button label="">全部</el-radio-button>
        <el-radio-button label="high">高优先级</el-radio-button>
        <el-radio-button label="overdue">已超时</el-radio-button>
        <el-radio-button label="nearing">即将超时</el-radio-button>
      </el-radio-group>
    </div>

    <!-- 任务列表 -->
    <el-table :data="tasks" stripe>
      <el-table-column label="优先级" width="80">
        <template #default="{ row }">
          <el-tag :type="getPriorityType(row.priority)">
            {{ getPriorityText(row.priority) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="taskName" label="任务名称" />
      <el-table-column prop="processName" label="来源流程" />
      <el-table-column prop="startUser" label="发起人" />
      <el-table-column label="截止时间" width="180">
        <template #default="{ row }">
          <div :class="getDeadlineClass(row)">
            {{ formatDate(row.dueDate) }}
            <el-countdown
              v-if="isNearingDeadline(row)"
              :value="row.dueDate"
              format="HH:mm:ss"
              @finish="handleTaskOverdue(row)"
            />
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="createTime" label="到达时间" width="180" />
      <el-table-column label="操作" width="200" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleTask(row)">
            办理
          </el-button>
          <el-button size="small" @click="delegate(row)">
            委托
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页 -->
    <el-pagination
      v-model:current-page="pagination.page"
      v-model:page-size="pagination.size"
      :total="pagination.total"
      @current-change="loadTasks"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { getTodoTasks, getTodoStatistics } from '@/api/task'

const router = useRouter()
const tasks = ref([])
const statistics = ref({
  total: 0,
  highPriority: 0,
  nearingDeadline: 0,
  overdue: 0
})

const loadTasks = async () => {
  const { data } = await getTodoTasks({
    ...searchForm.value,
    page: pagination.value.page,
    size: pagination.value.size
  })
  tasks.value = data.list
  pagination.value.total = data.total
}

const loadStatistics = async () => {
  const { data } = await getTodoStatistics()
  statistics.value = data
}

const handleTask = (task: TaskVO) => {
  router.push({
    name: 'TaskDetail',
    params: { taskId: task.id }
  })
}

onMounted(() => {
  loadStatistics()
  loadTasks()
})
</script>
```

---

## 4. 后端设计

### 4.1 核心类设计

#### TaskController.java
```java
@RestController
@RequestMapping("/api/tasks")
public class TaskController {

    @Autowired
    private TaskService taskService;

    /**
     * 查询我的待办
     */
    @GetMapping("/todo")
    public ResponseEntity<PageResult<TaskVO>> getTodoTasks(
        @RequestParam(required = false) String processDefinitionKey,
        @RequestParam(required = false) Integer priority,
        @RequestParam(required = false) String taskName,
        @RequestParam(required = false) Boolean overdue,
        @AuthenticationPrincipal String username,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
    ) {
        PageResult<TaskVO> result = taskService.getTodoTasks(
            username, processDefinitionKey, priority, taskName, overdue, page, size
        );
        return ResponseEntity.ok(result);
    }

    /**
     * 待办统计
     */
    @GetMapping("/todo/statistics")
    public ResponseEntity<TaskStatisticsVO> getTodoStatistics(
        @AuthenticationPrincipal String username
    ) {
        TaskStatisticsVO result = taskService.getTodoStatistics(username);
        return ResponseEntity.ok(result);
    }

    /**
     * 查询我的已办
     */
    @GetMapping("/done")
    public ResponseEntity<PageResult<TaskVO>> getDoneTasks(
        @RequestParam(required = false) String processDefinitionKey,
        @RequestParam(required = false) LocalDateTime startTime,
        @RequestParam(required = false) LocalDateTime endTime,
        @RequestParam(required = false) String taskName,
        @AuthenticationPrincipal String username,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
    ) {
        PageResult<TaskVO> result = taskService.getDoneTasks(
            username, processDefinitionKey, startTime, endTime, taskName, page, size
        );
        return ResponseEntity.ok(result);
    }
}
```

#### TaskService.java
```java
@Service
public class TaskService {

    @Autowired
    private TaskService taskService;

    @Autowired
    private HistoryService historyService;

    /**
     * 查询我的待办
     */
    public PageResult<TaskVO> getTodoTasks(
        String username,
        String processDefinitionKey,
        Integer priority,
        String taskName,
        Boolean overdue,
        int page,
        int size
    ) {
        // 1. 构建查询条件
        TaskQuery query = taskService.createTaskQuery()
            .taskAssignee(username)
            .orderByTaskCreateTime()
            .desc();

        if (StringUtils.hasText(processDefinitionKey)) {
            query.processDefinitionKey(processDefinitionKey);
        }

        if (priority != null) {
            query.taskPriority(priority);
        }

        if (StringUtils.hasText(taskName)) {
            query.taskNameLike("%" + taskName + "%");
        }

        // 2. 查询总数
        long total = query.count();

        // 3. 分页查询
        List<Task> tasks = query.listPage((page - 1) * size, size);

        // 4. 过滤超时任务（如果需要）
        List<TaskVO> vos = tasks.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());

        if (overdue != null && overdue) {
            vos = vos.stream()
                .filter(vo -> vo.getDueDate() != null &&
                        vo.getDueDate().isBefore(LocalDateTime.now()))
                .collect(Collectors.toList());
        }

        return new PageResult<>(vos, total);
    }

    /**
     * 待办统计
     */
    public TaskStatisticsVO getTodoStatistics(String username) {
        List<Task> tasks = taskService.createTaskQuery()
            .taskAssignee(username)
            .list();

        TaskStatisticsVO statistics = new TaskStatisticsVO();
        statistics.setTotal(tasks.size());

        LocalDateTime now = LocalDateTime.now();

        for (Task task : tasks) {
            // 高优先级任务
            if (task.getPriority() >= 80) {
                statistics.setHighPriority(
                    statistics.getHighPriority() + 1
                );
            }

            // 超时和即将超时
            Date dueDate = task.getDueDate();
            if (dueDate != null) {
                LocalDateTime dueDateTime = convertToLocalDateTime(dueDate);
                if (dueDateTime.isBefore(now)) {
                    statistics.setOverdue(statistics.getOverdue() + 1);
                } else if (dueDateTime.isBefore(now.plusHours(24))) {
                    statistics.setNearingDeadline(
                        statistics.getNearingDeadline() + 1
                    );
                }
            }
        }

        return statistics;
    }

    /**
     * 查询我的已办
     */
    public PageResult<TaskVO> getDoneTasks(
        String username,
        String processDefinitionKey,
        LocalDateTime startTime,
        LocalDateTime endTime,
        String taskName,
        int page,
        int size
    ) {
        HistoricTaskInstanceQuery query = historyService
            .createHistoricTaskInstanceQuery()
            .taskAssignee(username)
            .finished()
            .orderByHistoricTaskInstanceEndTime()
            .desc();

        if (StringUtils.hasText(processDefinitionKey)) {
            query.processDefinitionKey(processDefinitionKey);
        }

        if (startTime != null) {
            query.taskCompletedAfter(startTime);
        }

        if (endTime != null) {
            query.taskCompletedBefore(endTime);
        }

        if (StringUtils.hasText(taskName)) {
            query.taskNameLike("%" + taskName + "%");
        }

        long total = query.count();
        List<HistoricTaskInstance> tasks = query.listPage((page - 1) * size, size);

        List<TaskVO> vos = tasks.stream()
            .map(this::convertToVO)
            .collect(Collectors.toList());

        return new PageResult<>(vos, total);
    }
}
```

---

## 5. 数据模型

### 5.1 TaskVO
```java
public class TaskVO {
    private String id;
    private String taskName;
    private String processInstanceId;
    private String processDefinitionId;
    private String processName;
    private String businessKey;
    private String assignee;
    private Integer priority;
    private LocalDateTime dueDate;
    private LocalDateTime createTime;
    private String startUser;
    private Boolean overdue;
}
```

### 5.2 TaskStatisticsVO
```java
public class TaskStatisticsVO {
    private Integer total;
    private Integer highPriority;
    private Integer nearingDeadline;
    private Integer overdue;
}
```

---

## 6. 开发任务清单

### Sprint 3（Week 3）
- [ ] 实现我的待办功能
- [ ] 实现待办统计
- [ ] 实现我的已办功能
- [ ] 实现任务搜索

### Sprint 4（Week 4）
- [ ] 实现我发起的流程
- [ ] 实现催办功能
- [ ] 优化列表性能
- [ ] 编写单元测试

---

## 7. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-301 | 查看待办 | 用户有待办任务 | 1. 打开待办页面 | 显示所有待办任务 |
| TC-302 | 按优先级筛选 | 用户有待办任务 | 1. 选择高优先级<br>2. 查询 | 仅显示高优先级任务 |
| TC-303 | 查看已办 | 用户有已办任务 | 1. 打开已办页面 | 显示所有已办任务 |
| TC-304 | 查看发起的流程 | 用户发起过流程 | 1. 打开我的流程 | 显示发起的流程列表 |
| TC-305 | 催办 | 流程运行中 | 1. 点击催办<br>2. 输入消息 | 当前处理人收到通知 |

---

## 8. 性能要求

- 待办列表加载 < 1 秒
- 已办列表加载 < 1.5 秒
- 支持 10000+ 任务查询
- 统计数据实时更新

---

## 9. 依赖项

- Flowable TaskService
- Flowable HistoryService
- 流程实例管理模块
