# 重要级模块 - 流程统计分析

> 优先级：P1（重要级）
> 预计工期：1.5 周
> 依赖：流程实例管理、任务管理

## 1. 功能概述

流程统计分析模块提供流程运行数据的分析能力，帮助管理者了解流程执行情况、发现瓶颈、优化流程。

---

## 2. 功能需求

### 2.1 流程实例统计

#### 功能描述
按组织、用户、状态等维度统计流程实例。

#### 统计维度
1. **按组织统计**
   - 各组织发起的流程数
   - 各组织流程完成率
   - 各组织流程平均耗时

2. **按用户统计**
   - 用户发起的流程数
   - 用户流程完成率
   - 用户流程平均耗时

3. **按状态统计**
   - 运行中流程数
   - 已完成流程数
   - 已终止流程数
   - 已挂起流程数

4. **按时间统计**
   - 日趋势
   - 周趋势
   - 月趋势
   - 年趋势

#### API 接口
```java
// 流程实例统计
GET /api/statistics/process-instances
Query Params:
  - dimension: 'organization' | 'user' | 'status' | 'time'
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - interval: 'day' | 'week' | 'month' | 'year'
Response: ProcessInstanceStatisticsVO

// 流程实例趋势图
GET /api/statistics/process-instances/trend
Query Params:
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - interval: 'day' | 'week' | 'month'
Response: TrendChartVO
```

#### 前端展示

```vue
<template>
  <div class="process-instance-stats">
    <!-- 统计卡片 -->
    <el-row :gutter="16">
      <el-col :span="6">
        <stat-card title="总流程数" :value="stats.total" />
      </el-col>
      <el-col :span="6">
        <stat-card title="运行中" :value="stats.running" />
      </el-col>
      <el-col :span="6">
        <stat-card title="已完成" :value="stats.completed" />
      </el-col>
      <el-col :span="6">
        <stat-card title="完成率" :value="stats.completionRate" suffix="%" />
      </el-col>
    </el-row>

    <!-- 维度选择 -->
    <el-radio-group v-model="dimension" @change="loadStats">
      <el-radio-button label="organization">按组织</el-radio-button>
      <el-radio-button label="user">按用户</el-radio-button>
      <el-radio-button label="status">按状态</el-radio-button>
      <el-radio-button label="time">按时间</el-radio-button>
    </el-radio-group>

    <!-- 图表展示 -->
    <div v-if="dimension === 'time'" class="chart-container">
      <line-chart :data="trendData" />
    </div>

    <div v-else class="table-container">
      <el-table :data="statsDetail" stripe>
        <el-table-column prop="name" label="名称" />
        <el-table-column prop="count" label="数量" />
        <el-table-column prop="rate" label="占比" />
        <el-table-column prop="avgDuration" label="平均耗时" />
      </el-table>
    </div>
  </div>
</template>
```

---

### 2.2 流程耗时统计

#### 功能描述
统计流程的执行耗时，发现性能瓶颈。

#### 统计内容
1. **平均耗时**
   - 流程整体平均耗时
   - 各节点平均耗时
   - 各组织流程平均耗时

2. **耗时分布**
   - < 1小时
   - 1-6小时
   - 6-24小时
   - 1-3天
   - > 3天

3. **超时统计**
   - 超时流程数
   - 超时率
   - 超时节点分布

#### 数据库设计
```sql
-- 流程耗时统计视图
CREATE VIEW process_duration_stats AS
SELECT
    pd.process_definition_key,
    pd.name AS process_name,
    COUNT(*) AS instance_count,
    AVG(TIMESTAMPDIFF(MINUTE, pi.start_time, pi.end_time)) AS avg_duration_minutes,
    MAX(TIMESTAMPDIFF(MINUTE, pi.start_time, pi.end_time)) AS max_duration_minutes,
    MIN(TIMESTAMPDIFF(MINUTE, pi.start_time, pi.end_time)) AS min_duration_minutes
FROM process_instance pi
JOIN process_definition pd ON pi.process_definition_id = pd.id
WHERE pi.end_time IS NOT NULL
GROUP BY pd.process_definition_key, pd.name;
```

---

### 2.3 任务处理量统计

#### 功能描述
统计用户和组织的任务处理量。

#### 统计维度
1. **按用户统计**
   - 处理任务总数
   - 日均处理量
   - 处理及时率
   - 超时处理数

2. **按组织统计**
   - 组织任务总量
   - 人均处理量
   - 组织排名

3. **按时间统计**
   - 日处理量
   - 周处理量
   - 月处理量

#### API 接口
```java
// 任务处理量统计
GET /api/statistics/task-volume
Query Params:
  - dimension: 'user' | 'organization' | 'time'
  - startTime: LocalDateTime
  - endTime: LocalDateTime
Response: TaskVolumeStatisticsVO

// 用户排行榜
GET /api/statistics/task-volume/ranking
Query Params:
  - type: 'daily' | 'weekly' | 'monthly' | 'total'
  - limit: number
Response: List<UserRankingVO>
```

---

### 2.4 任务耗时统计

#### 功能描述
统计任务的处理耗时。

#### 统计内容
1. **平均处理耗时**
   - 整体平均耗时
   - 各类型任务平均耗时
   - 各用户平均处理耗时

2. **耗时分布**
   - 即时处理（< 5分钟）
   - 快速处理（5-30分钟）
   - 正常处理（30分钟-2小时）
   - 延迟处理（2-24小时）
   - 严重延迟（> 24小时）

3. **超时分析**
   - 超时任务数
   - 超时率
   - 超时原因分析

#### 数据库查询

```java
@Repository
public class TaskStatisticsRepository {

    /**
     * 查询任务处理耗时统计
     */
    public List<TaskDurationStats> getTaskDurationStats(
        LocalDateTime startTime,
        LocalDateTime endTime
    ) {
        String sql = """
            SELECT
                t.task_definition_key,
                t.name AS task_name,
                COUNT(*) AS task_count,
                AVG(TIMESTAMPDIFF(MINUTE, t.create_time, h.end_time)) AS avg_duration_minutes,
                SUM(CASE WHEN t.due_date < h.end_time THEN 1 ELSE 0 END) AS timeout_count
            FROM act_hi_taskinst h
            JOIN act_ru_task t ON h.id_ = t.id_
            WHERE h.end_time_ BETWEEN ? AND ?
            GROUP BY t.task_definition_key, t.name
            """;

        return jdbcTemplate.query(sql, rowMapper, startTime, endTime);
    }
}
```

---

## 3. 数据可视化

### 3.1 图表类型

1. **折线图** - 趋势分析
   - 流程发起趋势
   - 任务处理趋势
   - 耗时变化趋势

2. **柱状图** - 对比分析
   - 各组织流程数对比
   - 各用户处理量对比
   - 各类型流程耗时对比

3. **饼图** - 占比分析
   - 流程状态分布
   - 任务耗时分布
   - 超时原因分布

4. **排行榜** - 绩效分析
   - 用户处理量排行
   - 组织完成率排行
   - 处理速度排行

### 3.2 图表组件

```vue
<!-- 趋势图组件 -->
<template>
  <div class="trend-chart">
    <v-chart :option="chartOption" autoresize />
  </div>
</template>

<script setup lang="ts">
import { use } from 'echarts/core'
import { LineChart } from 'echarts/charts'
import { GridComponent, TooltipComponent } from 'echarts/components'
import VChart from 'vue-echarts'

use([LineChart, GridComponent, TooltipComponent])

const props = defineProps<{
  data: TrendData
}>()

const chartOption = computed(() => ({
  xAxis: {
    type: 'category',
    data: props.data.labels
  },
  yAxis: {
    type: 'value'
  },
  series: [{
    data: props.data.values,
    type: 'line',
    smooth: true
  }],
  tooltip: {
    trigger: 'axis'
  }
}))
</script>
```

---

## 4. 后端设计

### 4.1 StatisticsService

```java
@Service
public class StatisticsService {

    @Autowired
    private ProcessInstanceRepository processInstanceRepository;

    @Autowired
    private TaskStatisticsRepository taskStatisticsRepository;

    /**
     * 流程实例统计
     */
    public ProcessInstanceStatisticsVO getProcessInstanceStatistics(
        String dimension,
        LocalDateTime startTime,
        LocalDateTime endTime
    ) {
        switch (dimension) {
            case "organization":
                return getByOrganization(startTime, endTime);
            case "user":
                return getByUser(startTime, endTime);
            case "status":
                return getByStatus(startTime, endTime);
            case "time":
                return getByTime(startTime, endTime);
            default:
                throw new InvalidDimensionException();
        }
    }

    /**
     * 任务处理量统计
     */
    public TaskVolumeStatisticsVO getTaskVolumeStatistics(
        String dimension,
        LocalDateTime startTime,
        LocalDateTime endTime
    ) {
        // 实现逻辑...
    }

    /**
     * 耗时统计
     */
    public DurationStatisticsVO getDurationStatistics(
        String type,
        LocalDateTime startTime,
        LocalDateTime endTime
    ) {
        // 实现逻辑...
    }
}
```

---

## 5. 开发任务清单

### Sprint 7（Week 7）
- [ ] 实现流程实例统计
- [ ] 实现流程耗时统计
- [ ] 实现任务处理量统计
- [ ] 实现任务耗时统计
- [ ] 实现数据可视化

### Sprint 8（Week 8）
- [ ] 实现统计报表导出
- [ ] 实现自定义统计
- [ ] 优化查询性能
- [ ] 编写单元测试

---

## 6. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-701 | 查询流程统计 | 有流程实例数据 | 1. 选择维度<br>2. 选择时间范围<br>3. 查询 | 显示正确统计数据 |
| TC-702 | 查看耗时统计 | 有完成任务数据 | 1. 打开耗时统计页面 | 显示平均耗时和分布 |
| TC-703 | 查看排行榜 | 有任务处理数据 | 1. 打开排行榜 | 显示用户排名 |
| TC-704 | 导出统计报表 | 有统计数据 | 1. 点击导出<br>2. 选择格式 | 生成Excel/PDF文件 |

---

## 7. 性能要求

- 统计查询响应时间 < 3 秒
- 图表渲染时间 < 1 秒
- 支持百万级数据统计
- 使用缓存提升查询速度

---

## 8. 数据库优化

```sql
-- 创建索引加速统计查询
CREATE INDEX idx_process_instance_start_time ON act_hi_procinst(start_time_);
CREATE INDEX idx_process_instance_end_time ON act_hi_procinst(end_time_);
CREATE INDEX idx_task_create_time ON act_hi_taskinst(create_time_);
CREATE INDEX idx_task_end_time ON act_hi_taskinst(end_time_);
CREATE INDEX idx_task_assignee ON act_hi_taskinst(assignee_);
```
