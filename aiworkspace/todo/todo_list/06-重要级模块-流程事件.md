# 重要级模块 - 流程事件

> 优先级：P1（重要级）
> 预计工期：1 周
> 依赖：流程实例管理

## 1. 功能概述

流程事件模块支持流程事件监听和扩展，允许在流程的关键节点插入自定义逻辑。

---

## 2. 功能需求

### 2.1 自定义事件监听

#### 功能描述
监听流程生命周期中的各种事件。

#### 支持的事件类型
1. **流程事件**
   - 流程启动（Process Started）
   - 流程完成（Process Completed）
   - 流程终止（Process Terminated）
   - 流程挂起（Process Suspended）
   - 流程激活（Process Activated）

2. **任务事件**
   - 任务创建（Task Created）
   - 任务分配（Task Assigned）
   - 任务完成（Task Completed）
   - 任务过期（Task Expired）

3. **节点事件**
   - 节点开始（Activity Started）
   - 节点结束（Activity Completed）
   - 节点取消（Activity Cancelled）

#### 事件监听器接口

```java
public interface ProcessEventListener {
    /**
     * 流程启动事件
     */
    void onProcessStart(ProcessInstance processInstance);

    /**
     * 流程完成事件
     */
    void onProcessComplete(ProcessInstance processInstance);

    /**
     * 任务创建事件
     */
    void onTaskCreated(DelegateTask task);

    /**
     * 任务分配事件
     */
    void onTaskAssigned(DelegateTask task);

    /**
     * 任务完成事件
     */
    void onTaskComplete(DelegateTask task);
}
```

---

### 2.2 事件类型定义

#### 事件配置
在 BPMN 流程中配置事件监听器：

```xml
<extensionElements>
  <flowable:eventListener
    class="com.lingflow.listener.ProcessStartListener"
    events="start" />

  <flowable:taskListener
    class="com.lingflow.listener.TaskAssignedListener"
    event="create" />
</extensionElements>
```

#### 事件参数
- 事件类型（event type）
- 监听器类（listener class）
- 异步执行（async）
- 优先级（priority）

---

### 2.3 事件触发历史记录

#### 功能描述
记录所有触发的事件历史，便于问题追踪和审计。

#### 数据库设计
```sql
-- 事件触发历史表
CREATE TABLE event_trigger_history (
  id VARCHAR(36) PRIMARY KEY,
  event_type VARCHAR(50) NOT NULL,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64),
  activity_id VARCHAR(255),
  listener_class VARCHAR(255),
  trigger_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  execution_status VARCHAR(20),
  error_message TEXT,
  execution_duration INT,
  INDEX idx_process_instance (process_instance_id),
  INDEX idx_event_type (event_type),
  INDEX idx_trigger_time (trigger_time)
);
```

#### API 接口
```java
// 查询事件触发历史
GET /api/events/history
Query Params:
  - processInstanceId: string
  - eventType: string
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - page: number
  - size: number
Response: PageResult<EventTriggerHistoryVO>
```

---

## 3. 内置事件监听器

### 3.1 邮件通知监听器

```java
@Component
public class EmailNotificationListener implements ProcessEventListener {

    @Autowired
    private EmailService emailService;

    @Override
    public void onTaskAssigned(DelegateTask task) {
        // 发送任务分配邮件通知
        String assignee = task.getAssignee();
        String taskName = task.getName();
        String processName = getProcessName(task);

        emailService.sendTaskNotification(
            assignee,
            taskName,
            processName
        );
    }
}
```

### 3.2 审计日志监听器

```java
@Component
public class AuditLogListener implements ProcessEventListener {

    @Autowired
    private AuditLogService auditLogService;

    @Override
    public void onProcessStart(ProcessInstance processInstance) {
        auditLogService.log(
            "PROCESS_START",
            processInstance.getId(),
            processInstance.getStartUserId(),
            "流程启动"
        );
    }

    @Override
    public void onTaskComplete(DelegateTask task) {
        auditLogService.log(
            "TASK_COMPLETE",
            task.getProcessInstanceId(),
            task.getAssignee(),
            "任务完成: " + task.getName()
        );
    }
}
```

### 3.3 超时提醒监听器

```java
@Component
public class TimeoutReminderListener implements ProcessEventListener {

    @Autowired
    private NotificationService notificationService;

    @Override
    public void onTaskCreated(DelegateTask task) {
        // 获取任务到期时间
        Date dueDate = task.getDueDate();
        if (dueDate != null) {
            // 计算提醒时间（提前1天）
            long reminderTime = dueDate.getTime() - 24 * 60 * 60 * 1000;

            // 定时提醒
            scheduleReminder(task.getId(), reminderTime);
        }
    }
}
```

---

## 4. 事件配置管理

### 4.1 事件配置页面

```vue
<template>
  <div class="event-config">
    <el-card>
      <template #header>
        <span>事件监听器配置</span>
      </template>

      <el-form :model="eventForm" label-width="120px">
        <el-form-item label="流程">
          <el-select v-model="eventForm.processDefinitionId">
            <el-option
              v-for="def in processDefinitions"
              :key="def.id"
              :label="`${def.name} (v${def.version})`"
              :value="def.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="事件类型">
          <el-select v-model="eventForm.eventType">
            <el-option label="流程启动" value="process.start" />
            <el-option label="流程完成" value="process.complete" />
            <el-option label="任务创建" value="task.create" />
            <el-option label="任务分配" value="task.assign" />
            <el-option label="任务完成" value="task.complete" />
          </el-select>
        </el-form-item>

        <el-form-item label="监听器类">
          <el-select v-model="eventForm.listenerClass">
            <el-option
              v-for="listener in availableListeners"
              :key="listener.className"
              :label="listener.name"
              :value="listener.className"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="异步执行">
          <el-switch v-model="eventForm.async" />
        </el-form-item>

        <el-form-item label="优先级">
          <el-input-number v-model="eventForm.priority" :min="1" :max="100" />
        </el-form-item>

        <el-form-item>
          <el-button type="primary" @click="save">保存</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 已配置监听器列表 -->
    <el-card>
      <template #header>
        <span>已配置监听器</span>
      </template>
      <el-table :data="listeners" stripe>
        <el-table-column prop="eventType" label="事件类型" />
        <el-table-column prop="listenerClass" label="监听器类" />
        <el-table-column prop="async" label="异步">
          <template #default="{ row }">
            {{ row.async ? '是' : '否' }}
          </template>
        </el-table-column>
        <el-table-column prop="priority" label="优先级" />
        <el-table-column label="操作">
          <template #default="{ row }">
            <el-button size="small" @click="test(row)">测试</el-button>
            <el-button size="small" type="danger" @click="remove(row)">
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>
```

---

## 5. 后端设计

### 5.1 EventService

```java
@Service
public class EventService {

    @Autowired
    private EventTriggerHistoryRepository historyRepository;

    /**
     * 记录事件触发
     */
    @Async
    public void recordEvent(
        String eventType,
        String processInstanceId,
        String taskId,
        String activityId,
        String listenerClass,
        Runnable eventHandler
    ) {
        long startTime = System.currentTimeMillis();
        String status = "SUCCESS";
        String errorMessage = null;

        try {
            // 执行事件处理
            eventHandler.run();
        } catch (Exception e) {
            status = "FAILED";
            errorMessage = e.getMessage();
            throw e;
        } finally {
            // 记录历史
            long duration = System.currentTimeMillis() - startTime;

            EventTriggerHistory history = EventTriggerHistory.builder()
                .eventType(eventType)
                .processInstanceId(processInstanceId)
                .taskId(taskId)
                .activityId(activityId)
                .listenerClass(listenerClass)
                .triggerTime(LocalDateTime.now())
                .executionStatus(status)
                .errorMessage(errorMessage)
                .executionDuration((int) duration)
                .build();

            historyRepository.save(history);
        }
    }

    /**
     * 查询事件历史
     */
    public PageResult<EventTriggerHistoryVO> getEventHistory(
        String processInstanceId,
        String eventType,
        LocalDateTime startTime,
        LocalDateTime endTime,
        int page,
        int size
    ) {
        // 查询逻辑...
    }
}
```

---

## 6. 开发任务清单

### Sprint 6（Week 6）
- [ ] 实现事件监听框架
- [ ] 实现内置监听器（邮件、审计、超时）
- [ ] 实现事件历史记录
- [ ] 实现事件配置管理
- [ ] 编写单元测试

---

## 7. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-601 | 流程启动事件 | 流程已配置监听器 | 1. 启动流程 | 监听器被触发，历史记录生成 |
| TC-602 | 任务分配事件 | 任务已分配 | 1. 分配任务 | 监听器被触发，邮件发送 |
| TC-603 | 事件异步执行 | 配置异步监听器 | 1. 触发事件 | 监听器异步执行 |
| TC-604 | 查询事件历史 | 有事件记录 | 1. 查询历史 | 显示所有事件记录 |

---

## 8. 性能要求

- 事件监听器执行时间 < 500ms（同步）
- 异步事件执行不阻塞主流程
- 事件历史查询 < 1 秒
