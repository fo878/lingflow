# 数据库设计

> 版本：v1.0
> 更新时间：2025-01-15

## 1. 数据库概述

### 1.1 数据库选型

**主数据库**：PostgreSQL 15+

**选择理由**：
- 开源免费
- 功能强大，支持复杂查询
- 事务支持完善
- 性能优秀
- 社区活跃

### 1.2 数据库架构

**模式**：
- `flowable`：Flowable 引擎表（由 Flowable 自动创建）
- `lingflow`：业务扩展表

---

## 2. 表结构设计

### 2.1 流程扩展相关表

#### 2.1.1 流程快照表 (process_snapshot)

**用途**：保存流程版本快照

```sql
CREATE TABLE process_snapshot (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_key VARCHAR(255) NOT NULL,
  snapshot_name VARCHAR(255) NOT NULL,
  snapshot_version VARCHAR(50) NOT NULL,
  description TEXT,
  creator VARCHAR(100),
  bpmn_xml TEXT NOT NULL,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_process_key (process_definition_key),
  INDEX idx_created_time (created_time)
);

COMMENT ON TABLE process_snapshot IS '流程快照表';
COMMENT ON COLUMN process_snapshot.process_definition_key IS '流程定义Key';
COMMENT ON COLUMN process_snapshot.snapshot_name IS '快照名称';
COMMENT ON COLUMN process_snapshot.snapshot_version IS '快照版本号';
COMMENT ON COLUMN process_snapshot.bpmn_xml IS 'BPMN XML内容';
```

#### 2.1.2 流程元素扩展表 (bpmn_element_extension)

**用途**：扩展 BPMN 元素的自定义属性

```sql
CREATE TABLE bpmn_element_extension (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  element_id VARCHAR(255) NOT NULL,
  element_type VARCHAR(100) NOT NULL,
  extension_attributes TEXT NOT NULL,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_process_element (process_definition_id, element_id),
  INDEX idx_process_definition (process_definition_id)
);

COMMENT ON TABLE bpmn_element_extension IS 'BPMN元素扩展表';
COMMENT ON COLUMN bpmn_element_extension.extension_attributes IS '扩展属性JSON';
```

#### 2.1.3 流程元素扩展历史表 (bpmn_element_extension_history)

**用途**：记录元素属性变更历史

```sql
CREATE TABLE bpmn_element_extension_history (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  element_id VARCHAR(255) NOT NULL,
  element_type VARCHAR(100) NOT NULL,
  extension_attributes TEXT NOT NULL,
  operation_type VARCHAR(20) NOT NULL,
  operator VARCHAR(100),
  operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_process_definition (process_definition_id),
  INDEX idx_element (element_id),
  INDEX idx_operation_time (operation_time)
);
```

---

### 2.2 任务操作相关表

#### 2.2.1 会签记录表 (countersign_record)

**用途**：记录任务会签情况

```sql
CREATE TABLE countersign_record (
  id VARCHAR(36) PRIMARY KEY,
  task_id VARCHAR(64) NOT NULL,
  assignee VARCHAR(100) NOT NULL,
  status VARCHAR(20) NOT NULL,
  comment TEXT,
  approve_time TIMESTAMP,

  INDEX idx_task (task_id),
  INDEX idx_assignee (assignee)
);

COMMENT ON TABLE countersign_record IS '会签记录表';
COMMENT ON COLUMN countersign_record.status IS '状态：PENDING/APPROVED/REJECTED';
```

#### 2.2.2 委托记录表 (delegate_record)

**用途**：记录任务委托关系

```sql
CREATE TABLE delegate_record (
  id VARCHAR(36) PRIMARY KEY,
  task_id VARCHAR(64) NOT NULL,
  original_assignee VARCHAR(100) NOT NULL,
  delegate_user VARCHAR(100) NOT NULL,
  delegate_reason TEXT,
  delegate_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  due_date TIMESTAMP,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  revoke_time TIMESTAMP,

  INDEX idx_task (task_id),
  INDEX idx_original_assignee (original_assignee),
  INDEX idx_delegate_user (delegate_user)
);

COMMENT ON TABLE delegate_record IS '委托记录表';
```

---

### 2.3 配置相关表

#### 2.3.1 表单绑定表 (form_binding)

**用途**：绑定表单到流程节点

```sql
CREATE TABLE form_binding (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  task_definition_key VARCHAR(255) NOT NULL,
  form_key VARCHAR(255) NOT NULL,
  form_type VARCHAR(20) NOT NULL,
  form_permissions TEXT,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  UNIQUE KEY uk_process_task (process_definition_id, task_definition_key),
  INDEX idx_form_key (form_key)
);

COMMENT ON TABLE form_binding IS '表单绑定表';
COMMENT ON COLUMN form_binding.form_type IS '表单类型：dynamic/static/external';
```

#### 2.3.2 流程变量配置表 (process_variable_config)

**用途**：配置流程变量

```sql
CREATE TABLE process_variable_config (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  variable_name VARCHAR(255) NOT NULL,
  variable_type VARCHAR(50) NOT NULL,
  default_value TEXT,
  scope VARCHAR(20) NOT NULL,
  description TEXT,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  UNIQUE KEY uk_process_var (process_definition_id, variable_name),
  INDEX idx_process_definition (process_definition_id)
);

COMMENT ON TABLE process_variable_config IS '流程变量配置表';
COMMENT ON COLUMN process_variable_config.scope IS '变量作用域：global/local';
```

#### 2.3.3 超时通知配置表 (timeout_notification_config)

**用途**：配置任务超时通知规则

```sql
CREATE TABLE timeout_notification_config (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64),
  task_definition_key VARCHAR(255),
  reasonable_duration INT NOT NULL COMMENT '合理完成时长（分钟）',
  grace_duration INT COMMENT '宽限时长（分钟）',
  notification_methods VARCHAR(100) COMMENT '通知方式：email/sms/站内信',
  notification_recipients TEXT COMMENT '通知接收人配置',
  advance_notice_days INT COMMENT '提前提醒天数',

  INDEX idx_process_task (process_definition_id, task_definition_key)
);
```

---

### 2.4 统计相关表

#### 2.4.1 统计缓存表 (statistics_cache)

**用途**：缓存统计数据，提升查询性能

```sql
CREATE TABLE statistics_cache (
  id VARCHAR(36) PRIMARY KEY,
  cache_key VARCHAR(255) NOT NULL UNIQUE,
  cache_data TEXT NOT NULL,
  cache_type VARCHAR(50) NOT NULL,
  expire_time TIMESTAMP NOT NULL,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_cache_key (cache_key),
  INDEX idx_expire_time (expire_time)
);

COMMENT ON TABLE statistics_cache IS '统计缓存表';
COMMENT ON COLUMN statistics_cache.cache_type IS '缓存类型：process/task/duration等';
```

---

### 2.5 通知相关表

#### 2.5.1 邮件模板表 (email_template)

**用途**：存储邮件模板

```sql
CREATE TABLE email_template (
  id VARCHAR(36) PRIMARY KEY,
  template_code VARCHAR(50) NOT NULL UNIQUE,
  template_name VARCHAR(100) NOT NULL,
  subject VARCHAR(200) NOT NULL,
  content TEXT NOT NULL,
  variables TEXT,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

COMMENT ON TABLE email_template IS '邮件模板表';
```

#### 2.5.2 邮件发送记录表 (email_send_log)

**用途**：记录邮件发送历史

```sql
CREATE TABLE email_send_log (
  id VARCHAR(36) PRIMARY KEY,
  template_code VARCHAR(50),
  recipients TEXT NOT NULL,
  subject VARCHAR(200),
  send_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  status VARCHAR(20) NOT NULL,
  error_message TEXT,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64),

  INDEX idx_template_code (template_code),
  INDEX idx_send_time (send_time),
  INDEX idx_process_instance (process_instance_id)
);
```

---

### 2.6 附件相关表

#### 2.6.1 附件表 (process_attachment)

**用途**：存储流程附件信息

```sql
CREATE TABLE process_attachment (
  id VARCHAR(36) PRIMARY KEY,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64),
  comment_id VARCHAR(64),
  file_name VARCHAR(255) NOT NULL,
  file_size BIGINT NOT NULL,
  file_type VARCHAR(50),
  storage_path VARCHAR(500) NOT NULL,
  uploader VARCHAR(100) NOT NULL,
  upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_process_instance (process_instance_id),
  INDEX idx_task (task_id)
);
```

---

### 2.7 安全相关表

#### 2.7.1 密级配置表 (security_level)

**用途**：定义安全密级

```sql
CREATE TABLE security_level (
  id INT PRIMARY KEY AUTO_INCREMENT,
  level_code VARCHAR(20) NOT NULL UNIQUE,
  level_name VARCHAR(50) NOT NULL,
  level_value INT NOT NULL,
  description TEXT
);

COMMENT ON TABLE security_level IS '密级配置表';
```

#### 2.7.2 用户密级表 (user_security_level)

**用途**：设置用户密级

```sql
CREATE TABLE user_security_level (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL UNIQUE,
  security_level INT NOT NULL,
  grant_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  grantor VARCHAR(100)
);

COMMENT ON TABLE user_security_level IS '用户密级表';
```

#### 2.7.3 流程实例密级表 (process_security_level)

**用途**：设置流程实例密级

```sql
CREATE TABLE process_security_level (
  id VARCHAR(36) PRIMARY KEY,
  process_instance_id VARCHAR(64) NOT NULL UNIQUE,
  security_level INT NOT NULL,
  set_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  setter VARCHAR(100)
);
```

---

### 2.8 审计相关表

#### 2.8.1 审计日志表 (audit_log)

**用途**：记录系统操作日志

```sql
CREATE TABLE audit_log (
  id VARCHAR(36) PRIMARY KEY,
  operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  operator VARCHAR(100) NOT NULL,
  operation_type VARCHAR(50) NOT NULL,
  operation_target VARCHAR(100),
  target_id VARCHAR(64),
  operation_result VARCHAR(20),
  ip_address VARCHAR(50),
  user_agent VARCHAR(500),
  request_url VARCHAR(500),
  request_params TEXT,
  response_data TEXT,
  error_message TEXT,

  INDEX idx_operation_time (operation_time),
  INDEX idx_operator (operator),
  INDEX idx_operation_type (operation_type),
  INDEX idx_target (operation_target, target_id)
);
```

---

### 2.9 分类相关表

#### 2.9.1 流程分类表 (process_category)

**用途**：管理流程分类

```sql
CREATE TABLE process_category (
  id VARCHAR(36) PRIMARY KEY,
  category_name VARCHAR(100) NOT NULL,
  parent_id VARCHAR(36),
  icon VARCHAR(50),
  sort_order INT DEFAULT 0,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_parent (parent_id)
);
```

#### 2.9.2 流程收藏表 (process_favorite)

**用途**：用户收藏流程

```sql
CREATE TABLE process_favorite (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  process_definition_id VARCHAR(64) NOT NULL,
  group_name VARCHAR(100),
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  UNIQUE KEY uk_user_process (user_id, process_definition_id)
);
```

---

### 2.10 多租户相关表

#### 2.10.1 租户表 (system_tenant)

**用途**：管理租户信息

```sql
CREATE TABLE system_tenant (
  id VARCHAR(36) PRIMARY KEY,
  tenant_code VARCHAR(50) NOT NULL UNIQUE,
  tenant_name VARCHAR(100) NOT NULL,
  contact_person VARCHAR(100),
  contact_phone VARCHAR(20),
  contact_email VARCHAR(100),
  status VARCHAR(20) DEFAULT 'ACTIVE',
  expire_date DATE,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.10.2 数据源表 (system_datasource)

**用途**：配置租户数据源

```sql
CREATE TABLE system_datasource (
  id VARCHAR(36) PRIMARY KEY,
  tenant_id VARCHAR(36) NOT NULL,
  datasource_name VARCHAR(100) NOT NULL,
  datasource_type VARCHAR(50) NOT NULL,
  host VARCHAR(100),
  port INT,
  database_name VARCHAR(100),
  username VARCHAR(100),
  password VARCHAR(255),
  is_primary BOOLEAN DEFAULT FALSE,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_tenant (tenant_id)
);
```

---

## 3. 索引设计

### 3.1 索引原则

1. 为经常查询的字段创建索引
2. 为外键创建索引
3. 为组合查询创建复合索引
4. 避免过多索引影响写入性能

### 3.2 关键索引

```sql
-- 流程实例查询
CREATE INDEX idx_proc_inst_buskey ON act_hi_procinst(business_key_);
CREATE INDEX idx_proc_inst_starttime ON act_hi_procinst(start_time_);

-- 任务查询
CREATE INDEX idx_task_assignee ON act_ru_task(assignee_);
CREATE INDEX idx_task_create_time ON act_ru_task(create_time_);
CREATE INDEX idx_his_task_assignee ON act_hi_taskinst(assignee_);
CREATE INDEX idx_his_task_endtime ON act_hi_taskinst(end_time_);

-- 自定义表索引已在表结构中定义
```

---

## 4. 数据库优化

### 4.1 分区策略

对历史数据表按时间分区：

```sql
-- 审计日志按月分区
CREATE TABLE audit_log_partitioned (
  -- 同 audit_log 结构
) PARTITION BY RANGE (operation_time);

-- 创建分区
CREATE TABLE audit_log_2025_01 PARTITION OF audit_log_partitioned
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 4.2 查询优化

```sql
-- 使用 EXPLAIN ANALYZE 分析查询
EXPLAIN ANALYZE
SELECT * FROM act_hi_taskinst
WHERE assignee_ = 'user001'
  AND end_time_ BETWEEN '2025-01-01' AND '2025-01-31';
```

---

## 5. 数据迁移

### 5.1 版本管理

使用 Flyway 或 Liquibase 管理数据库版本：

```sql
-- V1.0.0__init_schema.sql
-- 创建初始表结构

-- V1.0.1__add_process_snapshot.sql
-- 添加流程快照表

-- V1.0.2__add_countersign.sql
-- 添加会签相关表
```

### 5.2 数据备份

**备份策略**：
- 全量备份：每天凌晨
- 增量备份：每小时
- binlog 备份：实时

**备份命令**：
```bash
# 全量备份
pg_dump -U postgres -d lingflow > backup_$(date +%Y%m%d).sql

# 恢复
psql -U postgres -d lingflow < backup_20250115.sql
```
