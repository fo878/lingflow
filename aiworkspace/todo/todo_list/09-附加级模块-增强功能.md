# 附加级模块 - 增强功能

> 优先级：P2（附加级）
> 预计工期：2 周
> 依赖：核心级模块、重要级模块

## 1. 功能概述

附加级模块包括流程模板管理增强、流程高级功能和多租户与数据源管理，用于提升系统的易用性和扩展性。

---

## 2. 功能需求

### 2.1 流程模板管理增强

#### 2.1.1 分类管理

**功能描述**
对流程模板进行分类管理，支持树形结构。

**功能点**
1. **分类操作**
   - 新增分类
   - 编辑分类
   - 删除分类
   - 移动分类

2. **分类结构**
   - 支持多级分类
   - 拖拽调整顺序
   - 图标自定义

**数据库设计**
```sql
-- 流程分类表
CREATE TABLE process_category (
  id VARCHAR(36) PRIMARY KEY,
  category_name VARCHAR(100) NOT NULL,
  parent_id VARCHAR(36),
  icon VARCHAR(50),
  sort_order INT DEFAULT 0,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_parent (parent_id)
);
```

#### 2.1.2 按组织分级管理

**功能描述**
流程模板按组织进行权限控制。

**功能点**
1. **权限设置**
   - 设置流程可见组织
   - 设置流程可发起组织
   - 设置流程可管理组织

2. **权限继承**
   - 子组织继承父组织权限
   - 支持单独授权

#### 2.1.3 收藏流程模板

**功能描述**
用户可以收藏常用流程模板，快速访问。

**功能点**
- 添加收藏
- 取消收藏
- 查看收藏列表
- 收藏分组

**数据库设计**
```sql
-- 流程收藏表
CREATE TABLE process_favorite (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(100) NOT NULL,
  process_definition_id VARCHAR(64) NOT NULL,
  group_name VARCHAR(100),
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_process (user_id, process_definition_id)
);
```

---

### 2.2 流程高级功能

#### 2.2.1 统一任务盒

**功能描述**
集成其他平台流程任务，统一在一个界面处理。

**功能点**
1. **任务源管理**
   - 添加外部任务源
   - 配置外部系统API
   - 任务同步配置

2. **任务聚合**
   - 统一展示所有任务
   - 标识任务来源
   - 跳转到原系统处理

3. **任务同步**
   - 定时同步任务
   - 状态实时更新
   - 同步日志记录

**数据库设计**
```sql
-- 外部任务源配置表
CREATE TABLE external_task_source (
  id VARCHAR(36) PRIMARY KEY,
  source_name VARCHAR(100) NOT NULL,
  source_type VARCHAR(50) NOT NULL,
  api_url VARCHAR(500) NOT NULL,
  auth_config TEXT,
  sync_interval INT DEFAULT 300,
  status VARCHAR(20) DEFAULT 'ACTIVE',
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 外部任务缓存表
CREATE TABLE external_task_cache (
  id VARCHAR(36) PRIMARY KEY,
  source_id VARCHAR(36) NOT NULL,
  external_task_id VARCHAR(100) NOT NULL,
  task_name VARCHAR(255),
  assignee VARCHAR(100),
  status VARCHAR(50),
  due_date TIMESTAMP,
  sync_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_source (source_id),
  INDEX idx_assignee (assignee)
);
```

---

### 2.3 多租户与数据源管理

#### 2.3.1 多租户多数据源

**功能描述**
支持多租户环境下的数据隔离，包括物理隔离和逻辑隔离。

**隔离方式**
1. **物理隔离**
   - 每个租户独立数据库
   - 数据完全隔离，安全性高
   - 成本较高

2. **逻辑隔离**
   - 共享数据库，通过租户ID区分
   - 成本低，便于维护
   - 需要严格权限控制

**数据库设计**
```sql
-- 租户表
CREATE TABLE system_tenant (
  id VARCHAR(36) PRIMARY KEY,
  tenant_code VARCHAR(50) NOT NULL UNIQUE,
  tenant_name VARCHAR(100) NOT NULL,
  contact_person VARCHAR(100),
  contact_phone VARCHAR(20),
  contact_email VARCHAR(100),
  status VARCHAR(20) DEFAULT 'ACTIVE',
  expire_date DATE,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 数据源表
CREATE TABLE system_datasource (
  id VARCHAR(36) PRIMARY KEY,
  tenant_id VARCHAR(36) NOT NULL,
  datasource_name VARCHAR(100) NOT NULL,
  datasource_type VARCHAR(50) NOT NULL,
  host VARCHAR(100),
  port INT,
  database_name VARCHAR(100),
  username VARCHAR(100),
  password VARCHAR(255),
  is_primary BOOLEAN DEFAULT FALSE,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_tenant (tenant_id)
);

-- 租户与数据源关联表
CREATE TABLE tenant_datasource_relation (
  id VARCHAR(36) PRIMARY KEY,
  tenant_id VARCHAR(36) NOT NULL,
  datasource_id VARCHAR(36) NOT NULL,
  relation_type VARCHAR(20) NOT NULL,
  created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_tenant (tenant_id),
  INDEX idx_datasource (datasource_id)
);
```

#### 2.3.2 动态数据源切换

**功能描述**
根据租户自动切换数据源。

**实现方式**
```java
@Configuration
public class DataSourceConfig {

    @Bean
    @ConfigurationProperties(prefix = "spring.datasource")
    public DataSource dataSource() {
        // 主数据源
        return DataSourceBuilder.create().build();
    }

    @Bean
    public DataSource dynamicDataSource(
        @Autowired DataSource primaryDataSource,
        @Autowired DataSourceRepository dataSourceRepository
    ) {
        Map<Object, Object> targetDataSources = new HashMap<>();

        // 加载所有租户数据源
        List<SystemDatasource> dataSources = dataSourceRepository.findAll();
        for (SystemDatasource ds : dataSources) {
            DataSource dataSource = createDataSource(ds);
            targetDataSources.put(ds.getId(), dataSource);
        }

        DynamicDataSource dynamicDataSource = new DynamicDataSource();
        dynamicDataSource.setTargetDataSources(targetDataSources);
        dynamicDataSource.setDefaultTargetDataSource(primaryDataSource);

        return dynamicDataSource;
    }
}

public class DynamicDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return TenantContextHolder.getTenantId();
    }
}
```

---

## 3. 前端设计

### 3.1 流程分类管理页面

```vue
<template>
  <div class="category-manager">
    <el-row :gutter="16">
      <el-col :span="8">
        <el-card>
          <template #header>
            <div class="header">
              <span>分类树</span>
              <el-button size="small" @click="showAddCategoryDialog">
                新建分类
              </el-button>
            </div>
          </template>

          <el-tree
            :data="categoryTree"
            :props="{ children: 'children', label: 'categoryName' }"
            node-key="id"
            draggable
            @node-drop="handleNodeDrop"
            @node-click="handleNodeClick"
          >
            <template #default="{ node, data }">
              <span class="tree-node">
                <i v-if="data.icon" :class="data.icon" />
                <span>{{ node.label }}</span>
                <el-dropdown @command="(cmd) => handleCommand(cmd, data)">
                  <el-icon @click.stop>
                    <MoreFilled />
                  </el-icon>
                  <template #dropdown>
                    <el-dropdown-menu>
                      <el-dropdown-item command="add">添加子分类</el-dropdown-item>
                      <el-dropdown-item command="edit">编辑</el-dropdown-item>
                      <el-dropdown-item command="delete">删除</el-dropdown-item>
                    </el-dropdown-menu>
                  </template>
                </el-dropdown>
              </span>
            </template>
          </el-tree>
        </el-card>
      </el-col>

      <el-col :span="16">
        <el-card>
          <template #header>
            <span>分类详情</span>
          </template>

          <el-form v-if="currentCategory" :model="currentCategory" label-width="100px">
            <el-form-item label="分类名称">
              <el-input v-model="currentCategory.categoryName" />
            </el-form-item>
            <el-form-item label="图标">
              <el-input v-model="currentCategory.icon">
                <template #prepend>
                  <i :class="currentCategory.icon || 'el-icon-document'" />
                </template>
              </el-input>
            </el-form-item>
            <el-form-item label="排序">
              <el-input-number v-model="currentCategory.sortOrder" :min="0" />
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="save">保存</el-button>
              <el-button @click="reset">重置</el-button>
            </el-form-item>
          </el-form>

          <el-empty v-else description="请选择分类" />
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>
```

### 3.2 收藏流程模板页面

```vue
<template>
  <div class="favorite-processes">
    <el-card>
      <template #header>
        <div class="header">
          <span>我的收藏</span>
          <el-input
            v-model="searchText"
            placeholder="搜索流程"
            style="width: 200px"
            clearable
          >
            <template #prefix>
              <el-icon><Search /></el-icon>
            </template>
          </el-input>
        </div>
      </template>

      <!-- 收藏分组 -->
      <el-tabs v-model="activeGroup">
        <el-tab-pane label="全部" name="all">
          <process-list :processes="filteredProcesses" />
        </el-tab-pane>
        <el-tab-pane
          v-for="group in groups"
          :key="group"
          :label="group"
          :name="group"
        >
          <process-list
            :processes="filteredProcesses.filter(p => p.groupName === group)"
          />
        </el-tab-pane>
        <el-tab-pane label="+" name="add" @click="showAddGroupDialog">
          新建分组
        </el-tab-pane>
      </el-tabs>
    </el-card>
  </div>
</template>
```

---

## 4. 后端设计

### 4.1 CategoryService

```java
@Service
public class CategoryService {

    @Autowired
    private ProcessCategoryRepository categoryRepository;

    /**
     * 获取分类树
     */
    public List<CategoryTreeNode> getCategoryTree() {
        List<ProcessCategory> allCategories = categoryRepository.findAll();

        // 构建树形结构
        Map<String, CategoryTreeNode> nodeMap = new HashMap<>();
        List<CategoryTreeNode> roots = new ArrayList<>();

        for (ProcessCategory category : allCategories) {
            CategoryTreeNode node = convertToTreeNode(category);
            nodeMap.put(node.getId(), node);

            if (category.getParentId() == null) {
                roots.add(node);
            } else {
                CategoryTreeNode parent = nodeMap.get(category.getParentId());
                if (parent != null) {
                    parent.addChild(node);
                }
            }
        }

        return roots;
    }

    /**
     * 保存分类
     */
    @Transactional
    public void saveCategory(ProcessCategory category) {
        categoryRepository.save(category);
    }

    /**
     * 删除分类
     */
    @Transactional
    public void deleteCategory(String categoryId) {
        // 检查是否有子分类
        List<ProcessCategory> children = categoryRepository
            .findByParentId(categoryId);

        if (!children.isEmpty()) {
            throw new CategoryHasChildrenException();
        }

        // 检查是否有流程使用
        boolean hasProcesses = checkCategoryHasProcesses(categoryId);
        if (hasProcesses) {
            throw new CategoryInUseException();
        }

        categoryRepository.deleteById(categoryId);
    }
}
```

### 4.2 TenantService

```java
@Service
public class TenantService {

    @Autowired
    private SystemTenantRepository tenantRepository;

    @Autowired
    private DataSourceRepository dataSourceRepository;

    /**
     * 创建租户
     */
    @Transactional
    public void createTenant(CreateTenantRequest request) {
        // 1. 创建租户
        SystemTenant tenant = SystemTenant.builder()
            .tenantCode(generateTenantCode())
            .tenantName(request.getTenantName())
            .contactPerson(request.getContactPerson())
            .contactPhone(request.getContactPhone())
            .contactEmail(request.getContactEmail())
            .status("ACTIVE")
            .expireDate(request.getExpireDate())
            .build();

        tenantRepository.save(tenant);

        // 2. 创建数据源
        if (request.getDataSourceType() == DataSourceType.PHYSICAL) {
            createPhysicalDataSource(tenant, request);
        }
    }

    /**
     * 切换租户数据源
     */
    public void switchTenantDataSource(String tenantId) {
        if (TenantContextHolder.getTenantId() != null) {
            // 检查权限
            checkTenantAccess(tenantId);
        }

        // 切换数据源
        String dataSourceId = getTenantPrimaryDataSource(tenantId);
        TenantContextHolder.setTenantId(dataSourceId);
    }

    /**
     * 创建物理数据源
     */
    private void createPhysicalDataSource(SystemTenant tenant, CreateTenantRequest request) {
        // 创建新数据库
        String databaseName = "lingflow_tenant_" + tenant.getId();
        createDatabase(databaseName);

        // 创建数据源记录
        SystemDatasource dataSource = SystemDatasource.builder()
            .tenantId(tenant.getId())
            .datasourceName(tenant.getTenantName() + "-主数据源")
            .datasourceType("postgresql")
            .host(request.getDbHost())
            .port(request.getDbPort())
            .databaseName(databaseName)
            .username(request.getDbUsername())
            .password(encryptPassword(request.getDbPassword()))
            .isPrimary(true)
            .build();

        dataSourceRepository.save(dataSource);

        // 初始化数据库表结构
        initDatabaseSchema(dataSource);
    }
}
```

---

## 5. 开发任务清单

### Sprint 9（Week 9）
- [ ] 实现分类管理
- [ ] 实现按组织分级管理
- [ ] 实现收藏流程模板
- [ ] 实现统一任务盒框架

### Sprint 10（Week 10）
- [ ] 实现多租户管理
- [ ] 实现动态数据源切换
- [ ] 完善权限控制
- [ ] 编写单元测试

---

## 6. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-901 | 创建分类 | 有分类管理权限 | 1. 点击新建分类<br>2. 输入分类信息<br>3. 保存 | 分类创建成功 |
| TC-902 | 收藏流程 | 流程已发布 | 1. 点击收藏按钮 | 流程加入收藏列表 |
| TC-903 | 查看统一任务盒 | 配置了外部任务源 | 1. 打开任务盒 | 显示所有任务（含外部） |
| TC-904 | 切换租户数据源 | 有多租户配置 | 1. 切换租户 | 数据源自动切换 |

---

## 7. 性能要求

- 分类树加载 < 500ms
- 收藏列表加载 < 1 秒
- 外部任务同步不影响主系统性能
- 租户数据源切换 < 200ms
