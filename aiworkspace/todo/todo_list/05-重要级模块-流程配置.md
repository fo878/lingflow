# 重要级模块 - 流程配置

> 优先级：P1（重要级）
> 预计工期：1 周
> 依赖：流程模板管理

## 1. 功能概述

流程配置模块提供流程运行时的配置能力，包括表单绑定、流程变量配置、节点属性配置和超时通知等功能。

---

## 2. 功能需求

### 2.1 表单绑定

#### 功能描述
将动态或静态表单关联到用户任务节点。

#### 功能点
1. **表单类型**
   - 动态表单（通过表单设计器设计）
   - 静态表单（自定义开发）
   - 外部表单（外部系统表单）

2. **绑定配置**
   - 选择表单类型
   - 选择或输入表单 Key
   - 配置表单权限（只读/编辑/隐藏）
   - 配置表单字段权限

3. **表单渲染**
   - 任务办理时自动加载表单
   - 表单数据自动回显
   - 表单验证

#### 数据库设计
```sql
-- 表单绑定表
CREATE TABLE form_binding (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  task_definition_key VARCHAR(255) NOT NULL,
  form_key VARCHAR(255) NOT NULL,
  form_type VARCHAR(20) NOT NULL,
  form_permissions TEXT,
  INDEX idx_process_task (process_definition_id, task_definition_key)
);
```

#### API 接口
```java
// 绑定表单
POST /api/process/forms/bind
Request: {
  processDefinitionId: string,
  taskDefinitionKey: string,
  formKey: string,
  formType: 'dynamic' | 'static' | 'external',
  formPermissions: object
}
Response: void

// 获取表单绑定
GET /api/process/forms/{processDefinitionId}/{taskDefinitionKey}
Response: FormBindingVO
```

---

### 2.2 流程变量配置

#### 功能描述
定义流程中使用的变量及其属性。

#### 功能点
1. **变量定义**
   - 变量名称
   - 变量类型（String/Number/Boolean/Date/Object等）
   - 默认值
   - 变量作用域（全局/本地）

2. **变量管理**
   - 新增变量
   - 编辑变量
   - 删除变量
   - 变量导入/导出

#### 数据库设计
```sql
-- 流程变量配置表
CREATE TABLE process_variable_config (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64) NOT NULL,
  variable_name VARCHAR(255) NOT NULL,
  variable_type VARCHAR(50) NOT NULL,
  default_value TEXT,
  scope VARCHAR(20) NOT NULL,
  description TEXT,
  INDEX idx_process (process_definition_id),
  UNIQUE KEY uk_process_var (process_definition_id, variable_name)
);
```

#### API 接口
```java
// 保存流程变量配置
POST /api/process/variables
Request: {
  processDefinitionId: string,
  variables: VariableConfig[]
}
Response: void

// 获取流程变量配置
GET /api/process/variables/{processDefinitionId}
Response: List<VariableConfigVO>
```

---

### 2.3 节点属性配置

#### 功能描述
配置流程节点的各种属性。

#### 功能点
1. **用户任务属性**
   - 执行人
   - 候选用户
   - 候选组
   - 表单 Key
   - 优先级
   - 到期时间

2. **服务任务属性**
   - 实现类
   - 表达式
   - 代理表达式
   - 结果变量名

3. **网关属性**
   - 网关类型
   - 条件表达式

---

### 2.4 超时通知

#### 功能描述
配置任务超时提醒规则。

#### 功能点
1. **超时设置**
   - 合理完成时限
   - 宽限警告时限
   - 超时处理动作

2. **通知方式**
   - 站内消息
   - 邮件通知
   - 短信通知

3. **通知规则**
   - 提前 N 天提醒
   - 超时后每天提醒
   - 提醒给谁（处理人/主管/发起人）

#### 数据库设计
```sql
-- 超时通知配置表
CREATE TABLE timeout_notification_config (
  id VARCHAR(36) PRIMARY KEY,
  process_definition_id VARCHAR(64),
  task_definition_key VARCHAR(255),
  reasonable_duration INT,
  grace_duration INT,
  notification_methods VARCHAR(100),
  notification_recipients TEXT,
  advance_notice_days INT,
  INDEX idx_process_task (process_definition_id, task_definition_key)
);
```

---

## 3. 前端设计

### 3.1 表单绑定配置页面

```vue
<template>
  <div class="form-binding-config">
    <el-card>
      <template #header>
        <span>表单绑定配置</span>
      </template>

      <el-form :model="bindingForm" label-width="120px">
        <el-form-item label="流程">
          <el-select
            v-model="bindingForm.processDefinitionId"
            @change="loadTasks"
          >
            <el-option
              v-for="def in processDefinitions"
              :key="def.id"
              :label="`${def.name} (v${def.version})`"
              :value="def.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="任务节点">
          <el-select v-model="bindingForm.taskDefinitionKey">
            <el-option
              v-for="task in userTasks"
              :key="task.id"
              :label="task.name"
              :value="task.key"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="表单类型" required>
          <el-radio-group v-model="bindingForm.formType">
            <el-radio label="dynamic">动态表单</el-radio>
            <el-radio label="static">静态表单</el-radio>
            <el-radio label="external">外部表单</el-radio>
          </el-radio-group>
        </el-form-item>

        <el-form-item label="表单 Key" required>
          <el-input v-model="bindingForm.formKey" />
        </el-form-item>

        <el-form-item label="表单权限">
          <permission-config
            v-model="bindingForm.formPermissions"
            :form-key="bindingForm.formKey"
          />
        </el-form-item>

        <el-form-item>
          <el-button type="primary" @click="save">保存</el-button>
          <el-button @click="reset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <!-- 已绑定表单列表 -->
    <el-card class="binding-list">
      <template #header>
        <span>已绑定表单</span>
      </template>
      <el-table :data="bindings" stripe>
        <el-table-column prop="taskName" label="任务节点" />
        <el-table-column prop="formType" label="表单类型" />
        <el-table-column prop="formKey" label="表单 Key" />
        <el-table-column label="操作" width="150">
          <template #default="{ row }">
            <el-button size="small" @click="edit(row)">编辑</el-button>
            <el-button size="small" type="danger" @click="remove(row)">
              删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>
```

---

## 4. 后端设计

### 4.1 ProcessConfigService

```java
@Service
public class ProcessConfigService {

    @Autowired
    private FormBindingRepository formBindingRepository;

    @Autowired
    private ProcessVariableConfigRepository variableConfigRepository;

    /**
     * 绑定表单
     */
    @Transactional
    public void bindForm(FormBindingRequest request) {
        FormBinding binding = FormBinding.builder()
            .processDefinitionId(request.getProcessDefinitionId())
            .taskDefinitionKey(request.getTaskDefinitionKey())
            .formKey(request.getFormKey())
            .formType(request.getFormType())
            .formPermissions(JsonUtils.toJson(request.getFormPermissions()))
            .build();

        formBindingRepository.save(binding);
    }

    /**
     * 保存流程变量配置
     */
    @Transactional
    public void saveVariableConfig(VariableConfigRequest request) {
        // 删除旧配置
        variableConfigRepository.deleteByProcessDefinitionId(
            request.getProcessDefinitionId()
        );

        // 保存新配置
        List<ProcessVariableConfig> configs = request.getVariables().stream()
            .map(v -> ProcessVariableConfig.builder()
                .processDefinitionId(request.getProcessDefinitionId())
                .variableName(v.getName())
                .variableType(v.getType())
                .defaultValue(v.getDefaultValue())
                .scope(v.getScope())
                .description(v.getDescription())
                .build())
            .collect(Collectors.toList());

        variableConfigRepository.saveAll(configs);
    }
}
```

---

## 5. 开发任务清单

### Sprint 6（Week 6）
- [ ] 实现表单绑定功能
- [ ] 实现流程变量配置
- [ ] 实现节点属性配置
- [ ] 实现超时通知配置
- [ ] 编写单元测试

---

## 6. 测试用例

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-501 | 绑定动态表单 | 流程已发布 | 1. 选择流程和任务<br>2. 选择动态表单<br>3. 输入表单Key<br>4. 保存 | 表单绑定成功 |
| TC-502 | 配置流程变量 | 流程已发布 | 1. 选择流程<br>2. 添加变量<br>3. 保存 | 变量配置保存成功 |
| TC-503 | 配置超时通知 | 流程已发布 | 1. 选择任务<br>2. 设置超时时间<br>3. 配置通知<br>4. 保存 | 超时配置生效 |

---

## 7. 性能要求

- 配置加载时间 < 500ms
- 配置保存响应时间 < 1 秒
