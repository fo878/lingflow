# 核心级模块 - 流程实例管理

> 优先级：P0（核心级）
> 预计工期：1.5 周
> 依赖：流程模板管理

## 1. 功能概述

流程实例管理负责管理流程实例的整个生命周期，包括流程启动、终止、挂起/激活和状态跟踪等核心功能。

---

## 2. 功能需求

### 2.1 流程启动

#### 功能描述
根据已发布的流程模板启动新的流程实例。

#### 用户故事
作为一个业务用户，我希望能够启动一个流程实例，以便开始一个新的业务流程。

#### 功能点
1. **启动方式**
   - 从流程列表启动
   - 通过流程 Key 启动
   - 批量启动（相同流程，多次启动）

2. **初始化参数**
   - 流程变量设置
   - 发起人自动设置
   - 业务 Key 设置（关联业务数据）

3. **启动验证**
   - 检查流程是否存在
   - 检查流程是否已挂起
   - 验证必填参数

#### 验收标准
- ✅ 可以从流程列表启动流程
- ✅ 启动后流程实例进入第一个节点
- ✅ 发起人信息正确记录
- ✅ 流程变量正确传递
- ✅ 已挂起的流程无法启动

#### API 接口
```java
// 启动流程实例
POST /api/process-instances
Request: {
  processDefinitionKey: string,
  businessKey?: string,
  variables?: Map<string, object>
}
Response: {
  processInstanceId: string,
  processDefinitionId: string,
  businessKey: string,
  status: string,
  startTime: LocalDateTime
}

// 批量启动
POST /api/process-instances/batch
Request: {
  processDefinitionKey: string,
  count: number,
  variables?: Map<string, object>
}
Response: List<ProcessInstanceVO>
```

---

### 2.2 流程终止

#### 功能描述
强制终止运行中的流程实例。

#### 用户故事
作为一个管理员，我希望能够终止异常的流程实例，以便处理异常情况。

#### 功能点
1. **终止操作**
   - 单个终止
   - 批量终止
   - 终止原因记录

2. **终止验证**
   - 检查流程是否运行中
   - 权限验证（仅管理员和发起人可终止）
   - 终止确认提示

3. **终止后处理**
   - 更新流程状态
   - 记录终止原因
   - 发送通知（如配置）

#### 验收标准
- ✅ 终止后流程状态变为"已终止"
- ✅ 未完成的任务自动取消
- ✅ 终止原因正确记录
- ✅ 非权限用户无法终止

#### API 接口
```java
// 终止流程实例
DELETE /api/process-instances/{processInstanceId}
Request: {
  reason: string
}
Response: {
  processInstanceId: string,
  status: 'terminated',
  terminateTime: LocalDateTime
}

// 批量终止
DELETE /api/process-instances/batch
Request: {
  processInstanceIds: string[],
  reason: string
}
Response: BatchOperationResult
```

---

### 2.3 流程挂起/激活

#### 功能描述
暂停或恢复流程实例的执行。

#### 用户故事
作为一个管理员，我希望能够挂起某个流程，以便临时停止其执行，稍后再恢复。

#### 功能点
1. **挂起操作**
   - 挂起流程实例
   - 挂起原因记录
   - 挂起后任务不可操作

2. **激活操作**
   - 恢复挂起的流程
   - 激活原因记录
   - 任务恢复可操作

3. **状态查询**
   - 查看挂起的流程列表
   - 查看流程历史状态

#### 验收标准
- ✅ 挂起后流程任务无法操作
- ✅ 激活后流程继续执行
- ✅ 状态变更正确记录
- ✅ 挂起历史可查询

#### API 接口
```java
// 挂起流程实例
PUT /api/process-instances/{processInstanceId}/suspend
Request: {
  reason: string
}
Response: ProcessInstanceVO

// 激活流程实例
PUT /api/process-instances/{processInstanceId}/activate
Request: {
  reason: string
}
Response: ProcessInstanceVO

// 查询挂起的流程
GET /api/process-instances?suspended=true
Response: PageResult<ProcessInstanceVO>
```

---

### 2.4 实时状态跟踪

#### 功能描述
图形化展示流程实例当前执行到哪个节点。

#### 用户故事
作为一个业务用户，我希望能够查看流程的当前状态，以便了解流程进展。

#### 功能点
1. **状态展示**
   - 流程图高亮当前节点
   - 已完成节点标记
   - 待执行节点预览
   - 流程方向指示

2. **节点信息**
   - 当前节点名称
   - 当前处理人
   - 节点到达时间
   - 节点停留时长

3. **进度展示**
   - 流程进度百分比
   - 已完成节点数
   - 总节点数

#### 验收标准
- ✅ 流程图正确显示当前节点
- ✅ 已完成节点有明确标识
- ✅ 节点信息准确无误
- ✅ 流程进度计算正确

#### 前端实现
```typescript
<template>
  <div class="process-tracker">
    <div class="progress-info">
      <el-progress :percentage="progress" />
      <span>{{ completedNodes }}/{{ totalNodes }} 节点已完成</span>
    </div>

    <div class="diagram-container">
      <!-- 使用 BPMN.js 只读模式展示流程图 -->
      <div ref="viewerRef" class="bpmn-viewer"></div>
    </div>

    <div class="node-info">
      <el-descriptions title="当前节点信息" :column="2">
        <el-descriptions-item label="节点名称">
          {{ currentNode.name }}
        </el-descriptions-item>
        <el-descriptions-item label="处理人">
          {{ currentNode.assignee }}
        </el-descriptions-item>
        <el-descriptions-item label="到达时间">
          {{ currentNode.arriveTime }}
        </el-descriptions-item>
        <el-descriptions-item label="停留时长">
          {{ currentNode.duration }}
        </el-descriptions-item>
      </el-descriptions>
    </div>
  </div>
</template>

<script setup lang="ts">
import BpmnViewer from 'bpmn-js/lib/NavigatedViewer'
import { ref, onMounted } from 'vue'

const viewerRef = ref<HTMLElement>()
const progress = ref(0)
const currentNode = ref({})

const initViewer = async (processInstanceId: string) => {
  // 1. 获取流程定义 XML
  const xml = await getProcessXml(processInstanceId)

  // 2. 获取流程实例状态
  const activityList = await getActivityList(processInstanceId)

  // 3. 初始化 Viewer
  const viewer = new BpmnViewer({
    container: viewerRef.value
  })

  await viewer.importXML(xml)

  // 4. 高亮当前节点
  const canvas = viewer.get('canvas')
  const overlay = viewer.get('overlays')

  activityList.forEach(activity => {
    if (activity.finished) {
      canvas.addMarker(activity.id, 'completed')
    } else if (activity.active) {
      canvas.addMarker(activity.id, 'active')
      overlay.add(activity.id, {
        position: { top: 0, right: 0 },
        html: '<div class="current-node-indicator"></div>'
      })
    }
  })

  // 5. 计算进度
  progress.value = (completedCount / totalCount) * 100
}
</script>
```

---

### 2.5 历史日志查询

#### 功能描述
查询流程实例的操作历史日志。

#### 功能点
1. **日志类型**
   - 流程启动
   - 任务创建
   - 任务完成
   - 流程挂起
   - 流程激活
   - 流程终止
   - 流程完成

2. **日志信息**
   - 操作时间
   - 操作类型
   - 操作人
   - 操作详情
   - 操作结果

3. **查询功能**
   - 按流程实例查询
   - 按时间范围查询
   - 按操作类型筛选
   - 按操作人筛选

#### 验收标准
- ✅ 所有操作都有日志记录
- ✅ 日志信息完整准确
- ✅ 支持多条件查询
- ✅ 日志按时间倒序排列

#### API 接口
```java
// 查询流程历史
GET /api/process-instances/{processInstanceId}/history
Query Params:
  - startTime: LocalDateTime
  - endTime: LocalDateTime
  - operationType: string
  - operator: string
Response: PageResult<ProcessHistoryLogVO>
```

#### 数据库设计
```sql
-- 流程历史日志表
CREATE TABLE process_history_log (
  id VARCHAR(36) PRIMARY KEY,
  process_instance_id VARCHAR(64) NOT NULL,
  operation_type VARCHAR(50) NOT NULL,
  operator VARCHAR(100),
  operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  operation_details TEXT,
  operation_result VARCHAR(50),
  INDEX idx_process_instance (process_instance_id),
  INDEX idx_operation_time (operation_time),
  INDEX idx_operation_type (operation_type)
);
```

---

## 3. 前端设计

### 3.1 页面结构

```
流程实例管理
├── 流程实例列表页面 (Index.vue)
│   ├── 搜索条件
│   │   ├── 流程定义
│   │   ├── 状态筛选
│   │   ├── 时间范围
│   │   └── 发起人
│   ├── 操作按钮
│   │   ├── 批量终止
│   │   ├── 批量挂起
│   │   └── 导出
│   └── 实例列表表格
│       ├── 流程信息
│       ├── 当前状态
│       ├── 进度
│       └── 操作按钮
└── 流程详情页面 (Detail.vue)
    ├── 流程基本信息
    ├── 流程状态跟踪图
    ├── 节点信息
    └── 操作历史
```

### 3.2 核心组件

#### ProcessInstanceList.vue
```typescript
<template>
  <div class="process-instance-list">
    <!-- 搜索条件 -->
    <el-form :model="searchForm" inline>
      <el-form-item label="流程名称">
        <el-select v-model="searchForm.processDefinitionKey">
          <el-option
            v-for="def in processDefinitions"
            :key="def.key"
            :label="def.name"
            :value="def.key"
          />
        </el-select>
      </el-form-item>

      <el-form-item label="状态">
        <el-select v-model="searchForm.status">
          <el-option label="全部" value="" />
          <el-option label="运行中" value="running" />
          <el-option label="已挂起" value="suspended" />
          <el-option label="已完成" value="completed" />
          <el-option label="已终止" value="terminated" />
        </el-select>
      </el-form-item>

      <el-form-item>
        <el-button type="primary" @click="search">查询</el-button>
        <el-button @click="reset">重置</el-button>
      </el-form-item>
    </el-form>

    <!-- 批量操作 -->
    <div class="batch-actions">
      <el-button
        :disabled="selectedRows.length === 0"
        @click="batchTerminate"
      >
        批量终止
      </el-button>
      <el-button
        :disabled="selectedRows.length === 0"
        @click="batchSuspend"
      >
        批量挂起
      </el-button>
    </div>

    <!-- 实例列表 -->
    <el-table
      :data="instances"
      @selection-change="handleSelectionChange"
    >
      <el-table-column type="selection" width="55" />
      <el-table-column prop="processName" label="流程名称" />
      <el-table-column prop="businessKey" label="业务Key" />
      <el-table-column prop="startUser" label="发起人" />
      <el-table-column prop="startTime" label="开始时间" />
      <el-table-column prop="status" label="状态">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="currentNode" label="当前节点" />
      <el-table-column label="操作" width="250">
        <template #default="{ row }">
          <el-button size="small" @click="viewDetail(row)">
            查看详情
          </el-button>
          <el-button
            v-if="row.status === 'running'"
            size="small"
            @click="suspend(row)"
          >
            挂起
          </el-button>
          <el-button
            v-if="row.status === 'suspended'"
            size="small"
            @click="activate(row)"
          >
            激活
          </el-button>
          <el-button
            v-if="['running', 'suspended'].includes(row.status)"
            size="small"
            type="danger"
            @click="terminate(row)"
          >
            终止
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!-- 分页 -->
    <el-pagination
      v-model:current-page="pagination.page"
      v-model:page-size="pagination.size"
      :total="pagination.total"
      @current-change="loadInstances"
    />
  </div>
</template>
```

---

## 4. 后端设计

### 4.1 核心类设计

#### ProcessInstanceController.java
```java
@RestController
@RequestMapping("/api/process-instances")
public class ProcessInstanceController {

    @Autowired
    private ProcessInstanceService processInstanceService;

    /**
     * 启动流程实例
     */
    @PostMapping
    public ResponseEntity<ProcessInstanceVO> start(
        @RequestBody StartProcessRequest request,
        @AuthenticationPrincipal String username
    ) {
        request.setStartUser(username);
        ProcessInstanceVO result = processInstanceService.start(request);
        return ResponseEntity.ok(result);
    }

    /**
     * 查询流程实例列表
     */
    @GetMapping
    public ResponseEntity<PageResult<ProcessInstanceVO>> list(
        @RequestParam(required = false) String processDefinitionKey,
        @RequestParam(required = false) String status,
        @RequestParam(defaultValue = "1") int page,
        @RequestParam(defaultValue = "10") int size
    ) {
        PageResult<ProcessInstanceVO> result = processInstanceService.list(
            processDefinitionKey, status, page, size
        );
        return ResponseEntity.ok(result);
    }

    /**
     * 获取流程实例详情
     */
    @GetMapping("/{processInstanceId}")
    public ResponseEntity<ProcessInstanceDetailVO> getDetail(
        @PathVariable String processInstanceId
    ) {
        ProcessInstanceDetailVO result = processInstanceService.getDetail(processInstanceId);
        return ResponseEntity.ok(result);
    }

    /**
     * 终止流程实例
     */
    @DeleteMapping("/{processInstanceId}")
    public ResponseEntity<Void> terminate(
        @PathVariable String processInstanceId,
        @RequestBody TerminateRequest request
    ) {
        processInstanceService.terminate(processInstanceId, request);
        return ResponseEntity.ok().build();
    }

    /**
     * 挂起流程实例
     */
    @PutMapping("/{processInstanceId}/suspend")
    public ResponseEntity<ProcessInstanceVO> suspend(
        @PathVariable String processInstanceId,
        @RequestBody SuspendRequest request
    ) {
        ProcessInstanceVO result = processInstanceService.suspend(
            processInstanceId, request
        );
        return ResponseEntity.ok(result);
    }

    /**
     * 激活流程实例
     */
    @PutMapping("/{processInstanceId}/activate")
    public ResponseEntity<ProcessInstanceVO> activate(
        @PathVariable String processInstanceId,
        @RequestBody ActivateRequest request
    ) {
        ProcessInstanceVO result = processInstanceService.activate(
            processInstanceId, request
        );
        return ResponseEntity.ok(result);
    }
}
```

#### ProcessInstanceService.java
```java
@Service
public class ProcessInstanceService {

    @Autowired
    private RuntimeService runtimeService;

    @Autowired
    private HistoryService historyService;

    @Autowired
    private ProcessHistoryLogRepository historyLogRepository;

    /**
     * 启动流程实例
     */
    @Transactional
    public ProcessInstanceVO start(StartProcessRequest request) {
        // 1. 验证流程定义是否存在
        ProcessDefinition definition = repositoryService
            .createProcessDefinitionQuery()
            .processDefinitionKey(request.getProcessDefinitionKey())
            .latestVersion()
            .singleResult();

        if (definition == null) {
            throw new ProcessDefinitionNotFoundException();
        }

        // 2. 设置流程变量
        Map<String, Object> variables = request.getVariables();
        if (variables == null) {
            variables = new HashMap<>();
        }
        variables.put("startUser", request.getStartUser());

        // 3. 启动流程实例
        ProcessInstance instance = runtimeService.startProcessInstanceByKey(
            request.getProcessDefinitionKey(),
            request.getBusinessKey(),
            variables
        );

        // 4. 记录历史日志
        historyLogRepository.save(ProcessHistoryLog.builder()
            .processInstanceId(instance.getId())
            .operationType("START")
            .operator(request.getStartUser())
            .operationDetails("启动流程: " + definition.getName())
            .operationResult("SUCCESS")
            .build()
        );

        // 5. 返回流程实例信息
        return convertToVO(instance);
    }

    /**
     * 终止流程实例
     */
    @Transactional
    public void terminate(String processInstanceId, TerminateRequest request) {
        // 1. 验证流程实例状态
        ProcessInstance instance = runtimeService
            .createProcessInstanceQuery()
            .processInstanceId(processInstanceId)
            .singleResult();

        if (instance == null) {
            throw new ProcessInstanceNotFoundException();
        }

        // 2. 终止流程
        runtimeService.deleteProcessInstance(
            processInstanceId,
            request.getReason()
        );

        // 3. 记录历史日志
        historyLogRepository.save(ProcessHistoryLog.builder()
            .processInstanceId(processInstanceId)
            .operationType("TERMINATE")
            .operator(SecurityContextHolder.getContext().getAuthentication().getName())
            .operationDetails("终止流程: " + request.getReason())
            .operationResult("SUCCESS")
            .build()
        );
    }

    /**
     * 挂起流程实例
     */
    @Transactional
    public ProcessInstanceVO suspend(String processInstanceId, SuspendRequest request) {
        runtimeService.suspendProcessInstanceById(processInstanceId);

        // 记录历史
        historyLogRepository.save(ProcessHistoryLog.builder()
            .processInstanceId(processInstanceId)
            .operationType("SUSPEND")
            .operator(SecurityContextHolder.getContext().getAuthentication().getName())
            .operationDetails("挂起流程: " + request.getReason())
            .operationResult("SUCCESS")
            .build()
        );

        return getProcessInstanceVO(processInstanceId);
    }
}
```

---

## 5. 开发任务清单

### Sprint 3（Week 3）
- [ ] 实现流程启动功能
- [ ] 实现流程实例列表查询
- [ ] 实现流程终止功能
- [ ] 实现流程挂起/激活功能

### Sprint 4（Week 4）
- [ ] 实现实时状态跟踪功能
- [ ] 实现历史日志查询
- [ ] 完善权限控制
- [ ] 编写单元测试
- [ ] 编写接口文档

---

## 6. 测试用例

### 6.1 功能测试

| 用例ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|--------|----------|----------|----------|----------|
| TC-201 | 启动流程 | 流程已发布 | 1. 选择流程<br>2. 设置变量<br>3. 点击启动 | 流程实例创建成功 |
| TC-202 | 终止流程 | 流程运行中 | 1. 选择运行中流程<br>2. 点击终止<br>3. 输入原因 | 流程终止，任务取消 |
| TC-203 | 挂起流程 | 流程运行中 | 1. 选择运行中流程<br>2. 点击挂起 | 流程挂起，任务不可操作 |
| TC-204 | 激活流程 | 流程已挂起 | 1. 选择挂起流程<br>2. 点击激活 | 流程恢复，任务可操作 |
| TC-205 | 查看状态跟踪 | 流程运行中 | 1. 打开流程详情<br>2. 查看状态图 | 正确显示当前节点 |

---

## 7. 性能要求

- 流程实例列表加载时间 < 1 秒
- 流程启动响应时间 < 2 秒
- 状态图渲染时间 < 3 秒
- 支持 10000+ 流程实例查询

---

## 8. 依赖项

- Flowable RuntimeService
- Flowable HistoryService
- 流程模板管理模块
