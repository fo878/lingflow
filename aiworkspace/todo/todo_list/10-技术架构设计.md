# 技术架构设计

> 版本：v1.0
> 更新时间：2025-01-15

## 1. 系统架构概述

### 1.1 整体架构

LingFlow 采用前后端分离的微服务架构，基于 Spring Boot 3.2.0 和 Vue 3 构建。

```
┌─────────────────────────────────────────────────────────┐
│                        用户层                            │
│  PC浏览器  │  移动浏览器  │  桌面客户端                    │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                    前端层 (Vue 3)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 流程设计器 │  │ 任务中心  │  │ 统计分析  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└──────────────────────┬──────────────────────────────────┘
                       │ HTTP/WebSocket
┌──────────────────────▼──────────────────────────────────┐
│                  API 网关层 (Nginx)                       │
│  负载均衡  │  静态资源  │  反向代理  │  SSL终结         │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                  应用层 (Spring Boot)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 流程引擎   │  │ 任务服务   │  │ 统计服务   │              │
│  │ (Flowable)│  │          │  │          │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ 用户服务   │  │ 通知服务   │  │ 租户服务   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└──────────────────────┬──────────────────────────────────┘
                       │
┌──────────────────────▼──────────────────────────────────┐
│                     数据层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │PostgreSQL │  │  Redis   │  │  MinIO   │              │
│  │ (主数据库) │  │  (缓存)   │  │ (文件)   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 技术选型

### 2.1 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.4.0 | 渐进式 JavaScript 框架 |
| TypeScript | 5.3.3 | JavaScript 的超集 |
| Vite | 5.0.8 | 下一代前端构建工具 |
| Element Plus | 2.5.0 | Vue 3 UI 组件库 |
| BPMN.js | 17.6.0 | BPMN 2.0 建模工具 |
| Pinia | 2.1.7 | Vue 官方状态管理库 |
| Vue Router | 4.2.5 | Vue.js 官方路由管理器 |
| Axios | 1.6.2 | HTTP 客户端 |
| ECharts | 5.4.3 | 数据可视化图表库 |

### 2.2 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Spring Boot | 3.2.0 | Java 应用程序开发框架 |
| Flowable | 7.0.1 | 轻量级工作流和业务流程管理平台 |
| Spring Security | 6.x | 安全框架 |
| Spring Data JPA | 3.2.0 | ORM 框架 |
| PostgreSQL | 15+ | 关系型数据库 |
| Redis | 7.0+ | 内存数据库/缓存 |
| Lombok | Latest | Java 库，简化 Java 代码 |
| Hutool | 5.x | Java 工具类库 |
| Java Mail | 1.6+ | 邮件发送 |

---

## 3. 架构分层

### 3.1 前端分层

```
├── src/
│   ├── api/              # API 接口层
│   │   ├── index.ts      # Axios 实例配置
│   │   ├── process.ts    # 流程相关 API
│   │   ├── task.ts       # 任务相关 API
│   │   └── ...
│   ├── views/            # 页面组件层
│   │   ├── process/      # 流程管理页面
│   │   ├── task/         # 任务管理页面
│   │   └── monitor/      # 监控页面
│   ├── components/       # 公共组件层
│   │   ├── ProcessDiagramViewer.vue
│   │   ├── UserSelector.vue
│   │   └── ...
│   ├── stores/           # 状态管理层
│   │   ├── user.ts
│   │   ├── process.ts
│   │   └── ...
│   ├── router/           # 路由配置层
│   │   └── index.ts
│   ├── utils/            # 工具函数层
│   │   ├── request.ts
│   │   ├── auth.ts
│   │   └── ...
│   └── types/            # 类型定义层
│       ├── process.d.ts
│       └── ...
```

### 3.2 后端分层

```
├── src/main/java/com/lingflow/
│   ├── controller/       # 控制器层
│   │   ├── ProcessController.java
│   │   ├── TaskController.java
│   │   └── ...
│   ├── service/          # 服务层接口
│   │   ├── ProcessService.java
│   │   └── ...
│   ├── service/impl/     # 服务层实现
│   │   ├── ProcessServiceImpl.java
│   │   └── ...
│   ├── repository/       # 数据访问层
│   │   ├── ProcessDefinitionRepository.java
│   │   └── ...
│   ├── entity/           # 实体类
│   │   ├── ProcessDefinition.java
│   │   └── ...
│   ├── dto/              # 数据传输对象
│   │   ├── CreateSnapshotRequest.java
│   │   └── ...
│   ├── config/           # 配置类
│   │   ├── FlowableConfig.java
│   │   ├── SecurityConfig.java
│   │   └── ...
│   ├── enums/            # 枚举类
│   │   └── ...
│   ├── exception/        # 异常处理
│   │   ├── GlobalExceptionHandler.java
│   │   └── ...
│   └── util/             # 工具类
│       └── ...
```

---

## 4. 核心模块设计

### 4.1 流程引擎模块

**职责**：流程定义、部署、执行

**核心组件**：
- Flowable Engine：流程引擎核心
- Repository Service：流程定义管理
- Runtime Service：流程实例管理
- Task Service：任务管理
- History Service：历史数据管理
- Management Service：引擎管理

### 4.2 任务管理模块

**职责**：任务查询、分配、完成

**核心功能**：
- 待办任务查询
- 已办任务查询
- 任务委托
- 任务转办
- 任务会签

### 4.3 统计分析模块

**职责**：流程数据统计、分析、报表

**核心功能**：
- 流程实例统计
- 任务处理量统计
- 耗时统计
- 趋势分析

---

## 5. 数据流转

### 5.1 流程启动流程

```
1. 用户启动流程
   ↓
2. 前端调用 POST /api/process-instances
   ↓
3. ProcessInstanceController 接收请求
   ↓
4. ProcessInstanceService 验证流程定义
   ↓
5. RuntimeService 启动流程实例
   ↓
6. 创建第一个任务
   ↓
7. 发送通知（如配置）
   ↓
8. 记录审计日志
   ↓
9. 返回流程实例信息给前端
```

### 5.2 任务处理流程

```
1. 用户打开待办任务
   ↓
2. 前端调用 GET /api/tasks/{taskId}
   ↓
3. TaskController 返回任务详情
   ↓
4. 用户填写表单、审批意见
   ↓
5. 前端调用 POST /api/tasks/{taskId}/complete
   ↓
6. TaskService 验证数据
   ↓
7. TaskService 完成任务
   ↓
8. Flowable 引擎流转到下一节点
   ↓
9. 创建新任务或结束流程
   ↓
10. 发送通知
   ↓
11. 记录审计日志
```

---

## 6. 安全设计

### 6.1 认证授权

**认证方式**：JWT（JSON Web Token）

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        return http
            .csrf(csrf -> csrf.disable())
            .sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter,
                UsernamePasswordAuthenticationFilter.class)
            .build();
    }
}
```

### 6.2 数据权限

**权限模型**：RBAC（基于角色的访问控制）

```
用户 → 角色 → 权限 → 资源
```

**权限类型**：
- 流程发起权限
- 流程管理权限
- 任务处理权限
- 数据查看权限

---

## 7. 性能优化

### 7.1 缓存策略

**缓存层级**：
1. **Redis 缓存**
   - 流程定义缓存
   - 用户信息缓存
   - 权限数据缓存

2. **本地缓存**
   - 字典数据缓存
   - 配置信息缓存

### 7.2 数据库优化

**优化措施**：
- 索引优化
- 分页查询
- 读写分离
- 连接池优化

### 7.3 前端优化

**优化措施**：
- 代码分割
- 懒加载
- 虚拟滚动
- 请求防抖节流

---

## 8. 部署架构

### 8.1 开发环境

```
┌─────────────────────────────────────┐
│  开发机                              │
│  - Vue 前端 (npm run dev)           │
│  - Spring Boot 后端                 │
│  - PostgreSQL (Docker)              │
│  - Redis (Docker)                   │
└─────────────────────────────────────┘
```

### 8.2 生产环境

```
┌─────────────────────────────────────────────┐
│  Nginx (负载均衡、反向代理)                  │
└────────────┬────────────────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
┌───▼────┐      ┌────▼───┐
│ App 1  │      │ App 2  │
└───┬────┘      └────┬───┘
    │                │
    └────────┬───────┘
             │
    ┌────────┴────────┐
    │                 │
┌───▼────┐      ┌────▼────┐
│ PostgreSQL │  │  Redis   │
│  (主从)  │      │ (集群)  │
└─────────┘      └─────────┘
```

---

## 9. 监控运维

### 9.1 日志管理

**日志级别**：ERROR > WARN > INFO > DEBUG

**日志框架**：SLF4J + Logback

**日志输出**：
- 控制台输出（开发环境）
- 文件输出（生产环境）
- 日志聚合（ELK Stack）

### 9.2 监控指标

**系统指标**：
- CPU 使用率
- 内存使用率
- 磁盘 I/O
- 网络流量

**应用指标**：
- 请求响应时间
- 请求成功率
- 流程处理速度
- 任务队列长度

---

## 10. 技术债务与改进

### 10.1 当前限制

1. 单体应用，扩展性有限
2. 缺少消息队列支持
3. 统计功能较基础

### 10.2 改进方向

1. **微服务化**
   - 按业务拆分服务
   - 引入服务注册中心
   - 实现服务熔断降级

2. **消息驱动**
   - 引入 RabbitMQ/Kafka
   - 实现异步事件处理
   - 解耦服务依赖

3. **大数据支持**
   - 引入 Elasticsearch
   - 实现海量数据检索
   - 支持复杂统计分析
