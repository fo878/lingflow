package com.lingflow.controller;

import com.lingflow.dto.Result;
import com.lingflow.service.ProcessStatisticsService;
import lombok.Data;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDate;
import java.util.List;
import java.util.Map;

/**
 * 流程统计控制器
 * 提供流程统计相关的API
 */
@RestController
@RequestMapping("/api/statistics")
public class ProcessStatisticsController {

    @Autowired
    private ProcessStatisticsService statisticsService;

    /**
     * 获取流程实例统计
     *
     * @param processDefinitionKey 流程定义Key（可选）
     * @return 统计信息
     */
    @GetMapping("/process-instance")
    public Result<ProcessInstanceStatisticsVO> getProcessInstanceStatistics(
            @RequestParam(value = "processDefinitionKey", required = false) String processDefinitionKey) {
        try {
            ProcessInstanceStatisticsVO statistics =
                statisticsService.getProcessInstanceStatistics(processDefinitionKey);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取任务统计
     *
     * @param processDefinitionKey 流程定义Key（可选）
     * @return 统计信息
     */
    @GetMapping("/task")
    public Result<TaskStatisticsVO> getTaskStatistics(
            @RequestParam(value = "processDefinitionKey", required = false) String processDefinitionKey) {
        try {
            TaskStatisticsVO statistics = statisticsService.getTaskStatistics(processDefinitionKey);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取流程定义统计
     *
     * @return 统计信息列表
     */
    @GetMapping("/process-definition")
    public Result<List<ProcessDefinitionStatisticsVO>> getProcessDefinitionStatistics() {
        try {
            List<ProcessDefinitionStatisticsVO> statistics =
                statisticsService.getProcessDefinitionStatistics();
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取每日流程统计
     *
     * @param startDate 开始日期
     * @param endDate   结束日期
     * @return 统计信息列表
     */
    @GetMapping("/daily")
    public Result<List<DailyStatisticsVO>> getDailyStatistics(
            @RequestParam("startDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate startDate,
            @RequestParam("endDate") @DateTimeFormat(iso = DateTimeFormat.ISO.DATE) LocalDate endDate) {
        try {
            List<DailyStatisticsVO> statistics =
                statisticsService.getDailyStatistics(startDate, endDate);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取用户任务统计
     *
     * @param userId 用户ID
     * @return 统计信息
     */
    @GetMapping("/user-task/{userId}")
    public Result<UserTaskStatisticsVO> getUserTaskStatistics(
            @PathVariable("userId") String userId) {
        try {
            UserTaskStatisticsVO statistics = statisticsService.getUserTaskStatistics(userId);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取流程平均完成时间
     *
     * @param processDefinitionKey 流程定义Key（可选）
     * @return 平均完成时间
     */
    @GetMapping("/average-completion-time")
    public Result<AverageCompletionTimeVO> getAverageCompletionTime(
            @RequestParam(value = "processDefinitionKey", required = false) String processDefinitionKey) {
        try {
            AverageCompletionTimeVO statistics =
                statisticsService.getAverageCompletionTime(processDefinitionKey);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取流程趋势统计
     *
     * @param days 统计天数
     * @return 趋势数据
     */
    @GetMapping("/trend/{days}")
    public Result<Map<String, Object>> getProcessTrend(
            @PathVariable("days") Integer days) {
        try {
            Map<String, Object> trend = statisticsService.getProcessTrend(days);
            return Result.success(trend);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    /**
     * 获取超时流程统计
     *
     * @param timeoutHours 超时小时数
     * @return 统计信息
     */
    @GetMapping("/timeout/{timeoutHours}")
    public Result<TimeoutStatisticsVO> getTimeoutStatistics(
            @PathVariable("timeoutHours") Long timeoutHours) {
        try {
            TimeoutStatisticsVO statistics = statisticsService.getTimeoutStatistics(timeoutHours);
            return Result.success(statistics);
        } catch (Exception e) {
            return Result.error(e.getMessage());
        }
    }

    // ==================== VO 类定义 ====================

    /**
     * 流程实例统计信息
     */
    @Data
    public static class ProcessInstanceStatisticsVO {
        /**
         * 流程定义Key
         */
        private String processDefinitionKey;

        /**
         * 流程定义名称
         */
        private String processDefinitionName;

        /**
         * 总实例数
         */
        private Long totalInstances;

        /**
         * 运行中的实例数
         */
        private Long runningInstances;

        /**
         * 已完成的实例数
         */
        private Long completedInstances;

        /**
         * 已挂起的实例数
         */
        private Long suspendedInstances;

        /**
         * 已终止的实例数
         */
        private Long terminatedInstances;

        /**
         * 完成率（百分比）
         */
        private Double completionRate;

        /**
         * 平均完成时间（毫秒）
         */
        private Long averageCompletionTime;

        /**
         * 格式化后的平均完成时间
         */
        private String formattedAverageTime;
    }

    /**
     * 任务统计信息
     */
    @Data
    public static class TaskStatisticsVO {
        /**
         * 流程定义Key
         */
        private String processDefinitionKey;

        /**
         * 总任务数
         */
        private Long totalTasks;

        /**
         * 待处理任务数
         */
        private Long pendingTasks;

        /**
         * 已完成任务数
         */
        private Long completedTasks;

        /**
         * 已逾期任务数
         */
        private Long overdueTasks;

        /**
         * 平均任务处理时间（毫秒）
         */
        private Long averageTaskTime;

        /**
         * 格式化后的平均任务处理时间
         */
        private String formattedAverageTime;
    }

    /**
     * 流程定义统计信息
     */
    @Data
    public static class ProcessDefinitionStatisticsVO {
        /**
         * 流程定义ID
         */
        private String processDefinitionId;

        /**
         * 流程定义Key
         */
        private String processDefinitionKey;

        /**
         * 流程定义名称
         */
        private String processDefinitionName;

        /**
         * 版本
         */
        private Integer version;

        /**
         * 运行中的实例数
         */
        private Long runningInstanceCount;

        /**
         * 已完成的实例数
         */
        private Long completedInstanceCount;

        /**
         * 总实例数
         */
        private Long totalInstanceCount;

        /**
         * 部署时间
         */
        private String deploymentTime;
    }

    /**
     * 每日统计信息
     */
    @Data
    public static class DailyStatisticsVO {
        /**
         * 日期
         */
        private String date;

        /**
         * 启动的流程数
         */
        private Long startedProcessCount;

        /**
         * 完成的流程数
         */
        private Long completedProcessCount;

        /**
         * 创建的任务数
         */
        private Long createdTaskCount;

        /**
         * 完成的任务数
         */
        private Long completedTaskCount;
    }

    /**
     * 用户任务统计信息
     */
    @Data
    public static class UserTaskStatisticsVO {
        /**
         * 用户ID
         */
        private String userId;

        /**
         * 待处理任务数
         */
        private Long pendingTaskCount;

        /**
         * 已完成任务数
         */
        private Long completedTaskCount;

        /**
         * 已逾期任务数
         */
        private Long overdueTaskCount;

        /**
         * 平均任务处理时间（毫秒）
         */
        private Long averageTaskTime;

        /**
         * 格式化后的平均任务处理时间
         */
        private String formattedAverageTime;
    }

    /**
     * 平均完成时间信息
     */
    @Data
    public static class AverageCompletionTimeVO {
        /**
         * 流程定义Key
         */
        private String processDefinitionKey;

        /**
         * 平均完成时间（毫秒）
         */
        private Long averageCompletionTime;

        /**
         * 格式化后的平均完成时间
         */
        private String formattedTime;

        /**
         * 最快完成时间（毫秒）
         */
        private Long fastestCompletionTime;

        /**
         * 最慢完成时间（毫秒）
         */
        private Long slowestCompletionTime;
    }

    /**
     * 超时统计信息
     */
    @Data
    public static class TimeoutStatisticsVO {
        /**
         * 超时小时数
         */
        private Long timeoutHours;

        /**
         * 超时流程实例数
         */
        private Long timeoutInstanceCount;

        /**
         * 超时流程实例ID列表
         */
        private List<String> timeoutInstanceIds;

        /**
         * 超时任务数
         */
        private Long timeoutTaskCount;

        /**
         * 超时任务ID列表
         */
        private List<String> timeoutTaskIds;
    }
}
