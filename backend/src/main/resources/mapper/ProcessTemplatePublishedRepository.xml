<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lingflow.repository.ProcessTemplatePublishedRepository">

    <resultMap id="ProcessTemplatePublishedResultMap" type="com.lingflow.entity.ProcessTemplatePublished">
        <id property="id" column="id"/>
        <result property="templateKey" column="template_key"/>
        <result property="templateName" column="template_name"/>
        <result property="description" column="description"/>
        <result property="bpmnXml" column="bpmn_xml"/>
        <result property="flowableProcessDefinitionId" column="flowable_process_definition_id"/>
        <result property="flowableDeploymentId" column="flowable_deployment_id"/>
        <result property="flowableVersion" column="flowable_version"/>
        <result property="categoryId" column="category_id"/>
        <result property="tags" column="tags"/>
        <result property="formConfig" column="form_config"/>
        <result property="appId" column="app_id"/>
        <result property="contextId" column="context_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="status" column="status"/>
        <result property="instanceCount" column="instance_count"/>
        <result property="runningInstanceCount" column="running_instance_count"/>
        <result property="publishedTime" column="published_time"/>
        <result property="suspendedTime" column="suspended_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="version" column="version"/>
    </resultMap>

    <!-- 根据ID查询发布态模板 -->
    <select id="findById" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.id = #{id}
    </select>

    <!-- 根据模板Key查询发布态模板（多租户，包含所有版本） -->
    <select id="findByTemplateKey" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.template_key = #{templateKey}
          AND ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
        ORDER BY ptp.flowable_version DESC
    </select>

    <!-- 根据模板Key查询激活态模板（多租户） -->
    <select id="findActiveByTemplateKey" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.template_key = #{templateKey}
          AND ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
          AND ptp.status = 'ACTIVE'
        LIMIT 1
    </select>

    <!-- 根据Flowable流程定义ID查询发布态模板 -->
    <select id="findByFlowableProcessDefinitionId" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.flowable_process_definition_id = #{flowableProcessDefinitionId}
    </select>

    <!-- 查询所有发布态模板（多租户） -->
    <select id="findAll" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
        ORDER BY ptp.published_time DESC
    </select>

    <!-- 根据分类ID查询发布态模板列表（多租户） -->
    <select id="findByCategoryId" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.category_id = #{categoryId}
          AND ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
        ORDER BY ptp.published_time DESC
    </select>

    <!-- 根据状态查询发布态模板列表（多租户） -->
    <select id="findByStatus" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.status = #{status}
          AND ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
        ORDER BY ptp.published_time DESC
    </select>

    <!-- 根据名称或描述搜索发布态模板（模糊搜索，多租户） -->
    <select id="searchByKeyword" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
          AND (ptp.template_name LIKE CONCAT('%', #{keyword}, '%')
               OR ptp.description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY ptp.published_time DESC
    </select>

    <!-- 根据标签搜索发布态模板（多租户） -->
    <select id="searchByTag" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
          AND ptp.tags::text LIKE CONCAT('%', #{tag}, '%')
        ORDER BY ptp.published_time DESC
    </select>

    <!-- 分页查询发布态模板（多租户） -->
    <select id="findByPage" resultMap="ProcessTemplatePublishedResultMap">
        SELECT ptp.*,
               pc.name AS category_name,
               pc.code AS category_code
        FROM process_template_published ptp
        LEFT JOIN process_category pc ON ptp.category_id = pc.id
        WHERE ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
          <if test="categoryId != null and categoryId != ''">
              AND ptp.category_id = #{categoryId}
          </if>
          <if test="status != null">
              AND ptp.status = #{status}
          </if>
          <if test="keyword != null and keyword != ''">
              AND (ptp.template_name LIKE CONCAT('%', #{keyword}, '%')
                   OR ptp.description LIKE CONCAT('%', #{keyword}, '%'))
          </if>
        ORDER BY ptp.published_time DESC
        <if test="offset != null and limit != null">
            OFFSET #{offset} LIMIT #{limit}
        </if>
    </select>

    <!-- 统计发布态模板数量（多租户） -->
    <select id="countByCondition" resultType="int">
        SELECT COUNT(*)
        FROM process_template_published ptp
        WHERE ptp.tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR ptp.app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR ptp.context_id = #{contextId,jdbcType=VARCHAR})
          <if test="categoryId != null and categoryId != ''">
              AND ptp.category_id = #{categoryId}
          </if>
          <if test="status != null">
              AND ptp.status = #{status}
          </if>
          <if test="keyword != null and keyword != ''">
              AND (ptp.template_name LIKE CONCAT('%', #{keyword}, '%')
                   OR ptp.description LIKE CONCAT('%', #{keyword}, '%'))
          </if>
    </select>

    <!-- 保存发布态模板 -->
    <insert id="save" parameterType="com.lingflow.entity.ProcessTemplatePublished">
        INSERT INTO process_template_published (
            id, template_key, template_name, description, bpmn_xml,
            flowable_process_definition_id, flowable_deployment_id, flowable_version,
            category_id, tags, form_config,
            app_id, context_id, tenant_id, status,
            instance_count, running_instance_count,
            published_time, suspended_time, created_by, version
        ) VALUES (
            #{id}, #{templateKey}, #{templateName}, #{description}, #{bpmnXml},
            #{flowableProcessDefinitionId}, #{flowableDeploymentId}, #{flowableVersion},
            #{categoryId}, #{tags}::jsonb, #{formConfig}::jsonb,
            #{appId}, #{contextId}, #{tenantId}, #{status},
            #{instanceCount}, #{runningInstanceCount},
            #{publishedTime}, #{suspendedTime}, #{createdBy}, #{version}
        )
    </insert>

    <!-- 更新发布态模板 -->
    <update id="update" parameterType="com.lingflow.entity.ProcessTemplatePublished">
        UPDATE process_template_published
        SET template_name = #{templateName},
            description = #{description},
            bpmn_xml = #{bpmnXml},
            category_id = #{categoryId},
            tags = #{tags}::jsonb,
            form_config = #{formConfig}::jsonb,
            version = version + 1
        WHERE id = #{id}
          AND version = #{version}
    </update>

    <!-- 更新状态 -->
    <update id="updateStatus">
        UPDATE process_template_published
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 更新停用时间 -->
    <update id="updateSuspendedTime">
        UPDATE process_template_published
        SET suspended_time = #{suspendedTime}
        WHERE id = #{id}
    </update>

    <!-- 更新流程实例计数 -->
    <update id="updateInstanceCount">
        UPDATE process_template_published
        SET instance_count = instance_count + #{increment}
        WHERE id = #{id}
    </update>

    <!-- 更新运行中的流程实例计数 -->
    <update id="updateRunningInstanceCount">
        UPDATE process_template_published
        SET running_instance_count = running_instance_count + #{increment}
        WHERE id = #{id}
    </update>

    <!-- 检查是否存在激活的模板 -->
    <select id="countActiveByTemplateKey" resultType="int">
        SELECT COUNT(*) FROM process_template_published
        WHERE template_key = #{templateKey}
          AND tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR context_id = #{contextId,jdbcType=VARCHAR})
          AND status = 'ACTIVE'
    </select>

    <!-- 获取下一个模板版本号 -->
    <select id="getNextTemplateVersion" resultType="int">
        SELECT COALESCE(MAX(flowable_version), 0) + 1
        FROM process_template_published
        WHERE template_key = #{templateKey}
          AND tenant_id = #{tenantId}
          AND (#{appId,jdbcType=VARCHAR} IS NULL OR app_id = #{appId,jdbcType=VARCHAR})
          AND (#{contextId,jdbcType=VARCHAR} IS NULL OR context_id = #{contextId,jdbcType=VARCHAR})
    </select>

</mapper>
