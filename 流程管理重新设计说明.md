# 流程管理重新设计说明

## 一、设计概述

重新设计了流程定义的保存、发布、激活和停用机制，提供了完整的状态管理功能。

## 二、流程状态

流程定义有三种状态：

1. **草稿 (draft)** - 流程设计阶段，不会影响已发布的版本
2. **已发布 (active)** - 流程激活状态，可以启动新的流程实例
3. **已停用 (suspended)** - 流程停用状态，无法启动新的流程实例，但已有实例可继续执行

## 三、前端改动

### 3.1 API 接口 (process.ts)

新增/修改的接口：

```typescript
// 保存流程定义（草稿）
saveProcessDefinition(data: {
  id?: string
  name: string
  key?: string
  description?: string
  xml: string
  categoryId?: string
  tenantId?: string
  appId?: string
  contextId?: string
})

// 激活流程定义
activateProcessDefinition(processDefinitionId: string)

// 停用流程定义
suspendProcessDefinition(processDefinitionId: string)

// 更新流程定义属性
updateProcessDefinition(data: {
  id: string
  name?: string
  key?: string
  description?: string
  categoryId?: string
})
```

### 3.2 UI 改动 (Designer.vue)

**头部操作按钮：**

1. **状态标签** - 显示当前流程状态（草稿/已发布/已停用）
2. **保存按钮** - 保存流程定义（草稿），绿色按钮
3. **快照按钮** - 管理流程快照
4. **导出按钮** - 导出 BPMN XML
5. **发布/激活按钮** - 将流程发布为激活状态
6. **停用按钮** - 停用已发布的流程（仅在已发布状态显示）

**按钮逻辑：**
- 草稿状态：显示"保存"和"发布流程"按钮
- 已发布状态：显示"保存"和"停用流程"按钮
- 已停用状态：显示"保存"和"重新激活"按钮

### 3.3 核心函数

```typescript
// 保存流程（草稿）
const saveProcess = async () => {
  // 1. 验证流程名称
  // 2. 获取 BPMN XML
  // 3. 调用 saveProcessDefinition API
  // 4. 保存返回的流程定义ID
  // 5. 显示成功消息
}

// 发布/激活流程
const publishProcess = async () => {
  // 1. 如果是草稿状态，先保存
  // 2. 验证流程定义ID
  // 3. 调用 activateProcessDefinition API
  // 4. 更新状态为 active
  // 5. 显示成功消息
}

// 停用流程
const suspendProcess = async () => {
  // 1. 确认对话框
  // 2. 调用 suspendProcessDefinition API
  // 3. 更新状态为 suspended
  // 4. 显示成功消息
}
```

## 四、后端改动

### 4.1 Controller (ProcessDefinitionController.java)

新增的 REST API：

```java
POST   /api/process/definition              - 保存流程定义（草稿）
PUT    /api/process/definition              - 更新流程定义属性
POST   /api/process/definition/{id}/activate - 激活流程定义
POST   /api/process/definition/{id}/suspend - 停用流程定义
```

### 4.2 DTO (ProcessDefinitionDTO.java)

流程定义数据传输对象，包含：
- id: 流程定义ID（更新时）
- name: 流程名称
- key: 流程Key
- description: 流程描述
- xml: BPMN XML内容
- categoryId: 分类ID
- tenantId: 租户ID
- appId: 应用ID
- contextId: 上下文ID

### 4.3 Service (ProcessService.java)

新增的方法：

```java
// 保存流程定义（草稿）
public Map<String, Object> saveProcessDefinition(ProcessDefinitionDTO dto)

// 更新流程定义属性
public void updateProcessDefinition(ProcessDefinitionDTO dto)

// 激活流程定义
public void activateProcessDefinition(String processDefinitionId)

// 停用流程定义
public void suspendProcessDefinition(String processDefinitionId)
```

## 五、工作流程

### 5.1 创建新流程

1. 用户在流程设计器中设计流程
2. 填写流程名称、Key、描述、选择分类
3. 点击"保存"按钮 → 流程保存为草稿状态
4. 点击"发布流程"按钮 → 流程激活，可以启动实例

### 5.2 编辑现有流程

1. 用户打开已保存的流程
2. 修改流程设计或属性
3. 点击"保存"按钮 → 更新流程定义
4. 点击"发布流程"按钮 → 重新激活流程

### 5.3 停用流程

1. 在已发布状态下，点击"停用流程"按钮
2. 确认对话框提示
3. 流程停用，无法启动新实例
4. 可点击"重新激活"恢复

## 六、功能特点

1. **分离保存和发布** - 保存为草稿不会影响生产环境
2. **状态管理** - 清晰的状态转换（草稿 → 已发布 → 已停用）
3. **分类管理** - 流程可以关联到分类树
4. **多租户支持** - 支持租户、应用、上下文隔离
5. **权限控制** - 不同状态下对属性的编辑权限不同
6. **友好提示** - 确认对话框和状态标签

## 七、待完善功能

1. **分类关联保存** - 标记了 TODO，需要实现流程与分类的持久化关联
2. **版本管理** - 可以添加版本历史功能
3. **权限验证** - 添加用户权限验证
4. **批量操作** - 批量激活/停用流程

## 八、测试建议

1. 创建新流程并保存为草稿
2. 从草稿状态发布流程
3. 停用已发布的流程
4. 重新激活已停用的流程
5. 编辑流程属性并保存
6. 验证分类关联功能

## 九、注意事项

1. 草稿状态的流程定义仍然会部署到 Flowable，但是暂停状态
2. 停用流程不会影响正在运行的流程实例
3. 流程定义ID在首次保存后生成，后续更新使用相同ID
4. 分类ID需要通过 setProcessCategory API 单独设置
