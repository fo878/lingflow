# 流程属性保存和分类关联完善说明

## 一、问题分析

### 原问题：
1. ❌ 流程名称和 key 没有实际更新成功
2. ❌ 分类关联没有持久化到数据库
3. ❌ TODO 标记未实现

### 根本原因：
1. **Flowable 限制**：流程定义的 name 和 key 是从 BPMN XML 的 `<bpmn:process>` 元素中解析的，不能直接修改
2. **缺少分类保存逻辑**：分类关联没有保存到 `process_definition_extension` 表

## 二、解决方案

### 1. 更新 BPMN XML 中的流程属性

**实现方法：** `updateBpmnXmlProcessAttributes()`

```java
private String updateBpmnXmlProcessAttributes(String bpmnXml, String processKey, String processName) {
    // 使用正则表达式替换 <bpmn:process> 元素的 id 和 name 属性
    String updatedXml = bpmnXml.replaceAll(
        "<bpmn:process[^>]*id=\"[^\"]*\"",
        "<bpmn:process id=\"" + processKey + "\""
    );
    updatedXml = updatedXml.replaceAll(
        "<bpmn:process[^>]*name=\"[^\"]*\"",
        "<bpmn:process name=\"" + processName + "\""
    );
    return updatedXml;
}
```

**工作原理：**
- 解析 BPMN XML 字符串
- 使用正则表达式找到 `<bpmn:process>` 标签
- 替换 `id` 属性为流程 key
- 替换 `name` 属性为流程名称

### 2. 保存或更新分类关联

**实现方法：** `saveOrUpdateProcessDefinitionExtension()`

```java
private void saveOrUpdateProcessDefinitionExtension(
    String processDefinitionId,
    String categoryId,
    String tenantId,
    String appId,
    String contextId
) {
    // 查询是否已存在扩展记录
    ProcessDefinitionExtension existing =
        processDefinitionExtensionRepository.findByProcessDefinitionId(processDefinitionId);

    if (existing != null) {
        // 更新现有记录
        existing.setCategoryId(categoryId);
        existing.setTenantId(tenantId);
        existing.setAppId(appId);
        existing.setContextId(contextId);
        existing.setUpdatedTime(LocalDateTime.now());
        processDefinitionExtensionRepository.update(existing);
    } else {
        // 创建新记录
        ProcessDefinitionExtension extension = ProcessDefinitionExtension.builder()
            .processDefinitionId(processDefinitionId)
            .categoryId(categoryId)
            .tenantId(tenantId)
            .appId(appId)
            .contextId(contextId)
            .createdTime(LocalDateTime.now())
            .updatedTime(LocalDateTime.now())
            .build();
        processDefinitionExtensionRepository.save(extension);
    }
}
```

**功能：**
- 检查数据库中是否已存在扩展记录
- 存在则更新分类关联
- 不存在则创建新记录

## 三、完整工作流程

### 创建新流程（保存为草稿）

```java
1. 用户填写：name="请假流程", key="leave_process", categoryId="cat001"
2. 调用 saveProcessDefinition()
3. 系统处理：
   a. 更新 BPMN XML 中的 id="leave_process" 和 name="请假流程"
   b. 部署更新后的 XML
   c. 暂停流程定义（草稿状态）
   d. 保存分类关联到 process_definition_extension 表
4. 返回：流程定义ID、部署ID、key、版本号
```

### 更新现有流程

```java
1. 用户修改：name="请假流程v2", key="leave_process_v2", categoryId="cat002"
2. 调用 saveProcessDefinition(id="existing_id")
3. 系统处理：
   a. 更新 BPMN XML 中的 id 和 name
   b. 重新部署 XML（创建新版本）
   c. 暂停新版本（保持草稿状态）
   d. 更新分类关联
4. 返回：新的流程定义ID、新的部署ID、新的版本号
```

### 只更新分类（不修改流程）

```java
1. 用户只修改：categoryId="cat003"
2. 调用 updateProcessDefinition()
3. 系统处理：
   a. 验证流程定义是否存在
   b. 更新 process_definition_extension 表中的分类ID
4. 返回：成功
```

## 四、数据库表结构

### process_definition_extension 表

```sql
CREATE TABLE process_definition_extension (
    id VARCHAR(36) PRIMARY KEY,
    process_definition_id VARCHAR(64) NOT NULL,  -- 关联 Flowable 流程定义ID
    category_id VARCHAR(36),                      -- 分类ID
    tenant_id VARCHAR(64),                        -- 租户ID
    app_id VARCHAR(64),                           -- 应用ID
    context_id VARCHAR(64),                       -- 上下文ID
    created_time TIMESTAMP,
    updated_time TIMESTAMP
);
```

**关系：**
- `process_definition_id` → Flowable 的 `ACT_RE_PROCDEF` 表
- `category_id` → `process_category` 表

## 五、前端集成

### 保存流程时传递的数据

```typescript
await saveProcessDefinition({
  id: processDefinitionId.value,     // 编辑时需要
  name: processName.value,            // 流程名称
  key: processKey.value,              // 流程Key
  description: processDescription.value,
  xml: xml,                           // BPMN XML
  categoryId: selectedCategoryId.value,  // 分类ID
  tenantId: currentTenantId.value,
  appId: currentAppId.value,
  contextId: currentContextId.value
})
```

### 返回的数据结构

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "processDefinitionId",
    "deploymentId": "deploymentId",
    "key": "leave_process",
    "version": 1,
    "message": "流程定义已保存为草稿"
  }
}
```

## 六、关键改进点

### ✅ 已解决的问题

1. **流程名称保存**
   - 通过更新 BPMN XML 实现
   - 每次保存创建新版本
   - 名称会正确显示在流程列表中

2. **流程 Key 保存**
   - 通过更新 BPMN XML 的 id 属性实现
   - 用于唯一标识流程
   - 用于启动流程实例

3. **分类关联**
   - 保存到 `process_definition_extension` 表
   - 支持修改分类
   - 多租户隔离

4. **版本管理**
   - 每次更新创建新版本
   - 旧版本保留（历史记录）
   - 版本号自动递增

## 七、注意事项

### 1. 版本控制
- 每次更新流程会创建新版本
- Flowable 会保留所有历史版本
- 版本号自动递增（1, 2, 3...）

### 2. 草稿状态
- 新保存的流程默认为暂停状态（草稿）
- 不会影响已发布的流程
- 需要手动激活才能使用

### 3. 分类查询
- 可以通过分类查询流程
- 支持多级分类树
- 支持分类统计

### 4. 多租户
- 所有操作都带租户ID
- 数据隔离
- 支持应用和上下文级别隔离

## 八、测试建议

### 测试场景

1. **创建新流程**
   - 设置名称、key、分类
   - 保存为草稿
   - 验证数据库记录

2. **更新流程属性**
   - 修改名称和key
   - 保存
   - 验证新版本创建

3. **修改分类**
   - 只修改分类
   - 保存
   - 验证分类更新

4. **发布流程**
   - 从草稿发布
   - 验证状态变更

5. **查询流程**
   - 按分类查询
   - 验证分类关联

## 九、后续优化建议

1. **描述字段持久化**
   - 当前描述只在 BPMN XML 中
   - 可以考虑在扩展表中添加 description 字段

2. **标签功能**
   - 扩展表已有 tags 字段
   - 可以实现流程标签功能

3. **批量操作**
   - 批量修改分类
   - 批量发布/停用

4. **权限控制**
   - 添加创建权限
   - 添加编辑权限
   - 添加删除权限

## 十、代码文件清单

### 修改的文件：
1. `ProcessDefinitionService.java` - 核心业务逻辑
   - `saveProcessDefinition()` - 完善保存逻辑
   - `updateProcessDefinition()` - 完善更新逻辑
   - `updateBpmnXmlProcessAttributes()` - 新增：更新XML
   - `saveOrUpdateProcessDefinitionExtension()` - 新增：保存分类

2. `ProcessDefinitionController.java` - REST API
   - POST `/api/process/definition` - 保存流程
   - PUT `/api/process/definition` - 更新流程

3. `process.ts` - 前端API
   - `saveProcessDefinition()` - 保存接口
   - `updateProcessDefinition()` - 更新接口

4. `Designer.vue` - 前端UI
   - 保存按钮
   - 属性表单绑定

### 使用的表：
- `process_definition_extension` - 流程定义扩展表
- `ACT_RE_PROCDEF` - Flowable 流程定义表（引擎管理）
- `ACT_RE_DEPLOYMENT` - Flowable 部署表（引擎管理）
